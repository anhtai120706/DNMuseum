<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>B·∫£o t√†ng ƒê√† N·∫µng ‚Äì ·ª®ng d·ª•ng Th√¥ng minh</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<!-- Th√™m th∆∞ vi·ªán Model Viewer ƒë·ªÉ xem 3D -->
<script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
<!-- Th√™m th∆∞ vi·ªán jsQR ƒë·ªÉ qu√©t m√£ QR -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.1.0/dist/jsQR.min.js"></script>
<style>
/* --- 1. BI·∫æN V√Ä THI·∫æT L·∫¨P CHUNG (M√ÄU M·ªöI: XANH L√Å C√ÇY & V√ÄNG) --- */
:root {
  --primary-color: #2ecc71; /* Fresh Green */
  --primary-dark: #27ae60; /* Darker Green */
  --accent-color: #f39c12; /* Sun Yellow/Orange */
  --bg-light: #f5fcf5; /* Very light green background */
  --bg-card: #ffffff;
  --text-dark: #2c3e50; 
  --nav-active-bg: #eafaea; /* Lightest green for active nav */
}

body {
  background: var(--bg-light);
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  margin: 0;
  font-family: 'Poppins', sans-serif;
}

.phone {
  position: relative;
  width: 390px;
  height: 780px;
  border: 8px solid var(--text-dark);
  border-radius: 48px;
  background: #000;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.screen {
  background: var(--bg-light);
  width: 100%;
  height: 100%;
  border-radius: 40px; 
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  padding: 10px;
  box-sizing: border-box;
  color: var(--text-dark);
  transition: all 0.4s ease-in-out;
  overflow: hidden;
  position: relative;
}

.login-screen { justify-content: center; }
.hidden { display: none; }

h2 { font-size: 24px; font-weight: 700; margin-bottom: 12px; color: var(--primary-dark); }
h3 { 
  font-size: 20px; 
  font-weight: 600; 
  margin: 15px 0 10px; 
  color: var(--primary-dark); 
  border-bottom: 3px solid var(--accent-color); 
  padding-bottom: 8px;
  width: 95%;
  text-align: center;
}
h4 { font-size: 16px; font-weight: 600; margin-bottom: 8px; color: var(--primary-dark); }
p { font-size: 14px; color: #555; margin-bottom: 5px; text-align: justify; line-height: 1.4; }
ul { padding-left: 20px; text-align: left; }

/* --- 2. N√öT V√Ä INPUT --- */
button {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
  color: white;
  border: none;
  border-radius: 14px;
  padding: 14px 25px;
  margin: 8px 0;
  font-size: 16px;
  cursor: pointer;
  transition: 0.3s ease;
  font-weight: 600;
  box-shadow: 0 6px 20px rgba(46, 204, 113, 0.3); /* Shadow m·ªõi */
}
button:hover { transform: translateY(-2px) scale(1.01); box-shadow: 0 8px 25px rgba(46, 204, 113, 0.4); }
button:active { transform: translateY(0); box-shadow: 0 4px 15px rgba(46, 204, 113, 0.2); }

input[type="text"], select {
  padding: 12px;
  border-radius: 12px;
  border: 1px solid #ccc;
  width: 95%;
  margin-bottom: 15px; 
  font-size: 15px;
  outline: none;
  transition: all 0.3s;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
}
input[type="text"]:focus, select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.2); }

/* --- 3. THANH ƒêI·ªÄU H∆Ø·ªöNG --- */
.bottom-nav {
  display: flex;
  justify-content: space-around;
  align-items: center;
  background: var(--bg-card);
  padding: 10px 0;
  border-radius: 0 0 40px 40px; 
  width: 100%;
  box-shadow: 0 -5px 20px rgba(0,0,0,0.1); 
  border-top: 1px solid #eee;
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 11px;
  font-weight: 500;
  color: #7f8c8d;
  transition: all 0.3s;
  padding: 8px 10px;
  border-radius: 100px;
  min-width: 60px;
}
.nav-item span { font-size: 28px; margin-bottom: 2px; }
.nav-item.active { 
  color: var(--primary-dark);
  font-weight: 600;
  background-color: var(--nav-active-bg);
  box-shadow: 0 2px 10px rgba(46, 204, 113, 0.2);
  transform: translateY(-2px);
}
.nav-item.active span { color: var(--primary-dark); transform: scale(1.05); }

/* --- 4. N·ªòI DUNG CH√çNH --- */
.tab-content {
  flex: 1;
  width: 100%;
  overflow-y: auto;
  display: none;
  flex-direction: column;
  align-items: center;
  padding: 5px;
  box-sizing: border-box;
}
.active-tab { display: flex; animation: fadeInUp 0.5s ease-out; }

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.info-card { 
  background: var(--bg-card);
  border-radius: 16px;
  padding: 15px;
  width: 95%;
  margin-bottom: 15px;
  text-align: left;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  border-left: 5px solid var(--accent-color);
  transition: transform 0.3s;
}
.achievement-card {
    background: #eafaea; 
    border-left: 5px solid var(--primary-dark);
    text-align: center;
    padding: 15px;
}
.achievement-card h4 {
    margin-top: 0;
    color: var(--primary-dark);
}
.achievement-card p {
    text-align: center;
    color: var(--text-dark);
}
.quiz-question {
    background: var(--bg-card);
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.quiz-option {
    display: block;
    width: 100%;
    text-align: left;
    background: #f7f7f7;
    color: var(--text-dark);
    border: 1px solid #ddd;
    padding: 10px;
    margin: 5px 0;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
    font-size: 14px;
}
.quiz-option:hover { background: #eee; }
.correct-answer { background: #c8e6c9 !important; border-color: #388e3c !important; color: #1b5e20 !important; font-weight: 600; }
.incorrect-answer { background: #ffcdd2 !important; border-color: #d32f2f !important; color: #b71c1c !important; }


.login-card {
  background: var(--bg-card);
  border-radius: 25px;
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15); 
  padding: 30px 25px;
  width: 85%;
  max-width: 350px;
  text-align: center;
}

/* --- 5. CHATBOT --- */
.chat-window {
  background: var(--bg-light); 
  border: 1px solid #eee;
}
.chat-message { 
  font-size: 14px; 
  margin-bottom: 10px; 
  padding: 10px 14px; 
  border-radius: 18px; 
  display: inline-block; 
  max-width: 85%;
  transition: all 0.3s;
}
.user-msg { 
    background: var(--primary-color); 
    color: #fff; 
    float: right; 
    border-radius: 18px 18px 0 18px; 
    box-shadow: 0 2px 8px rgba(46, 204, 113, 0.3);
}
.ai-msg { 
    background: #e3f2fd; 
    color: var(--text-dark); 
    float: left; 
    border-radius: 18px 18px 18px 0; 
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}
.chat-window::after { content: ""; display: table; clear: both; }

#loader {
    /* ƒê√£ lo·∫°i b·ªè, kh√¥ng c·∫ßn loading v√¨ kh√¥ng g·ªçi API */
    display: none; 
    border: 4px solid #f3f3f3; 
    border-top: 4px solid var(--primary-color); 
    border-radius: 50%;
    width: 20px; height: 20px;
    animation: spin 1s linear infinite;
    margin: 5px;
    float: left;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* --- Quick Question Buttons --- */
#quick-questions {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
    width: 95%;
    margin-bottom: 10px;
}
.quick-q-btn {
    background: #ffffff;
    color: var(--primary-dark);
    border: 1px solid var(--primary-color);
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 12px;
    cursor: pointer;
    transition: 0.3s;
    flex-grow: 1;
    min-width: 100px;
    max-width: 48%;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.quick-q-btn:hover {
    background: var(--primary-color);
    color: white;
    box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);
}

/* --- 6. QR SCANNER & VIDEO PLAYER & 3D --- */
#camera-preview {
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
    border-radius: 12px;
}
#camera-wrapper {
    width: 90%; 
    height: 240px; 
    margin-top: 15px; 
    position: relative;
}
#camera-canvas {
    position: absolute; top: 0; left: 0; z-index: 5;
    display: none; /* D√πng ƒë·ªÉ hi·ªÉn th·ªã k·∫øt qu·∫£ qu√©t */
}

.scanner-frame {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 70%; height: 70%; border: 3px solid var(--accent-color);
    box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.6); pointer-events: none; z-index: 10;
}
.scanner-line {
    position: absolute; left: 0; width: 100%; height: 4px;
    background: #ff4081; box-shadow: 0 0 15px #ff4081;
    animation: scan 2s infinite linear;
}
@keyframes scan { 0% { top: 0%; } 50% { top: 100%; } 100% { top: 0%; } }

#qr-result { border-left: 5px solid var(--primary-color); background: var(--nav-active-bg); }

/* Video Player Style */
#video-container {
    width: 100%;
    margin-top: 10px;
    display: none; 
    background: black;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
#artifact-video {
    width: 100%;
    display: block;
}

/* 3D Viewer Container */
#artifact-360-display {
    width: 100%; 
    height: 300px; 
    background: #f0f0f0; 
    margin-top: 10px; 
    display: none; 
    border-radius: 12px; 
    position: relative;
    overflow: hidden;
    border: 1px solid #ccc;
}

/* --- 7. MAP UI --- */
#map-container { 
    position: relative; width: 95%; height: 350px; border-radius: 12px; overflow: hidden; margin-bottom: 15px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.15); background-color: #ecf0f1; background-size: cover; background-position: center; border: 1px solid #ddd;
}
.map-marker { 
    position: absolute; font-size: 24px; cursor: pointer;
    transition: transform 0.3s, opacity 0.3s; filter: drop-shadow(1px 1px 3px rgba(0,0,0,0.4));
}
.map-marker:hover { transform: scale(1.2); z-index: 20; }
.marker-current { color: #3498db; animation: pulse-dot 1.5s infinite ease-out; font-size: 30px; }
@keyframes pulse-dot { 0% { transform: scale(0.8); opacity: 0.9; } 50% { transform: scale(1.1); opacity: 0.6; } 100% { transform: scale(0.8); opacity: 0.9; } }
.marker-toilet { color: #e74c3c; } /* ƒê·ªïi m√†u WC */
.marker-display { color: var(--accent-color); } /* ƒê·ªïi m√†u Display */
.marker-info { color: var(--primary-dark); } /* ƒê·ªïi m√†u Info */ 

.marker-selected {
    box-shadow: 0 0 0 5px rgba(243, 156, 18, 0.5); 
    border-radius: 50%;
}

#path-line {
    position: absolute; width: 5px; background: linear-gradient(to bottom, var(--primary-dark), #3498db);
    box-shadow: 0 0 15px rgba(46, 204, 113, 0.7); border-radius: 3px; z-index: 10; pointer-events: none; display: none;
}
.path-active { animation: path-glow 0.8s infinite alternate; }
@keyframes path-glow { from { opacity: 0.8; } to { opacity: 1; } }

.map-filters {
    display: flex; justify-content: space-around; align-items: center; width: 95%;
    background: var(--bg-card); padding: 10px 0; border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid #eee;
}
.filter-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; opacity: 0.6; font-size: 12px; }
.filter-item.active { opacity: 1; font-weight: 600; transform: scale(1.05); }
.filter-item span { font-size: 20px; }

/* Lang */
#lang-icon { position: absolute; top: 35px; right: 35px; z-index: 100; cursor: pointer; background: white; padding: 6px 12px; border-radius: 20px; box-shadow: 0 3px 10px rgba(0,0,0,0.15); font-weight: 600; display: flex; align-items: center; }
#lang-options { position: absolute; top: 70px; right: 35px; display: none; flex-direction: column; z-index: 101; background: white; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.3); padding: 5px; min-width: 150px; }
#lang-options button { margin: 0; padding: 8px 10px; width: 100%; text-align: left; background: none; color: #333; font-size: 14px; box-shadow: none; border-radius: 8px; }
#lang-options button:hover { background: var(--nav-active-bg); color: var(--primary-dark); }
</style>
</head>
<body>
<div class="phone">

  <!-- Language control -->
  <div id="lang-icon" onclick="toggleLangOptions()">
      <span id="lang-display">üåê VI</span>
  </div>
  <div id="lang-options">
    <button onclick="selectLang('vi')">Ti·∫øng Vi·ªát (VI)</button>
    <button onclick="selectLang('en')">English (EN)</button>
  </div>

  <!-- WIFI Screen -->
  <div class="screen login-screen" id="wifi-screen">
    <div class="login-card">
      <h2>üì∂ K·∫øt n·ªëi Wi-Fi</h2>
      <p>Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi ·ª©ng d·ª•ng tham quan th√¥ng minh!</p>
      <button onclick="goToLogin()">K·∫øt n·ªëi Wi-Fi</button>
    </div>
  </div>

  <!-- LOGIN Screen -->
  <div class="screen hidden login-screen" id="login-screen">
    <div class="login-card">
      <h2>üéüÔ∏è ƒêƒÉng nh·∫≠p</h2>
      <p>Nh·∫≠p m√£ v√© ho·∫∑c qu√©t QR ƒë·ªÉ v√†o ·ª©ng d·ª•ng.</p>
      <input type="text" id="ticket-input" placeholder="Nh·∫≠p m√£ v√©...">
      <button onclick="goToMain()">ƒêƒÉng nh·∫≠p</button>
      <button onclick="goToMain()" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); box-shadow: 0 6px 20px rgba(243, 156, 18, 0.3);">üì∑ Qu√©t m√£ QR</button>
    </div>
  </div>

  <!-- MAIN SCREEN -->
  <div class="screen hidden" id="main-screen">
    <input type="text" id="search-input" placeholder="üîç T√¨m khu tr∆∞ng b√†y, hi·ªán v·∫≠t..." style="width:95%; margin:5px 0 10px; padding:10px; border-radius:12px; border:1px solid #ccc;">

    <!-- Intro Tab -->
    <div class="tab-content active-tab" id="intro-tab">
      <h3>üèõÔ∏è Th√¥ng tin Chung</h3>
      <div class="info-card">
        <h4>1. Gi·ªù m·ªü c·ª≠a & Gi√° v√©</h4>
        <p>M·ªü c·ª≠a: 7:30 - 17:00 h√†ng ng√†y.</p>
        <p>Gi√° v√©: 40.000ƒë (Ng∆∞·ªùi l·ªõn), 20.000ƒë (Sinh vi√™n).</p>
      </div>
      <div class="info-card">
        <h4>2. S∆° ƒë·ªì tham quan</h4>
        <p>T·∫ßng 1: Ti·ªÅn s·ª≠ & C·ªï v·∫≠t.</p>
        <p>T·∫ßng 2: L·ªãch s·ª≠ chi·∫øn tranh.</p>
        <p>T·∫ßng 3: VƒÉn h√≥a & D√¢n t·ªôc h·ªçc.</p>
      </div>
    </div>

    <!-- Chatbot Tab (AI MOCKUP - KH√îNG D√ôNG API) -->
    <div class="tab-content" id="chat-tab">
      <h3>üí¨ Chatbot AI (M√¥ ph·ªèng)</h3>
      <div id="kb-status" style="font-size: 11px; color: var(--primary-dark); margin-bottom: 5px;">‚úÖ ƒêang ·ªü ch·∫ø ƒë·ªô m√¥ ph·ªèng tr·∫£ l·ªùi t·ª©c th√¨ (Instant Mock Response).</div>
      
      <!-- Khu v·ª±c c√¢u h·ªèi m·∫´u -->
      <div id="quick-questions">
        <button class="quick-q-btn" onclick="prefillAndSend('Ti·ªÉu s·ª≠ Tr·∫ßn H∆∞ng ƒê·∫°o?')">Ti·ªÉu s·ª≠ Tr·∫ßn H∆∞ng ƒê·∫°o?</button>
        <button class="quick-q-btn" onclick="prefillAndSend('T√°c ph·∫©m n·ªïi ti·∫øng nh·∫•t c·ªßa Tr·∫ßn H∆∞ng ƒê·∫°o?')">T√°c ph·∫©m n·ªïi ti·∫øng nh·∫•t c·ªßa √¥ng?</button>
        <button class="quick-q-btn" onclick="prefillAndSend('Tr·∫≠n chi·∫øn B·∫°ch ƒê·∫±ng di·ªÖn ra khi n√†o?')">Tr·∫≠n chi·∫øn B·∫°ch ƒê·∫±ng di·ªÖn ra khi n√†o?</button>
        <button class="quick-q-btn" onclick="prefillAndSend('√ù nghƒ©a c√¢u n√≥i "B·ªá h·∫° ch√©m ƒë·∫ßu th·∫ßn r·ªìi h√£y h√†ng"?')">√ù nghƒ©a c√¢u n√≥i n·ªïi ti·∫øng c·ªßa √¥ng?</button>
      </div>

      <div class="chat-window" id="chat-window" style="flex-grow: 1; width: 95%; max-height: 440px; overflow-y: auto; padding: 10px; margin-bottom: 5px; border-radius: 12px; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); text-align: left;">
        <div class='chat-message ai-msg'>ü§ñ Xin ch√†o! T√¥i ƒëang ·ªü ch·∫ø ƒë·ªô **m√¥ ph·ªèng**. H√£y th·ª≠ c√°c c√¢u h·ªèi m·∫´u v·ªÅ Tr·∫ßn H∆∞ng ƒê·∫°o ·ªü tr√™n ƒë·ªÉ xem ph·∫£n h·ªìi ƒë∆∞·ª£c l·∫≠p tr√¨nh s·∫µn!</div>
      </div>
      
      <div id="loader" style="display:none; margin-top: 10px;"></div>
      <input type="text" id="chat-input" placeholder="H·ªèi t√¥i b·∫•t c·ª© ƒëi·ªÅu g√¨..." onkeydown="if(event.key==='Enter'){sendMessage();}">
      <button id="send-btn" onclick="sendMessage()">G·ª≠i</button>
    </div>

    <!-- QR Tab (Full Features with REAL SCANNING) -->
    <div class="tab-content" id="qr-tab">
      <h3>üì∑ Qu√©t QR Th√¥ng minh</h3>
      <div id="camera-wrapper">
          <!-- Video element to capture camera stream -->
          <video id="camera-preview" autoplay playsinline style="display: none;"></video>
          <!-- Canvas for processing video frame and drawing QR bounds -->
          <canvas id="camera-canvas"></canvas>
          <!-- Scanner Frame -->
          <div id="scanner-line-wrapper" class="hidden" style="position: absolute; width: 100%; height: 100%; top: 0; left: 0;">
             <div class="scanner-frame"></div>
             <div class="scanner-line"></div>
          </div>
          <div id="camera-placeholder" style="width: 100%; height: 100%; background: #2c3e50; border-radius: 12px; display: flex; justify-content: center; align-items: center; color: #fff; font-size: 16px; font-weight: 600;">CH∆ØA KH·ªûI ƒê·ªòNG CAMERA</div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 15px; width: 95%;">
        <button id="scan-button" onclick="startCamera()" style="flex: 1; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">B·∫Øt ƒë·∫ßu qu√©t</button>
        <button id="stop-button" onclick="stopCamera()" style="display: none; flex: 1; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">Ng·ª´ng Camera</button>
      </div>

      <!-- N√∫t gi·∫£ l·∫≠p (MOCK SCAN BUTTON) -->
      <button onclick="mockScan()" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); width: 95%; margin-top: 10px; padding: 10px 25px; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);">
          ‚ú® Gi·∫£ l·∫≠p Qu√©t th√†nh c√¥ng
      </button>

      <!-- K·∫øt qu·∫£ Qu√©t -->
      <div id="qr-result" style="display:none; flex-direction:column; margin-top:15px; width:95%; padding:15px; border-radius:12px; text-align: left; background:var(--nav-active-bg); box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
        <h4 id="data-title" style="color:var(--primary-dark); margin-bottom: 10px;">Th√¥ng tin ƒë√£ qu√©t: ...</h4>
        <div id="scanned-details" style="font-size: 14px; margin-bottom: 10px;"></div>
        
        <div id="interaction-buttons" style="display: flex; justify-content: center; width: 100%; margin-top: 5px; gap: 10px;">
          <button id="audio-button" onclick="playVideoPresentation()" style="display: none; flex: 1; padding: 10px 15px; border-radius: 10px; font-size: 14px;">üé• Xem thuy·∫øt tr√¨nh</button>
          <button id="view360-button" onclick="view360()" style="display: none; flex: 1; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 10px 15px; border-radius: 10px; font-size: 14px;">üåÄ Xem 360¬∞ / AR</button>
        </div>
        
        <!-- VIDEO PLAYER CONTAINER -->
        <div id="video-container">
            <video id="artifact-video" controls>
                <source src="Cu·ªôc ƒë·ªùi H∆∞ng ƒê·∫°o ƒê·∫°i V∆∞∆°ng Tr·∫ßn Qu·ªëc Tu·∫•n  Nh√¢n v·∫≠t l·ªãch s·ª≠ - T√≥m t·∫Øt l·ªãch s·ª≠ - EZ S·ª≠ - EZ S·ª≠ (1080p, h264).mp4" type="video/mp4">
                Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ video.
            </video>
            <div style="padding: 5px; background: #333; color: #fff; font-size: 12px; text-align: center;">ƒêang ph√°t video thuy·∫øt minh</div>
        </div>

        <!-- 3D VIEWER CONTAINER -->
        <div id="artifact-360-display">
            <p style="text-align:center; margin-top: 130px; color: #999;">ƒêang t·∫£i m√¥ h√¨nh...</p>
        </div>
      </div>
    </div>

    <!-- Map Tab (N√¢ng c·∫•p) -->
    <div class="tab-content" id="map-tab">
      <h3>üó∫Ô∏è B·∫£n ƒë·ªì & H∆∞·ªõng d·∫´n</h3>
      <select id="floor-select" onchange="changeFloor()" style="margin-bottom:15px; padding: 10px; border-radius: 10px; width: 95%;">
        <option value="1">T·∫ßng 1 - C·ªï v·∫≠t & Ti·∫øp ƒë√≥n</option>
        <option value="2">T·∫ßng 2 - L·ªãch s·ª≠ & Kh√°ng chi·∫øn</option>
        <option value="3">T·∫ßng 3 - VƒÉn h√≥a & Ph√°t tri·ªÉn</option>
      </select>
      
      <!-- ƒêi·ªÉm ƒë·∫øn Selector -->
      <select id="destination-select" style="margin-bottom:15px; padding: 10px; border-radius: 10px; width: 95%;">
        <option value="" selected>Ch·ªçn ƒëi·ªÉm ƒë·∫øn...</option>
      </select>
      
      <div class="map-filters">
        <div class="filter-item active" id="filter-display" onclick="toggleFilter('display')"><span>üñºÔ∏è</span>Tr∆∞ng b√†y</div>
        <div class="filter-item active" id="filter-toilet" onclick="toggleFilter('toilet')"><span>üöª</span>WC</div>
        <div class="filter-item active" id="filter-info" onclick="toggleFilter('info')"><span>‚ÑπÔ∏è</span>Th√¥ng tin</div>
        <div class="filter-item active" id="filter-current" onclick="toggleFilter('current')"><span>üìç</span>B·∫°n</div>
      </div>
      
      <div id="map-container">
        <div id="path-line"></div>
        <!-- Markers added via JS -->
      </div>
      
      <div style="display: flex; gap: 10px; width: 95%; margin-top: 5px;">
        <button onclick="findPath()" style="flex: 1; background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);">‚û°Ô∏è D·∫´n ƒë∆∞·ªùng</button>
        <button onclick="resetMap()" style="flex: 1; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">üîÑ ƒê·∫∑t l·∫°i</button>
      </div>
      <div id="ai-guide" style="background: linear-gradient(45deg, var(--primary-color), #4d89ff); color: white; padding: 12px; width: 95%; border-radius: 12px; font-size: 14px; margin-top: 15px;">ü§ñ G·ª£i √Ω: T·∫ßng 1 ƒëang ƒë√¥ng kh√°ch.</div>
    </div>

    <!-- Profile Tab (N√¢ng c·∫•p) -->
    <div class="tab-content" id="profile-tab">
      <h3>üë§ H·ªì s∆° & Th√†nh t√≠ch</h3>
      
      <!-- NEW: Profile Main View -->
      <div id="profile-main-view" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
          <div class="info-card" style="text-align: center; border-left: 5px solid var(--accent-color);">
            <p>M√£ v√©: <b>123456</b></p>
            <p>H·ªç t√™n: <b>Nguy·ªÖn VƒÉn A</b></p>
            <p>Th·ªùi gian: 14:30 15/07/2025</p>
          </div>

          <div class="info-card achievement-card">
            <h4>üèÜ Th√†nh t√≠ch Quizz & Ph·∫ßn th∆∞·ªüng</h4>
            <p>ƒêi·ªÉm Quiz: <b id="quiz-score">0</b>/3</p>
            <p id="reward-status">Ho√†n th√†nh Quiz ƒë·ªÉ nh·∫≠n ph·∫ßn th∆∞·ªüng!</p>
            <button onclick="checkRewardStatus()">Ki·ªÉm tra Ph·∫ßn th∆∞·ªüng</button>
          </div>
          
          <!-- NEW: Button to trigger the History/Quiz sub-screen -->
          <button onclick="showHistoryQuizView()" style="width: 95%; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
              üîç Xem L·ªãch s·ª≠ Hi·ªán v·∫≠t & Quiz
          </button>
      </div>
      
      <!-- NEW: Artifact History and Quiz Sub-View (Initially hidden) -->
      <div id="artifact-history-quiz-view" style="width: 100%; display: none; flex-direction: column; align-items: center;">
          
          <!-- Back button -->
          <button onclick="backToProfileMain()" style="width: 95%; background: linear-gradient(135deg, #c0c0c0 0%, #999999 100%); color: var(--text-dark); margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.15);">
              ‚¨ÖÔ∏è Quay l·∫°i H·ªì s∆°
          </button>
          
          <!-- Old Combined Card Content -->
          <div class="info-card" id="history-quiz-combined-area" style="border-left: 5px solid var(--primary-dark); padding: 0;">
            
            <!-- History Section -->
            <div style="padding: 15px 15px 5px 15px;">
                <h4>üìç ƒê·ªãa ƒëi·ªÉm ƒë√£ tham quan (Qu√©t QR)</h4>
                <ul id="visited-locations" style="list-style-type: disc; margin-left: 15px; margin-bottom: 5px;">
                  <!-- Items added via JS -->
                  <li>(Ch∆∞a c√≥)</li>
                </ul>
            </div>

            <!-- Quiz Section -->
            <div id="quiz-area" style="padding: 10px 15px 15px 15px; border-top: 1px solid #eee;">
                <h4>‚ùì Mini Quiz Hi·ªán v·∫≠t</h4>
                <!-- M·ªöI: Tr·∫°ng th√°i m·ªü kh√≥a quiz -->
                <div id="quiz-unlock-status" style="margin-bottom: 10px; font-weight: 500; padding: 10px; border-radius: 8px; text-align: center;">
                    <!-- N·ªôi dung ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·∫±ng JS -->
                </div>
                <!-- M·ªöI: Banner h√¨nh ·∫£nh cho quiz -->
                <div id="quiz-banner" style="display:none; margin-bottom: 15px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                    <img id="quiz-banner-img" src="https://placehold.co/350x150/2c3e50/ffffff?text=QUIZ+V·ªÄ+T∆Ø·ª¢NG+ƒê√ÄI+L·ªäCH+S·ª¨" alt="Quiz Banner" style="width: 100%; height: auto; display: block;">
                </div>
                <!-- M·ªöI: Loader gi·∫£ l·∫≠p -->
                <div id="quiz-loader" style="text-align: center; display:none; padding: 20px;">
                    <div style="border: 4px solid #f3f3f3; border-top: 4px solid var(--accent-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; display: inline-block;"></div>
                    <p style="margin-top: 10px; color: var(--primary-dark);">ƒêang t·∫£i Quiz... Chu·∫©n b·ªã s·∫µn s√†ng!</p>
                </div>

                <div id="quiz-question-container">
                    <!-- Questions added via JS -->
                </div>
                <button id="quiz-submit-button" onclick="submitQuiz()" style="display:none; width:100%; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">Ho√†n th√†nh Quiz</button>
                <button id="quiz-start-button" onclick="startQuiz()" style="width:100%;">B·∫Øt ƒë·∫ßu Quiz</button>
            </div>
          </div>
          
      </div>

      <button onclick="logout()">ƒêƒÉng xu·∫•t</button>
    </div>

    <!-- Bottom nav -->
    <div class="bottom-nav">
      <div class="nav-item" id="nav-intro" onclick="showTab('intro-tab')"><span>üèõÔ∏è</span>Gi·ªõi thi·ªáu</div>
      <div class="nav-item" id="nav-chat" onclick="showTab('chat-tab')"><span>üí¨</span>Chatbot</div>
      <div class="nav-item" id="nav-qr" onclick="showTab('qr-tab')"><span>üì∑</span>Qu√©t QR</div>
      <div class="nav-item" id="nav-map" onclick="showTab('map-tab')"><span>üó∫Ô∏è</span>B·∫£n ƒë·ªì</div>
      <div class="nav-item" id="nav-profile" onclick="showTab('profile-tab')"><span>üë§</span>H·ªì s∆°</div>
    </div>
  </div>
</div>

<script>
/* ==========================================================================
   D·ªÆ LI·ªÜU GAMEFICATION (M·ªöI)
   ========================================================================== */
let visitedArtifacts = []; // Array of { id: string, name: string }
let quizScore = 0;
const REWARD_THRESHOLD = 3; 
// M·ªöI: S·ªë hi·ªán v·∫≠t t·ªëi thi·ªÉu c·∫ßn tham quan ƒë·ªÉ m·ªü Quiz
const MIN_ARTIFACTS_FOR_QUIZ = 2; 

// D·ªØ li·ªáu Quiz c·ªë ƒë·ªãnh
const miniQuizData = [
    {
        question: "Tr·∫ßn H∆∞ng ƒê·∫°o ƒë∆∞·ª£c bi·∫øt ƒë·∫øn nhi·ªÅu nh·∫•t v·ªõi vai tr√≤ g√¨ trong l·ªãch s·ª≠ Vi·ªát Nam?",
        options: [
            { text: "Nh√† th∆° v√† h·ªçc gi·∫£", isCorrect: false, answer: "Th∆∞·ªùng b·ªã nh·∫ßm l·∫´n v·ªõi c√°c nh√† vƒÉn h√≥a kh√°c." },
            { text: "Qu·ªëc c√¥ng Ti·∫øt ch·∫ø ch·ªëng Nguy√™n M√¥ng", isCorrect: true, answer: "ƒê√¢y l√† t∆∞·ªõc v·ªã v√† vai tr√≤ quan tr·ªçng nh·∫•t c·ªßa √¥ng." },
            { text: "Ho√†ng ƒë·∫ø s√°ng l·∫≠p tri·ªÅu Tr·∫ßn", isCorrect: false, answer: "√îng l√† t√¥n th·∫•t, nh∆∞ng kh√¥ng ph·∫£i ng∆∞·ªùi s√°ng l·∫≠p." },
            { text: "Ng∆∞·ªùi vi·∫øt Chi·∫øu d·ªùi ƒë√¥", isCorrect: false, answer: "Ng∆∞·ªùi vi·∫øt Chi·∫øu d·ªùi ƒë√¥ l√† L√Ω C√¥ng U·∫©n." }
        ]
    },
    {
        question: 'T√°c ph·∫©m n·ªïi ti·∫øng "H·ªãch t∆∞·ªõng sƒ©" c·ªßa √¥ng ƒë∆∞·ª£c vi·∫øt nh·∫±m m·ª•c ƒë√≠ch g√¨?',
        options: [
            { text: "K√™u g·ªçi binh sƒ© quy h√†ng qu√¢n ƒë·ªãch", isCorrect: false, answer: "M·ª•c ƒë√≠ch ho√†n to√†n ng∆∞·ª£c l·∫°i." },
            { text: "K√≠ch l·ªá tinh th·∫ßn v√† √Ω ch√≠ chi·∫øn ƒë·∫•u ch·ªëng qu√¢n x√¢m l∆∞·ª£c", isCorrect: true, answer: "ƒê√¢y l√† m·ª•c ƒë√≠ch c·ªët l√µi c·ªßa √°ng vƒÉn." },
            { text: "Ghi ch√©p v·ªÅ ti·ªÉu s·ª≠ c·ªßa √¥ng", isCorrect: false, answer: "ƒê√¢y l√† vƒÉn ki·ªán chi·∫øn ƒë·∫•u, kh√¥ng ph·∫£i t·ª± truy·ªán." },
            { text: "B√†n v·ªÅ tri·∫øt l√Ω s·ªëng", isCorrect: false, answer: "T√°c ph·∫©m t·∫≠p trung v√†o tinh th·∫ßn d√¢n t·ªôc v√† chi·∫øn ƒë·∫•u." }
        ]
    },
    {
        question: "Tr·∫≠n B·∫°ch ƒê·∫±ng (1288) ƒë√£ ƒë∆∞·ª£c Tr·∫ßn H∆∞ng ƒê·∫°o s·ª≠ d·ª•ng chi·∫øn thu·∫≠t g√¨?",
        options: [
            { text: "C√¥ng th√†nh chi·∫øn k√©o d√†i", isCorrect: false, answer: "Chi·∫øn thu·∫≠t n√†y kh√¥ng ph√π h·ª£p v·ªõi s√¥ng n∆∞·ªõc." },
            { text: "T·∫≠p k√≠ch b·∫±ng k·ªµ binh", isCorrect: false, answer: "Tr·∫≠n chi·∫øn di·ªÖn ra tr√™n s√¥ng n∆∞·ªõc." },
            { text: "S·ª≠ d·ª•ng c·ªçc ng·∫ßm k·∫øt h·ª£p th·ªßy tri·ªÅu", isCorrect: true, answer: "ƒê√¢y l√† chi·∫øn thu·∫≠t n·ªïi ti·∫øng ƒë√£ nh·∫•n ch√¨m h·∫°m ƒë·ªôi Nguy√™n M√¥ng." },
            { text: "ƒê√°nh l√©n ban ƒë√™m", isCorrect: false, answer: "Tr·∫≠n ƒë√°nh n√†y l√† tr·∫≠n th·ªßy chi·∫øn l·ªõn." }
        ]
    }
];


// --- PROFILE / QUIZ LOGIC (C·∫¨P NH·∫¨T) ---

// NEW FUNCTION: Manage sub-screens within Profile tab
function showProfileSubScreen(viewId) {
    document.getElementById('profile-main-view').style.display = 'none';
    document.getElementById('artifact-history-quiz-view').style.display = 'none';
    
    // Show the requested view
    const targetView = document.getElementById(viewId);
    if (targetView) {
        targetView.style.display = 'flex';
    }
}

function showHistoryQuizView() {
    showProfileSubScreen('artifact-history-quiz-view');
    renderProfileHistoryQuiz();
}

function backToProfileMain() {
    showProfileSubScreen('profile-main-view');
    // Ensure main view info is up-to-date (esp. score)
    renderProfileMain(); 
}

function renderProfileMain() {
    // Only update score/reward status on the main card
    const scoreEl = document.getElementById('quiz-score');
    scoreEl.innerText = `${quizScore}/${miniQuizData.length}`;
    checkRewardStatus();
}

function renderProfileHistoryQuiz() {
    const visitedList = document.getElementById('visited-locations');
    const quizStartBtn = document.getElementById('quiz-start-button');
    const quizUnlockStatus = document.getElementById('quiz-unlock-status');
    const quizBanner = document.getElementById('quiz-banner');
    const quizLoader = document.getElementById('quiz-loader');
    
    // 1. C·∫≠p nh·∫≠t danh s√°ch ƒë√£ tham quan
    visitedList.innerHTML = visitedArtifacts.length > 0
        ? visitedArtifacts.map(a => `<li>üñºÔ∏è ${a.name} (${a.id})</li>`).join('')
        : '<li>(Ch∆∞a c√≥)</li>';

    // 2. KI·ªÇM TRA ƒêI·ªÄU KI·ªÜN M·ªû KH√ìA QUIZ
    const visitedCount = visitedArtifacts.length;
    const isQuizUnlocked = visitedCount >= MIN_ARTIFACTS_FOR_QUIZ;
    
    if (isQuizUnlocked) {
        quizUnlockStatus.innerHTML = `üåü **Quiz ƒë√£ m·ªü kh√≥a!** (${visitedCount}/${MIN_ARTIFACTS_FOR_QUIZ} hi·ªán v·∫≠t)`;
        quizUnlockStatus.style.backgroundColor = '#ccffcc';
        quizUnlockStatus.style.color = 'var(--primary-dark)';
        quizStartBtn.disabled = false;
        quizStartBtn.style.opacity = 1;
    } else {
        const remaining = MIN_ARTIFACTS_FOR_QUIZ - visitedCount;
        quizUnlockStatus.innerHTML = `üîí C·∫ßn tham quan th√™m ${remaining} hi·ªán v·∫≠t ƒë·ªÉ m·ªü kh√≥a Quiz.`;
        quizUnlockStatus.style.backgroundColor = '#ffe0e0';
        quizUnlockStatus.style.color = '#e74c3c';
        quizStartBtn.disabled = true;
        quizStartBtn.style.opacity = 0.5;
    }
    
    // 3. Reset Quiz UI
    miniQuizData.forEach(q => {
        if (q.selectedOptionIndex === undefined) q.selectedOptionIndex = null;
        if (q.submitted === undefined) q.submitted = false;
    });

    // Ch·ªâ render quiz questions n·∫øu ch∆∞a ·ªü ch·∫ø ƒë·ªô submit/ƒëang l√†m
    if (document.getElementById('quiz-submit-button').style.display === 'none') {
        renderQuizQuestions(false); 
        quizBanner.style.display = 'none'; // ·∫®n banner khi kh√¥ng l√†m quiz
        quizLoader.style.display = 'none';
        document.getElementById('quiz-question-container').style.display = 'block';
    }
}

function renderProfile() {
    // Render main view content and ensure sub-view content is initialized
    renderProfileMain();
    renderProfileHistoryQuiz();
    showProfileSubScreen('profile-main-view'); // Ensure main view is visible on tab switch
}


function startQuiz() {
    // Reset tr·∫°ng th√°i quiz
    miniQuizData.forEach(q => {
        q.selectedOptionIndex = null;
        q.submitted = false;
    });
    quizScore = 0;
    
    const quizStartBtn = document.getElementById('quiz-start-button');
    const quizContainer = document.getElementById('quiz-question-container');
    const quizBanner = document.getElementById('quiz-banner');
    const quizLoader = document.getElementById('quiz-loader');
    
    quizStartBtn.style.display = 'none';
    quizContainer.style.display = 'none';
    
    // M·ªöI: Hi·ªÉn th·ªã loader v√† banner tr∆∞·ªõc
    quizBanner.style.display = 'block';
    quizLoader.style.display = 'block';
    
    showAlert("ƒêang t·∫£i Quiz...");

    // M√î PH·ªéNG ƒê·ªò TR·ªÑ KHI B·∫ÆT ƒê·∫¶U QUIZ
    setTimeout(() => {
        quizLoader.style.display = 'none';
        quizContainer.style.display = 'block';
        
        document.getElementById('quiz-submit-button').style.display = 'inline-block';
        renderQuizQuestions(true); // B·∫Øt ƒë·∫ßu mode t∆∞∆°ng t√°c
        showAlert("Quiz ƒë√£ b·∫Øt ƒë·∫ßu. H√£y tr·∫£ l·ªùi c√°c c√¢u h·ªèi!");
    }, 1000); // 1 gi√¢y m√¥ ph·ªèng t·∫£i
}

function renderQuizQuestions(interactive = false) {
    const container = document.getElementById('quiz-question-container');
    container.innerHTML = '';
    
    miniQuizData.forEach((q, index) => {
        const qEl = document.createElement('div');
        qEl.className = 'quiz-question';
        qEl.innerHTML = `<h4>C√¢u ${index + 1}: ${q.question}</h4>`;
        
        q.options.forEach((opt, optIndex) => {
            const optBtn = document.createElement('button');
            optBtn.className = 'quiz-option';
            optBtn.innerText = opt.text;
            optBtn.setAttribute('data-q-index', index);
            optBtn.setAttribute('data-opt-index', optIndex);
            
            if (interactive) {
                optBtn.onclick = () => selectQuizOption(optBtn, index, optIndex);
                // Gi·ªØ l·ª±a ch·ªçn n·∫øu ƒë√£ c√≥
                if (q.selectedOptionIndex === optIndex) {
                    optBtn.classList.add('active-selection');
                    optBtn.style.backgroundColor = '#d1e5d4'; // M√†u xanh nh·∫°t khi ch·ªçn
                }
            } else {
                // Ch·∫ø ƒë·ªô xem k·∫øt qu·∫£ (sau khi submit)
                optBtn.disabled = true; // V√¥ hi·ªáu h√≥a n√∫t
                if (q.submitted && opt.isCorrect) {
                    optBtn.classList.add('correct-answer');
                } else if (q.submitted && q.selectedOptionIndex === optIndex && !opt.isCorrect) {
                    optBtn.classList.add('incorrect-answer');
                }
            }
            qEl.appendChild(optBtn);
        });
        
        // Hi·ªÉn th·ªã rationale sau khi submit
        if (q.submitted) {
            const rationaleEl = document.createElement('p');
            rationaleEl.style.marginTop = '10px';
            rationaleEl.style.color = q.options[q.selectedOptionIndex]?.isCorrect ? '#1b5e20' : '#b71c1c';
            rationaleEl.innerHTML = `Gi·∫£i th√≠ch: ${q.options.find(o => o.isCorrect).answer}`;
            qEl.appendChild(rationaleEl);
        }

        container.appendChild(qEl);
    });
}

function selectQuizOption(button, qIndex, optIndex) {
    // X√≥a l·ª±a ch·ªçn c≈©
    document.querySelectorAll(`.quiz-option[data-q-index="${qIndex}"]`).forEach(btn => {
        btn.classList.remove('active-selection');
        btn.style.backgroundColor = '#f7f7f7';
    });
    
    // ƒê·∫∑t l·ª±a ch·ªçn m·ªõi
    button.classList.add('active-selection');
    button.style.backgroundColor = '#d1e5d4';
    miniQuizData[qIndex].selectedOptionIndex = optIndex;
}

function submitQuiz() {
    let correctCount = 0;
    miniQuizData.forEach(q => {
        q.submitted = true;
        if (q.selectedOptionIndex !== null && q.options[q.selectedOptionIndex]?.isCorrect) {
            correctCount++;
        }
    });
    
    quizScore = correctCount;
    renderQuizQuestions(false); // Render ·ªü ch·∫ø ƒë·ªô xem k·∫øt qu·∫£
    renderProfileMain(); // C·∫≠p nh·∫≠t ƒëi·ªÉm v√† tr·∫°ng th√°i ph·∫ßn th∆∞·ªüng tr√™n m√†n h√¨nh ch√≠nh
    
    document.getElementById('quiz-banner').style.display = 'none'; // ·∫®n banner khi n·ªôp
    document.getElementById('quiz-submit-button').style.display = 'none';
    document.getElementById('quiz-start-button').style.display = 'inline-block';
    
    showAlert(`B·∫°n ƒë√£ ho√†n th√†nh Quiz v·ªõi ${quizScore}/${miniQuizData.length} ƒëi·ªÉm!`);
}

function checkRewardStatus() {
    const statusEl = document.getElementById('reward-status');
    const totalCorrect = miniQuizData.length;
    const requiredCorrect = REWARD_THRESHOLD; // C·∫ßn 3/3 ƒëi·ªÉm ƒë·ªÉ nh·∫≠n th∆∞·ªüng

    if (quizScore >= requiredCorrect) {
        statusEl.innerHTML = `üéâ **Ch√∫c m·ª´ng!** B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c **Phi·∫øu gi·∫£m gi√° 10%** t·∫°i c·ª≠a h√†ng l∆∞u ni·ªám.`;
        statusEl.style.color = 'var(--primary-dark)'; 
        statusEl.style.fontWeight = 'bold';
    } else {
        const missing = requiredCorrect - quizScore;
        statusEl.innerHTML = `Ho√†n th√†nh ${requiredCorrect}/${totalCorrect} c√¢u ƒë√∫ng ƒë·ªÉ nh·∫≠n qu√†! B·∫°n c·∫ßn ƒë√∫ng th√™m ${missing} c√¢u n·ªØa.`;
        statusEl.style.color = '#e67e22';
        statusEl.style.fontWeight = 'normal';
    }
}


/* ==========================================================================
   PH·∫¶N 1: LOGIC AI MOCKUP (TR·∫¢ L·ªúI C·ªê ƒê·ªäNH)
   ========================================================================== */

/**
 * C√°c c√¢u tr·∫£ l·ªùi gi·∫£ l·∫≠p cho c√°c c√¢u h·ªèi m·∫´u v·ªÅ Tr·∫ßn H∆∞ng ƒê·∫°o.
 */
const mockAnswers = {
    'ti·ªÉus·ª≠tr·∫ßnh∆∞ngƒë·∫°o?': 'ü§ñ Tr·∫ßn H∆∞ng ƒê·∫°o (Tr·∫ßn Qu·ªëc Tu·∫•n, 1228‚Äì1300) l√† Qu·ªëc c√¥ng Ti·∫øt ch·∫ø tri·ªÅu Tr·∫ßn, ng∆∞·ªùi ch·ªâ huy qu√¢n d√¢n ƒê·∫°i Vi·ªát 3 l·∫ßn ƒë√°nh th·∫Øng qu√¢n Nguy√™n M√¥ng. √îng ƒë∆∞·ª£c xem l√† m·ªôt trong 10 v·ªã t∆∞·ªõng vƒ© ƒë·∫°i nh·∫•t l·ªãch s·ª≠ th·∫ø gi·ªõi.',
    't√°cph·∫©mn·ªïiti·∫øngnh·∫•tc·ªßatr·∫ßnh∆∞ngƒë·∫°o?': 'ü§ñ T√°c ph·∫©m n·ªïi ti·∫øng nh·∫•t c·ªßa √¥ng l√† "H·ªãch t∆∞·ªõng sƒ©", m·ªôt √°ng vƒÉn y√™u n∆∞·ªõc h√πng h·ªìn, kh√≠ch l·ªá tinh th·∫ßn chi·∫øn ƒë·∫•u c·ªßa qu√¢n ƒë·ªôi tr∆∞·ªõc h·ªça x√¢m lƒÉng Nguy√™n M√¥ng.',
    'tr·∫≠nchi·∫ønb·∫°chƒë·∫±ngdi·ªÖnrakhin√†o?': 'ü§ñ Tr·∫≠n chi·∫øn B·∫°ch ƒê·∫±ng l·ªãch s·ª≠ di·ªÖn ra v√†o nƒÉm 1288, v·ªõi chi·∫øn thu·∫≠t c·∫Øm c·ªçc ng·∫ßm ƒë·ªôc ƒë√°o c·ªßa Tr·∫ßn H∆∞ng ƒê·∫°o, nh·∫•n ch√¨m g·∫ßn h·∫øt ƒëo√†n thuy·ªÅn chi·∫øn c·ªßa qu√¢n Nguy√™n.',
    '√Ωnghƒ©ac√¢un√≥i"b·ªáh·∫°ch√©mƒë·∫ßuth·∫ßnr·ªìih√£yh√†ng"?': 'ü§ñ C√¢u n√≥i th·ªÉ hi·ªán tinh th·∫ßn y√™u n∆∞·ªõc tuy·ªát ƒë·ªëi, quy·∫øt t·ª≠ v√¨ ƒë·∫•t n∆∞·ªõc c·ªßa √¥ng. N√≥ c·ªßng c·ªë ni·ªÅm tin v√† √Ω ch√≠ kh√¥ng khu·∫•t ph·ª•c c·ªßa tri·ªÅu ƒë√¨nh v√† to√†n qu√¢n d√¢n nh√† Tr·∫ßn.',
    'xin ch√†o': 'ü§ñ Ch√†o b·∫°n! T√¥i ƒëang ·ªü ch·∫ø ƒë·ªô **m√¥ ph·ªèng**. B·∫°n c√≥ th·ªÉ h·ªèi t√¥i c√°c c√¢u h·ªèi m·∫´u v·ªÅ Tr·∫ßn H∆∞ng ƒê·∫°o ho·∫∑c g√µ c√¢u h·ªèi b·∫•t k·ª≥ ƒë·ªÉ xem ph·∫£n h·ªìi m·∫∑c ƒë·ªãnh!',
    'ch√†o': 'ü§ñ Ch√†o b·∫°n! T√¥i ƒëang ·ªü ch·∫ø ƒë·ªô **m√¥ ph·ªèng**. B·∫°n c√≥ th·ªÉ h·ªèi t√¥i c√°c c√¢u h·ªèi m·∫´u v·ªÅ Tr·∫ßn H∆∞ng ƒê·∫°o ho·∫∑c g√µ c√¢u h·ªèi b·∫•t k·ª≥ ƒë·ªÉ xem ph·∫£n h·ªìi m·∫∑c ƒë·ªãnh!',
    'hi': 'ü§ñ Ch√†o b·∫°n! T√¥i ƒëang ·ªü ch·∫ø ƒë·ªô **m√¥ ph·ªèng**. B·∫°n c√≥ th·ªÉ h·ªèi t√¥i c√°c c√¢u h·ªèi m·∫´u v·ªÅ Tr·∫ßn H∆∞ng ƒê·∫°o ho·∫∑c g√µ c√¢u h·ªèi b·∫•t k·ª≥ ƒë·ªÉ xem ph·∫£n h·ªìi m·∫∑c ƒë·ªãnh!',
};

/**
 * H√†m chu·∫©n h√≥a c√¢u h·ªèi ƒë·ªÉ so s√°nh v·ªõi keys trong mockAnswers.
 */
function normalizeString(str) {
    return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s/g, '');
}

/**
 * H√†m h·ªó tr·ª£ ƒëi·ªÅn c√¢u h·ªèi m·∫´u v√† g·ª≠i
 */
function prefillAndSend(query) {
    document.getElementById('chat-input').value = query;
    sendMessage();
}

async function processAI(msg) {
    const normalizedMsg = normalizeString(msg);

    // 1. Ki·ªÉm tra c√¢u h·ªèi c√≥ trong Mock Answers kh√¥ng
    for (const key in mockAnswers) {
        if (normalizedMsg.includes(normalizeString(key)) || normalizedMsg === normalizeString(key)) {
            return mockAnswers[key];
        }
    }

    // 2. Ph·∫£n h·ªìi m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng kh·ªõp
    return 'ü§ñ AI: ƒê√¢y l√† ch·∫ø ƒë·ªô m√¥ ph·ªèng. Vui l√≤ng ch·ªçn m·ªôt trong c√°c c√¢u h·ªèi m·∫´u v·ªÅ Tr·∫ßn H∆∞ng ƒê·∫°o ƒë·ªÉ xem ph·∫£n h·ªìi ƒë∆∞·ª£c l·∫≠p tr√¨nh s·∫µn.';
}

let isProcessing = false;

async function sendMessage() {
    if (isProcessing) return;

    const input = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const msg = input.value.trim();
    if (!msg) return;

    isProcessing = true;
    input.disabled = true;
    sendBtn.disabled = true;

    const chatWindow = document.getElementById('chat-window');
    
    // Th√™m tin nh·∫Øn ng∆∞·ªùi d√πng
    const userDiv = document.createElement('div');
    userDiv.className = 'chat-message user-msg';
    userDiv.innerText = msg;
    chatWindow.appendChild(userDiv);
    chatWindow.appendChild(document.createElement('div')).style.clear = 'both'; 

    try {
        // M√¥ ph·ªèng ƒë·ªô tr·ªÖ nh·ªè ƒë·ªÉ ph·∫£n h·ªìi tr√¥ng t·ª± nhi√™n h∆°n
        await new Promise(resolve => setTimeout(resolve, 500)); 

        const response = await processAI(msg);
        
        // Th√™m tin nh·∫Øn AI
        const aiDiv = document.createElement('div');
        aiDiv.className = 'chat-message ai-msg';
        aiDiv.innerHTML = response; 
        chatWindow.appendChild(aiDiv);
        chatWindow.appendChild(document.createElement('div')).style.clear = 'both'; 

    } catch (e) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'chat-message ai-msg';
        errorDiv.innerHTML = 'ü§ñ <b>L·ªói:</b> ƒê√£ x·∫£y ra l·ªói trong qu√° tr√¨nh x·ª≠ l√Ω m√¥ ph·ªèng.';
        chatWindow.appendChild(errorDiv);
        chatWindow.appendChild(document.createElement('div')).style.clear = 'both'; 
    } finally {
        isProcessing = false;
        input.disabled = false;
        sendBtn.disabled = false;
        chatWindow.scrollTop = chatWindow.scrollHeight;
        input.value = '';
    }
}

/* ==========================================================================
   PH·∫¶N 2: C√ÅC T√çNH NƒÇNG C·ªêT L√ïI V√Ä GIAO DI·ªÜN
   ========================================================================== */
let currentStream = null;
let videoInterval = null;
// D·ªØ li·ªáu m·∫´u gi·∫£ ƒë·ªãnh QR qu√©t th√†nh c√¥ng (D·ªØ li·ªáu n√†y ƒë∆∞·ª£c update trong mockScan)
const mockArtifactData = JSON.stringify({ id: "artifact_123", type: "artifact", name: "T∆∞·ª£ng Tr·∫ßn H∆∞ng ƒê·∫°o", floor: 1, pos: "C·ªï v·∫≠t", model: "tuong+tran+hung+dao.glb" });
let selectedDestinationMarkerId = null;

function showAlert(message) { console.log("[Th√¥ng b√°o]: " + message); }

function showTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active-tab'));
  document.getElementById(tabId).classList.add('active-tab');
  
  document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
  const activeNavItem = document.querySelector(`.nav-item[onclick*="${tabId}"]`);
  if (activeNavItem) activeNavItem.classList.add('active');

  if (tabId !== 'qr-tab') stopCamera();
  if (tabId === 'map-tab') changeFloor();
  
  // N√¢ng c·∫•p: Khi m·ªü tab Profile, c·∫≠p nh·∫≠t th√¥ng tin
  if (tabId === 'profile-tab') {
      showProfileSubScreen('profile-main-view'); // Default to main view
      renderProfileMain(); // Render main view content
      renderProfileHistoryQuiz(); // Pre-render/update sub-view data
  }
}

function goToLogin() { document.getElementById('wifi-screen').classList.add('hidden'); document.getElementById('login-screen').classList.remove('hidden'); }
function goToMain() { document.getElementById('login-screen').classList.add('hidden'); document.getElementById('main-screen').classList.remove('hidden'); showTab('intro-tab'); }
function logout() { document.getElementById('main-screen').classList.add('hidden'); document.getElementById('login-screen').classList.remove('hidden'); }

// --- QR & CAMERA LOGIC (N√ÇNG C·∫§P TH·ª∞C T·∫æ) ---
async function startCamera() {
  stopCamera(); 
  const video = document.getElementById('camera-preview');
  const canvas = document.getElementById('camera-canvas');
  const context = canvas.getContext('2d');
  const placeholder = document.getElementById('camera-placeholder');
  const scanBtn = document.getElementById('scan-button');
  const stopBtn = document.getElementById('stop-button');
  const scannerLine = document.getElementById('scanner-line-wrapper');
  const qrResult = document.getElementById('qr-result');

  qrResult.style.display = 'none';
  placeholder.style.display = 'flex'; placeholder.innerText = 'ƒêang kh·ªüi ƒë·ªông Camera...';
  scanBtn.style.display = 'none';

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    currentStream = stream; video.srcObject = stream; video.style.display = 'block';
    
    // Ch·ªù video ƒë∆∞·ª£c t·∫£i metadata
    await new Promise(resolve => {
        video.onloadedmetadata = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            resolve();
        };
    });

    placeholder.style.display = 'none'; stopBtn.style.display = 'inline-block'; scannerLine.classList.remove('hidden');
    
    // T·ªâ l·ªá cho canvas/video trong UI
    const wrapper = document.getElementById('camera-wrapper');
    video.style.height = `${wrapper.offsetHeight}px`;
    video.style.width = `${wrapper.offsetWidth}px`;

    // B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p qu√©t QR
    videoInterval = setInterval(() => {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });

            if (code) {
                clearInterval(videoInterval); // D·ª´ng qu√©t
                stopCamera();
                handleScanSuccess(code.data);
                scanBtn.style.display = 'inline-block'; scanBtn.innerText = 'Qu√©t l·∫°i';
            }
        }
    }, 100);

    showAlert("Camera ƒë√£ s·∫µn s√†ng. ƒêang qu√©t...");
  } catch (err) {
    console.error("L·ªói Camera:", err);
    placeholder.innerText = 'L·ªói Camera: Kh√¥ng th·ªÉ truy c·∫≠p.'; 
    scanBtn.style.display = 'inline-block'; stopBtn.style.display = 'none';
  }
}

function stopCamera() {
  if (videoInterval) clearInterval(videoInterval);
  videoInterval = null;
  if (currentStream) currentStream.getTracks().forEach(track => track.stop());
  currentStream = null;
  const video = document.getElementById('camera-preview');
  video.style.display = 'none'; video.srcObject = null;
  document.getElementById('camera-placeholder').style.display = 'flex';
  document.getElementById('scan-button').style.display = 'inline-block';
  document.getElementById('stop-button').style.display = 'none';
  document.getElementById('scanner-line-wrapper').classList.add('hidden');
}

// H√†m gi·∫£ l·∫≠p qu√©t QR (ƒê√É C·∫¨P NH·∫¨T LOGIC L∆ØU HI·ªÜN V·∫¨T)
function mockScan() {
    stopCamera();
    
    // Gi·∫£ l·∫≠p 2 hi·ªán v·∫≠t distinct ƒë·ªÉ test unlock quiz
    const artifactId1 = 'artifact_123';
    const artifactName1 = 'T∆∞·ª£ng Tr·∫ßn H∆∞ng ƒê·∫°o';
    const artifactId2 = 'artifact_456';
    const artifactName2 = 'ƒê√†i th·ªù Tr√† Ki·ªáu';
    
    let scanId = artifactId1;
    let scanName = artifactName1;

    // Logic m√¥ ph·ªèng: N·∫øu ƒë√£ qu√©t hi·ªán v·∫≠t 1, chuy·ªÉn sang qu√©t hi·ªán v·∫≠t 2
    if (visitedArtifacts.find(a => a.id === artifactId1) && !visitedArtifacts.find(a => a.id === artifactId2)) {
        scanId = artifactId2;
        scanName = artifactName2;
    } else if (visitedArtifacts.find(a => a.id === artifactId1) && visitedArtifacts.find(a => a.id === artifactId2)) {
        // N·∫øu ƒë√£ qu√©t ƒë·ªß 2 hi·ªán v·∫≠t, quay l·∫°i qu√©t hi·ªán v·∫≠t 1
        scanId = artifactId1;
        scanName = artifactName1;
    }

    const existing = visitedArtifacts.find(a => a.id === scanId);
    if (!existing) {
        visitedArtifacts.push({ id: scanId, name: scanName });
        showAlert(`Gi·∫£ l·∫≠p: Qu√©t th√†nh c√¥ng hi·ªán v·∫≠t: ${scanName}. ƒê√£ th√™m v√†o H·ªì s∆°.`);
    } else {
        showAlert(`Gi·∫£ l·∫≠p: Qu√©t l·∫°i hi·ªán v·∫≠t: ${scanName}. (ƒê√£ c√≥ trong H·ªì s∆°).`);
    }

    // C·∫≠p nh·∫≠t mockArtifactData cho UI (QR Result)
    const mockArtifactDataUpdated = JSON.stringify({ id: scanId, type: "artifact", name: scanName, floor: scanId === artifactId1 ? 1 : 3, pos: "C·ªï v·∫≠t" });


    handleScanSuccess(mockArtifactDataUpdated); // C·∫≠p nh·∫≠t QR result UI
    document.getElementById('scan-button').innerText = 'Qu√©t l·∫°i';
    document.getElementById('scan-button').style.display = 'inline-block';

    // C·∫ßn c·∫≠p nh·∫≠t profile n·∫øu ƒëang ·ªü tab profile
    if (document.getElementById('profile-tab').classList.contains('active-tab')) {
        renderProfileMain(); // Update main view score/reward status
        renderProfileHistoryQuiz(); // Update history/quiz view
    }
}


function handleScanSuccess(json) {
  try {
      const data = JSON.parse(json);
      const titleEl = document.getElementById('data-title');
      const detailsEl = document.getElementById('scanned-details');
      const audioBtn = document.getElementById('audio-button');
      const view360Btn = document.getElementById('view360-button');
      
      // Reset interaction buttons
      audioBtn.style.display = 'none'; view360Btn.style.display = 'none';
      document.getElementById('artifact-360-display').style.display = 'none';
      document.getElementById('video-container').style.display = 'none'; 

      if (data.type === 'artifact' && data.name) {
        titleEl.innerText = `Th√¥ng tin hi·ªán v·∫≠t: ${data.name}`;
        detailsEl.innerHTML = `<p><b>ID:</b> ${data.id}</p><p><b>V·ªã tr√≠:</b> T·∫ßng ${data.floor} - Khu ${data.pos}</p>`;
        
        // Gi·∫£ l·∫≠p hi·ªán v·∫≠t c√≥ c·∫£ Video v√† 3D
        if (data.id === 'artifact_123' || data.id === 'artifact_456') {
            audioBtn.style.display = 'inline-block';
            view360Btn.style.display = 'inline-block';
        }
        showAlert(`Qu√©t th√†nh c√¥ng: ${data.name}`);
      } else {
        titleEl.innerText = "K·∫øt qu·∫£ qu√©t";
        detailsEl.innerText = "D·ªØ li·ªáu kh√¥ng ph·∫£i l√† hi·ªán v·∫≠t (V√≠ d·ª•: M√£ v√© ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω l√∫c ƒêƒÉng nh·∫≠p).";
      }
      document.getElementById('qr-result').style.display = 'flex';
      
      // C·∫ßn c·∫≠p nh·∫≠t profile n·∫øu ƒëang ·ªü tab profile
      if (document.getElementById('profile-tab').classList.contains('active-tab')) {
          renderProfileMain(); // Update main view score/reward status
          renderProfileHistoryQuiz(); // Update history/quiz view
      }
      
  } catch(e) {
      console.error("L·ªói ph√¢n t√≠ch QR Data:", e);
      document.getElementById('data-title').innerText = "L·ªói d·ªØ li·ªáu QR";
      document.getElementById('scanned-details').innerText = "D·ªØ li·ªáu QR kh√¥ng h·ª£p l·ªá.";
      document.getElementById('qr-result').style.display = 'flex';
  }
}

// --- NEW VIDEO FEATURE ---
function playVideoPresentation() {
    const videoContainer = document.getElementById('video-container');
    const videoEl = document.getElementById('artifact-video');
    const display360 = document.getElementById('artifact-360-display');

    display360.style.display = 'none';
    
    videoContainer.style.display = 'block';
    videoEl.play();
    
    showAlert("ƒêang ph√°t video thuy·∫øt minh.");
}

// --- 3D VIEWER FEATURE (UPDATED) ---
function view360() { 
    const d = document.getElementById('artifact-360-display');
    const videoContainer = document.getElementById('video-container');
    const videoEl = document.getElementById('artifact-video');
    
    videoContainer.style.display = 'none';
    videoEl.pause();

    d.style.display = 'block';
    
    // ƒê√£ thay ƒë·ªïi t·ª´ Horse.glb sang Astronaut.glb ƒë·ªÉ m√¥ ph·ªèng h√¨nh ng∆∞·ªùi
    const modelSrc = 'https://modelviewer.dev/shared-assets/models/Astronaut.glb'; 
    const iosSrc = 'tuong+tran+hung+dao.usdz';
    
    d.innerHTML = `
      <model-viewer 
        src="${modelSrc}" 
        ios-src="${iosSrc}"
        poster="https://placehold.co/400x300/eafaea/000000?text=Mo+Hinh+T∆Ø·ª¢NG+TR·∫¶N+H∆ØNG+ƒê·∫†O+3D+(GLB)" 
        alt="M√¥ h√¨nh 3D T∆∞·ª£ng Tr·∫ßn H∆∞ng ƒê·∫°o"
        shadow-intensity="1"
        camera-controls
        auto-rotate
        ar
        style="width: 100%; height: 100%;"
      >
        <button slot="ar-button" style="background-color: var(--accent-color); color: var(--text-dark); border-radius: 4px; border: none; position: absolute; top: 16px; right: 16px; height: 30px; font-weight: 600; padding: 0 10px;">
            üëã K√≠ch ho·∫°t AR
        </button>
      </model-viewer>
    `;
    
    showAlert("ƒê√£ t·∫£i khung nh√¨n 3D/AR T∆∞·ª£ng Tr·∫ßn H∆∞ng ƒê·∫°o.");
}

/* ==========================================================================
   PH·∫¶N 3: MAP & PATHFINDING LOGIC (GI·ªÆ NGUY√äN)
   ========================================================================== */
const floorData = {
    1: {
        bg: "https://placehold.co/400x300/a2d9ce/000000?text=SO+DO+TANG+1",
        markers: [
            { id: 'pos-current', type: 'current', top: '70%', left: '50%', title: 'V·ªã tr√≠ hi·ªán t·∫°i' },
            { id: 'wc-1', type: 'toilet', top: '60%', left: '20%', title: 'Nh√† v·ªá sinh (T1)' },
            { id: 'disp-1-1', type: 'display', top: '50%', left: '70%', title: 'Tr∆∞ng b√†y C·ªï v·∫≠t ChƒÉm' },
            { id: 'info-1-1', type: 'info', top: '25%', left: '80%', title: 'Qu·∫ßy Th√¥ng tin' },
            { id: 'disp-1-2', type: 'display', top: '75%', left: '30%', title: 'Tr∆∞ng b√†y L·ªãch s·ª≠ T·ª± nhi√™n' } 
        ]
    },
    2: {
        bg: "https://placehold.co/400x300/f9e79f/000000?text=SO+DO+TANG+2",
        markers: [
            { id: 'pos-current', type: 'current', top: '55%', left: '45%', title: 'V·ªã tr√≠ hi·ªán t·∫°i' },
            { id: 'disp-2-1', type: 'display', top: '40%', left: '30%', title: 'Tr∆∞ng b√†y Kh√°ng chi·∫øn' },
            { id: 'disp-2-2', type: 'display', top: '80%', left: '60%', title: 'Tr∆∞ng b√†y L·ªãch s·ª≠ ƒê√¥ th·ªã' }
        ]
    },
    3: {
        bg: "https://placehold.co/400x300/d7bde2/000000?text=SO+DO+TANG+3",
        markers: [
            { id: 'pos-current', type: 'current', top: '30%', left: '50%', title: 'V·ªã tr√≠ hi·ªán t·∫°i' },
            { id: 'disp-3-1', type: 'display', top: '35%', left: '20%', title: 'Tr∆∞ng b√†y VƒÉn h√≥a ChƒÉm' }
        ]
    }
};
let activeFilters = { display:true, toilet:true, info:true, current:true };

function updateDestinationOptions(floor) {
    const destSelect = document.getElementById('destination-select');
    destSelect.innerHTML = '<option value="" selected>Ch·ªçn ƒëi·ªÉm ƒë·∫øn...</option>';

    if (floorData[floor]) {
        floorData[floor].markers.forEach(m => {
            if (m.type === 'display' || m.type === 'info' || m.type === 'toilet') {
                const option = document.createElement('option');
                option.value = m.id;
                option.innerText = m.title;
                destSelect.appendChild(option);
            }
        });
    }
}

function selectDestination(markerId) {
    selectedDestinationMarkerId = markerId;
    document.getElementById('destination-select').value = markerId;

    // Highlight marker
    document.querySelectorAll('.map-marker').forEach(el => el.classList.remove('marker-selected'));
    const selectedMarker = document.getElementById(markerId);
    if (selectedMarker) {
        selectedMarker.classList.add('marker-selected');
        showAlert(`ƒê√£ ch·ªçn: ${selectedMarker.title} l√†m ƒëi·ªÉm ƒë·∫øn.`);
    }
}

function changeFloor() {
  const f = document.getElementById('floor-select').value;
  const d = floorData[f];
  const mc = document.getElementById('map-container');
  mc.style.backgroundImage = `url(${d.bg})`;
  mc.querySelectorAll('.map-marker').forEach(e => e.remove());
  
  updateDestinationOptions(f);
  selectedDestinationMarkerId = null; // Reset selection on floor change
  
  d.markers.forEach(m => {
      const el = document.createElement('div'); el.id = m.id; el.className = `map-marker marker-${m.type}`;
      el.style.top = m.top; el.style.left = m.left; el.title = m.title;
      el.innerText = m.type === 'current' ? 'üìç' : (m.type === 'toilet' ? 'üöª' : (m.type === 'display' ? 'üñºÔ∏è' : '‚ÑπÔ∏è'));
      el.setAttribute('data-type', m.type);
      
      // Th√™m s·ª± ki·ªán click ƒë·ªÉ ch·ªçn ƒëi·ªÉm ƒë·∫øn
      if (m.type !== 'current') {
          el.onclick = () => selectDestination(m.id);
      }

      if(!activeFilters[m.type]) el.style.display='none';
      mc.appendChild(el);
  });
  
  const line = document.getElementById('path-line');
  line.style.display='none'; line.classList.remove('path-active');
  showAlert(`ƒê√£ chuy·ªÉn sang T·∫ßng ${f}`);
}

function toggleFilter(t) {
  activeFilters[t] = !activeFilters[t];
  document.getElementById(`filter-${t}`).classList.toggle('active');
  document.querySelectorAll(`.map-marker[data-type="${t}"]`).forEach(e => e.style.display = activeFilters[t] ? 'block' : 'none');
}

function findPath() {
    const destinationId = document.getElementById('destination-select').value;
    const currentFloor = document.getElementById('floor-select').value;
    const startMarker = document.getElementById('pos-current');
    const endMarker = document.getElementById(destinationId);

    if (!destinationId || !endMarker) {
        showAlert("Vui l√≤ng ch·ªçn m·ªôt ƒëi·ªÉm ƒë·∫øn tr∆∞·ªõc.");
        return;
    }

    const endFloor = endMarker.id.split('-')[1];

    if (currentFloor !== endFloor) {
        showAlert(`ƒêang chuy·ªÉn v·ªÅ T·∫ßng ${endFloor} ƒë·ªÉ t√¨m ƒë∆∞·ªùng...`);
        document.getElementById('floor-select').value = endFloor;
        changeFloor(); 
        
        // C·∫ßn ch·ªù DOM c·∫≠p nh·∫≠t sau khi g·ªçi changeFloor
        setTimeout(() => {
             const newStart = document.getElementById('pos-current');
             const newEnd = document.getElementById(destinationId);
             if(newStart && newEnd) _drawPath(newStart, newEnd);
        }, 300); 
    } else { 
        if (startMarker && endMarker) {
             _drawPath(startMarker, endMarker);
        } else {
             showAlert("Kh√¥ng t√¨m th·∫•y ƒëi·ªÉm b·∫Øt ƒë·∫ßu ho·∫∑c ƒëi·ªÉm k·∫øt th√∫c.");
        }
    }
}

function _drawPath(startEl, endEl) {
    const pathLine = document.getElementById('path-line');
    pathLine.style.display = 'none'; pathLine.classList.remove('path-active');

    const startX = startEl.offsetLeft + (startEl.offsetWidth / 2);
    const startY = startEl.offsetTop + (startEl.offsetHeight / 2);
    const endX = endEl.offsetLeft + (endEl.offsetWidth / 2);
    const endY = endEl.offsetTop + (endEl.offsetHeight / 2);

    const dx = endX - startX; const dy = endY - startY;
    const dist = Math.sqrt(dx * dx + dy * dy);
    const angle = Math.atan2(dy, dx) * 180 / Math.PI + 90;

    pathLine.style.transformOrigin = `top center`;
    pathLine.style.transform = `rotate(${angle}deg)`;
    pathLine.style.top = `${startY}px`; pathLine.style.left = `${startX - 2.5}px`; 
    pathLine.style.height = '0px'; 
    pathLine.style.transition = 'none'; pathLine.style.display = 'block';

    setTimeout(() => {
        pathLine.style.transition = 'height 1.5s ease-in-out';
        pathLine.style.height = `${dist}px`;
        pathLine.classList.add('path-active');
        showAlert("ƒê√£ t√¨m th·∫•y ƒë∆∞·ªùng! ƒêi theo v·∫°ch k·∫ª.");
    }, 50);
}

function resetMap() {
    document.getElementById('path-line').style.display='none';
    document.getElementById('destination-select').value = '';
    selectedDestinationMarkerId = null;
    document.querySelectorAll('.map-marker').forEach(el => el.classList.remove('marker-selected'));

    ['display','toilet','info','current'].forEach(t => { 
        activeFilters[t]=true; 
        const filterEl = document.getElementById(`filter-${t}`);
        if(filterEl) filterEl.classList.add('active'); 
    });
    changeFloor();
}

// Init
document.addEventListener('DOMContentLoaded', () => {
    // Kh√¥ng c·∫ßn loadKnowledgeBase n·ªØa
    setTimeout(changeFloor, 100);
    renderProfile(); // Kh·ªüi t·∫°o l·∫ßn ƒë·∫ßu
});

// Lang
function selectLang(l) { document.getElementById('lang-display').innerText = l==='vi'?'üåê VI':'üåê EN'; document.getElementById('lang-options').style.display='none'; }
function toggleLangOptions() { const o=document.getElementById('lang-options'); o.style.display=o.style.display==='flex'?'none':'flex'; }
</script>
</body>
</html>