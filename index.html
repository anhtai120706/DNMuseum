<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>B·∫£o t√†ng ƒê√† N·∫µng ‚Äì ·ª®ng d·ª•ng Th√¥ng minh</title>
<!-- ƒê√£ ƒë·ªïi sang Noto Sans cho ch·ªØ ƒë·∫πp v√† h·ªó tr·ª£ ti·∫øng Vi·ªát t·ªët h∆°n -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<!-- Th√™m th∆∞ vi·ªán Model Viewer ƒë·ªÉ xem 3D -->
<script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
<!-- Th√™m th∆∞ vi·ªán jsQR ƒë·ªÉ qu√©t m√£ QR -->
<script src="https://cdn.jsdelivr.net/npm/jsQR@1.1.0/dist/jsQR.min.js"></script>
<style>
/* --- 1. BI·∫æN V√Ä THI·∫æT L·∫¨P CHUNG --- */
:root {
  --primary-color: #2ecc71; /* Fresh Green */
  --primary-dark: #27ae60; /* Darker Green */
  --accent-color: #f39c12; /* Sun Yellow/Orange */
  --bg-light: #f5fcf5; /* Very light green background */
  --bg-card: #ffffff;
  --text-dark: #2c3e50; 
  --nav-active-bg: #eafaea; /* Lightest green for active nav */
}

body {
  background: var(--bg-light);
  /* ƒê√£ thay ƒë·ªïi: D√πng full viewport, s·ª≠ d·ª•ng Grid ƒë·ªÉ qu·∫£n l√Ω Screens */
  height: 100vh; /* Chi·∫øm full chi·ªÅu cao viewport */
  width: 100vw; /* Chi·∫øm full chi·ªÅu r·ªông viewport */
  margin: 0;
  padding: 0;
  display: grid; /* S·ª≠ d·ª•ng grid ƒë·ªÉ c√°c screens x·∫øp ch·ªìng l√™n nhau */
  place-items: stretch; /* ƒê·∫£m b·∫£o c√°c screens con cƒÉng ra */
  position: relative; /* Cho ph√©p ƒë·ªãnh v·ªã tuy·ªát ƒë·ªëi cho lang-icon */
  /* ƒê√£ c·∫≠p nh·∫≠t Font ch√≠nh */
  font-family: 'Noto Sans', sans-serif; 
}

/* KHUNG ·∫¢O (PHONE) ƒê√É B·ªä LO·∫†I B·ªé */
.phone {
    /* Lo·∫°i b·ªè l·ªõp phone, c√°c n·ªôi dung con ƒë∆∞·ª£c k√©o l√™n body */
    display: contents; 
}

.screen {
  background: var(--bg-light);
  width: 100%;
  height: 100%;
  /* Thay ƒë·ªïi: Lo·∫°i b·ªè border-radius c·ªë ƒë·ªãnh c·ªßa khung ƒëi·ªán tho·∫°i */
  border-radius: 0; 
  
  /* C·∫ßn ƒë·∫∑t grid-area ƒë·ªÉ m·ªói m√†n h√¨nh chi·∫øm c√πng 1 v·ªã tr√≠ (stacking) */
  grid-area: 1 / 1;
  
  /* Gi·ªØ l·∫°i c√°c thu·ªôc t√≠nh layout b√™n trong */
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  padding: 10px;
  box-sizing: border-box;
  color: var(--text-dark);
  transition: all 0.4s ease-in-out;
  overflow: hidden;
  position: relative;
}

.login-screen { justify-content: center; }
.hidden { display: none; }

h2 { font-size: 24px; font-weight: 700; margin-bottom: 12px; color: var(--primary-dark); }
h3 { 
  font-size: 20px; 
  font-weight: 600; 
  margin: 15px 0 10px; 
  color: var(--primary-dark); 
  border-bottom: 3px solid var(--accent-color); 
  padding-bottom: 8px;
  width: 95%;
  text-align: center;
}
h4 { font-size: 16px; font-weight: 600; margin-bottom: 8px; color: var(--primary-dark); }
p { font-size: 14px; color: #555; margin-bottom: 5px; text-align: justify; line-height: 1.5; }
ul { padding-left: 20px; text-align: left; }

/* --- 2. N√öT V√Ä INPUT --- */
button {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
  color: white;
  border: none;
  border-radius: 14px;
  padding: 14px 25px;
  margin: 8px 0;
  font-size: 16px;
  cursor: pointer;
  transition: 0.3s ease;
  font-weight: 600;
  box-shadow: 0 6px 20px rgba(46, 204, 113, 0.3); 
}
button:hover { transform: translateY(-2px) scale(1.01); box-shadow: 0 8px 25px rgba(46, 204, 113, 0.4); }
button:active { transform: translateY(0); box-shadow: 0 4px 15px rgba(46, 204, 113, 0.2); }

input[type="text"], select {
  padding: 12px;
  border-radius: 12px;
  border: 1px solid #ccc;
  width: 95%;
  margin-bottom: 15px; 
  font-size: 15px;
  outline: none;
  transition: all 0.3s;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
}
input[type="text"]:focus, select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.2); }

/* --- 3. THANH ƒêI·ªÄU H∆Ø·ªöNG --- */
.bottom-nav {
  display: flex;
  justify-content: space-around;
  align-items: center;
  background: var(--bg-card);
  padding: 10px 0;
  /* Thay ƒë·ªïi: Lo·∫°i b·ªè border-radius c·ªë ƒë·ªãnh d∆∞·ªõi c√πng c·ªßa khung ƒëi·ªán tho·∫°i */
  border-radius: 0; 
  width: 100%;
  box-shadow: 0 -5px 20px rgba(0,0,0,0.1); 
  border-top: 1px solid #eee;
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 11px;
  font-weight: 500;
  color: #7f8c8d;
  transition: all 0.3s;
  padding: 8px 10px;
  border-radius: 100px;
  min-width: 60px;
}
.nav-item span { font-size: 28px; margin-bottom: 2px; }
.nav-item.active { 
  color: var(--primary-dark);
  font-weight: 600;
  background-color: var(--nav-active-bg);
  box-shadow: 0 2px 10px rgba(46, 204, 113, 0.2);
  transform: translateY(-2px);
}
.nav-item.active span { color: var(--primary-dark); transform: scale(1.05); }

/* --- 4. N·ªòI DUNG CH√çNH --- */
.tab-content {
  flex: 1;
  width: 100%;
  overflow-y: auto;
  display: none;
  flex-direction: column;
  align-items: center;
  padding: 5px;
  box-sizing: border-box;
}
.active-tab { display: flex; animation: fadeInUp 0.5s ease-out; }

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.info-card { 
  background: var(--bg-card);
  border-radius: 16px;
  padding: 15px;
  width: 95%;
  margin-bottom: 15px;
  text-align: left;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  border-left: 5px solid var(--accent-color);
  transition: transform 0.3s;
}
.achievement-card {
    background: #eafaea; 
    border-left: 5px solid var(--primary-dark);
    text-align: center;
    padding: 15px;
}
.achievement-card h4 {
    margin-top: 0;
    color: var(--primary-dark);
}
.achievement-card p {
    text-align: center;
    color: var(--text-dark);
}
.quiz-question {
    background: var(--bg-card);
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.quiz-option {
    display: block;
    width: 100%;
    text-align: left;
    background: #f7f7f7;
    color: var(--text-dark);
    border: 1px solid #ddd;
    padding: 10px;
    margin: 5px 0;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
    font-size: 14px;
}
.quiz-option:hover { background: #eee; }
.correct-answer { background: #c8e6c9 !important; border-color: #388e3c !important; color: #1b5e20 !important; font-weight: 600; }
.incorrect-answer { background: #ffcdd2 !important; border-color: #d32f2f !important; color: #b71c1c !important; font-weight: 600; } /* ƒê√£ th√™m font-weight 600 */

.quiz-result-message {
    padding: 10px;
    border-radius: 8px;
    margin-top: 10px;
    font-weight: 600;
    text-align: center;
}
.quiz-success {
    background-color: #d1e5d4;
    color: #1b5e20;
}
.quiz-fail {
    background-color: #ffcdd2;
    color: #b71c1c;
}


.login-card {
  background: var(--bg-card);
  border-radius: 25px;
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15); 
  padding: 30px 25px;
  width: 85%;
  max-width: 350px;
  text-align: center;
}

/* --- 5. CHATBOT --- */
.chat-window {
  background: var(--bg-light); 
  border: 1px solid #eee;
}
.chat-message { 
  font-size: 14px; 
  margin-bottom: 10px; 
  padding: 10px 14px; 
  border-radius: 18px; 
  display: inline-block; 
  max-width: 85%;
  transition: all 0.3s;
}
.user-msg { 
    background: var(--primary-color); 
    color: #fff; 
    float: right; 
    border-radius: 18px 18px 0 18px; 
    box-shadow: 0 2px 8px rgba(46, 204, 113, 0.3);
}
.ai-msg { 
    background: #e3f2fd; 
    color: var(--text-dark); 
    float: left; 
    border-radius: 18px 18px 18px 0; 
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}
.chat-window::after { content: ""; display: table; clear: both; }

#loader {
    /* ƒê√£ lo·∫°i b·ªè, kh√¥ng c·∫ßn loading v√¨ kh√¥ng g·ªçi API */
    display: none; 
    border: 4px solid #f3f3f3; 
    border-top: 4px solid var(--primary-color); 
    border-radius: 50%;
    width: 20px; height: 20px;
    animation: spin 1s linear infinite;
    margin: 5px;
    float: left;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* --- Quick Question Buttons --- */
#quick-questions {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
    width: 95%;
    margin-bottom: 10px;
}
.quick-q-btn {
    background: #ffffff;
    color: var(--primary-dark);
    border: 1px solid var(--primary-color);
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 12px;
    cursor: pointer;
    transition: 0.3s;
    flex-grow: 1;
    min-width: 100px;
    max-width: 48%;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.quick-q-btn:hover {
    background: var(--primary-color);
    color: white;
    box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);
}

/* --- 6. QR SCANNER & VIDEO PLAYER & 3D --- */
#camera-preview {
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
    border-radius: 12px;
}
#camera-wrapper {
    width: 90%; 
    height: 240px; 
    margin-top: 15px; 
    position: relative;
}
#camera-canvas {
    position: absolute; top: 0; left: 0; z-index: 5;
    display: none; /* D√πng ƒë·ªÉ hi·ªÉn th·ªã k·∫øt qu·∫£ qu√©t */
}

.scanner-frame {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 70%; height: 70%; border: 3px solid var(--accent-color);
    box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.6); pointer-events: none; z-index: 10;
}
.scanner-line {
    position: absolute; left: 0; width: 100%; height: 4px;
    background: #ff4081; box-shadow: 0 0 15px #ff4081;
    animation: scan 2s infinite linear;
}
@keyframes scan { 0% { top: 0%; } 50% { top: 100%; } 100% { top: 0%; } }

#qr-result { border-left: 5px solid var(--primary-color); background: var(--nav-active-bg); }

/* Video Player Style - CONTAINER n√†y kh√¥ng c√≤n d√πng ƒë·ªÉ ph√°t video n·ªØa, ch·ªâ ƒë·ªÉ gi·ªØ c·∫•u tr√∫c */
#video-container {
    width: 100%;
    margin-top: 10px;
    display: none; 
    background: black;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
/* X√≥a style cho #artifact-video v√¨ ƒë√£ lo·∫°i b·ªè th·∫ª <video> */

/* 3D Viewer Container */
#artifact-360-display {
    width: 100%; 
    height: 300px; 
    background: #f0f0f0; 
    margin-top: 10px; 
    display: none; 
    border-radius: 12px; 
    position: relative;
    overflow: hidden;
    border: 1px solid #ccc;
}

/* --- 7. MAP UI --- */
#map-container { 
    position: relative; width: 95%; height: 350px; border-radius: 12px; overflow: hidden; margin-bottom: 15px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.15); background-color: #ecf0f1; background-size: cover; background-position: center; border: 1px solid #ddd;
}
.map-marker { 
    position: absolute; font-size: 24px; cursor: pointer;
    transition: transform 0.3s, opacity 0.3s; filter: drop-shadow(1px 1px 3px rgba(0,0,0,0.4));
}
.map-marker:hover { transform: scale(1.2); z-index: 20; }
.marker-current { color: #3498db; animation: pulse-dot 1.5s infinite ease-out; font-size: 30px; }
@keyframes pulse-dot { 0% { transform: scale(0.8); opacity: 0.9; } 50% { transform: scale(1.1); opacity: 0.6; } 100% { transform: scale(0.8); opacity: 0.9; } }
.marker-toilet { color: #e74c3c; } /* ƒê·ªïi m√†u WC */
.marker-display { color: var(--accent-color); } /* ƒê·ªïi m√†u Display */
.marker-info { color: var(--primary-dark); } /* ƒê·ªïi m√†u Info */ 

.marker-selected {
    box-shadow: 0 0 0 5px rgba(243, 156, 18, 0.5); 
    border-radius: 50%;
}

#path-line {
    position: absolute; width: 5px; background: linear-gradient(to bottom, var(--primary-dark), #3498db);
    box-shadow: 0 0 15px rgba(46, 204, 113, 0.7); border-radius: 3px; z-index: 10; pointer-events: none; display: none;
}
.path-active { animation: path-glow 0.8s infinite alternate; }
@keyframes path-glow { from { opacity: 0.8; } to { opacity: 1; } }

.map-filters {
    display: flex;
    justify-content: space-around;
    align-items: center;
    width: 95%;
    background: var(--bg-card);
    padding: 10px 0;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    margin-bottom: 15px;
    border: 1px solid #eee;
}
.filter-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    opacity: 0.6;
    font-size: 12px;
}
.filter-item.active {
    opacity: 1;
    font-weight: 600;
    transform: scale(1.05);
}
.filter-item span { font-size: 20px; }

/* Lang */
/* ƒê√£ thay ƒë·ªïi: D√πng fixed position ƒë·ªÉ n√≥ kh√¥ng b·ªã tr√¥i v√† kh√¥ng ph·ª• thu·ªôc v√†o khung phone */
#lang-icon { 
    position: fixed; 
    top: 20px; 
    right: 20px; 
    z-index: 100; cursor: pointer; background: white; padding: 6px 12px; border-radius: 20px; box-shadow: 0 3px 10px rgba(0,0,0,0.15); font-weight: 600; display: flex; align-items: center; 
}
#lang-options { 
    position: fixed; 
    top: 55px; 
    right: 20px; 
    display: none; flex-direction: column; z-index: 101; background: white; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.3); padding: 5px; min-width: 150px; 
}

/* NEW: Sub-Tab Navigation for Profile */
.sub-nav {
    display: flex;
    justify-content: space-around;
    width: 95%;
    margin-bottom: 15px;
    background: var(--bg-card);
    border-radius: 12px;
    padding: 5px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}
.sub-nav-item {
    flex: 1;
    text-align: center;
    padding: 10px 5px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    color: #7f8c8d;
    transition: all 0.2s;
}
.sub-nav-item.active {
    background: var(--primary-color);
    color: white;
    box-shadow: 0 2px 10px rgba(46, 204, 113, 0.4);
    font-weight: 600;
}

/* NEW: Containers for sub-tabs */
.sub-tab-content {
    display: none;
    width: 95%;
    text-align: left;
    animation: fadeIn 0.3s ease-out;
}
.sub-tab-content.active {
    display: block;
}
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* NEW: Styling for the Profile Info Block to look like a button */
.profile-info-block {
    background: var(--bg-card);
    border-radius: 16px;
    padding: 15px;
    width: 95%;
    margin-bottom: 15px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    border: 1px solid #ddd;
    cursor: pointer; /* Th√™m cursor pointer ƒë·ªÉ tr√¥ng gi·ªëng n√∫t */
    transition: background-color 0.2s;
}
.profile-info-block:hover {
    background-color: #f0f0f0;
}

/* NEW: Style cho Quiz Standalone Screen */
.quiz-standalone-content {
    /* ƒê√É S·ª¨A: B·ªè max-width ƒë·ªÉ s·ª≠ d·ª•ng h·∫øt 95% */
    width: 95%;
    /* ƒê√É S·ª¨A: ƒê·∫∑t max-height ƒë·ªÉ cu·ªôn ƒë∆∞·ª£c */
    max-height: 90%; 
    overflow-y: auto;
    padding: 15px; /* Gi·∫£m padding ƒë·ªÉ tƒÉng kh√¥ng gian hi·ªÉn th·ªã */
    background: var(--bg-card);
    border-radius: 16px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.1);
    margin-top: 10px;
    box-sizing: border-box; /* Quan tr·ªçng ƒë·ªÉ padding kh√¥ng l√†m tƒÉng width */
}
/* ƒê√É X√ìA: CSS cho h4 c·ªßa quiz-standalone-content v√¨ th·∫ª h4 ƒë√£ b·ªã x√≥a */
/*
.quiz-standalone-content h4 { 
    text-align: center; 
    color: var(--primary-dark); 
    font-size: 24px; 
    font-weight: 700; 
    border-bottom: 3px solid var(--accent-color);
    padding-bottom: 8px;
    margin-bottom: 20px;
    width: 100%;
}
*/
.quiz-standalone-content .quiz-question h4 {
    /* Ti√™u ƒë·ªÅ c√¢u h·ªèi (1. Tr·∫ßn H∆∞ng ƒê·∫°o...) ph·∫£i n·∫±m tr√™n v√† cƒÉn tr√°i */
    text-align: left;
    border-bottom: none;
    padding-bottom: 0;
    margin-bottom: 8px;
    width: 100%;
    color: var(--primary-dark); /* ƒê·ªïi m√†u ƒë·ªÉ n·ªïi b·∫≠t h∆°n */
    font-size: 18px; /* TƒÉng k√≠ch th∆∞·ªõc c√¢u h·ªèi */
}
</style>
</head>
<body>
<!-- ƒê√É LO·∫†I B·ªé KHUNG <div class="phone"> ƒë·ªÉ ·ª©ng d·ª•ng chi·∫øm to√†n m√†n h√¨nh -->

  <!-- Language control -->
  <div id="lang-icon" onclick="toggleLangOptions()">
      <span id="lang-display">üåê VI</span>
  </div>
  <div id="lang-options">
    <button onclick="selectLang('vi')">Ti·∫øng Vi·ªát (VI)</button>
    <button onclick="selectLang('en')">English (EN)</button>
  </div>

  <!-- WIFI Screen -->
  <div class="screen login-screen" id="wifi-screen">
    <div class="login-card">
      <h2>üì∂ K·∫øt n·ªëi Wi-Fi</h2>
      <p>Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi ·ª©ng d·ª•ng tham quan th√¥ng minh!</p>
      <button onclick="goToLogin()">K·∫øt n·ªëi Wi-Fi</button>
    </div>
  </div>

  <!-- LOGIN Screen -->
  <div class="screen hidden login-screen" id="login-screen">
    <div class="login-card">
      <h2>üéüÔ∏è ƒêƒÉng nh·∫≠p</h2>
      <p>Nh·∫≠p m√£ v√© ho·∫∑c qu√©t QR ƒë·ªÉ v√†o ·ª©ng d·ª•ng.</p>
      <input type="text" id="ticket-input" placeholder="Nh·∫≠p m√£ v√©...">
      <button onclick="goToMain()">ƒêƒÉng nh·∫≠p</button>
      <button onclick="goToMain()" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); box-shadow: 0 6px 20px rgba(243, 156, 18, 0.3);">üì∑ Qu√©t m√£ QR</button>
    </div>
  </div>

  <!-- QUIZ STANDALONE SCREEN (M√ÄN H√åNH QUIZ RI√äNG) -->
  <div class="screen hidden" id="quiz-standalone-screen" style="justify-content: flex-start; padding-top: 20px;">
    <button onclick="backToQrTab()" style="width: 95%; margin-bottom: 15px; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 10px 25px;">
        ‚¨ÖÔ∏è Quay l·∫°i Hi·ªán v·∫≠t
    </button>
    
    <div class="quiz-standalone-content" id="quiz-section-standalone">
        <!-- N·ªôi dung Quiz s·∫Ω ƒë∆∞·ª£c render v√†o ƒë√¢y b·∫±ng JS -->
        <!-- ƒê√É X√ìA: h4 id="quiz-title-standalone" -->
        <div id="quiz-content-standalone">
            <p id="quiz-initial-message-standalone" style="text-align: center; color: #7f8c8d;">ƒêang t·∫£i Quiz...</p>
            <div id="quiz-question-container-standalone"></div>
            <button id="quiz-submit-button-standalone" onclick="submitArtifactQuiz('standalone')" style="display:none; width:100%; margin-top: 15px; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">Ho√†n th√†nh Quiz</button>
            <div id="quiz-feedback-standalone" class="quiz-result-message" style="display: none;"></div>
        </div>
    </div>
  </div>

  <!-- MAIN SCREEN -->
  <div class="screen hidden" id="main-screen">
    <input type="text" id="search-input" placeholder="üîç T√¨m khu tr∆∞ng b√†y, hi·ªán v·∫≠t..." style="width:95%; margin:5px 0 10px; padding:10px; border-radius:12px; border:1px solid #ccc;">

    <!-- Intro Tab -->
    <div class="tab-content active-tab" id="intro-tab">
      <h3>üèõÔ∏è Th√¥ng tin Chung</h3>
      <div class="info-card">
        <h4>1. Gi·ªù m·ªü c·ª≠a & Gi√° v√©</h4>
        <p>M·ªü c·ª≠a: 7:30 - 17:00 h√†ng ng√†y.</p>
        <p>Gi√° v√©: 40.000ƒë (Ng∆∞·ªùi l·ªõn), 20.000ƒë (Sinh vi√™n).</p>
      </div>
      <div class="info-card">
        <h4>2. S∆° ƒë·ªì tham quan</h4>
        <p>T·∫ßng 1: Ti·ªÅn s·ª≠ & C·ªï v·∫≠t.</p>
        <p>T·∫ßng 2: L·ªãch s·ª≠ chi·∫øn tranh.</p>
        <p>T·∫ßng 3: VƒÉn h√≥a & D√¢n t·ªôc h·ªçc.</p>
      </div>
    </div>

    <!-- Chatbot Tab (AI MOCKUP - KH√îNG D√ôNG API) -->
    <div class="tab-content" id="chat-tab">
      <h3>üí¨ Chatbot AI (M√¥ ph·ªèng)</h3>
      <div id="kb-status" style="font-size: 11px; color: var(--primary-dark); margin-bottom: 5px;">‚úÖ ƒêang ·ªü ch·∫ø ƒë·ªô m√¥ ph·ªèng tr·∫£ l·ªùi t·ª©c th√¨ (Instant Mock Response).</div>
      
      <!-- Khu v·ª±c c√¢u h·ªèi m·∫´u -->
      <div id="quick-questions">
        <button class="quick-q-btn" onclick="prefillAndSend('Ti·ªÉu s·ª≠ Tr·∫ßn H∆∞ng ƒê·∫°o?')">Ti·ªÉu s·ª≠ Tr·∫ßn H∆∞ng ƒê·∫°o?</button>
        <button class="quick-q-btn" onclick="prefillAndSend('T√°c ph·∫©m n·ªïi ti·∫øng nh·∫•t c·ªßa Tr·∫ßn H∆∞ng ƒê·∫°o?')">T√°c ph·∫©m n·ªïi ti·∫øng nh·∫•t c·ªßa √¥ng?</button>
        <button class="quick-q-btn" onclick="prefillAndSend('Tr·∫≠n chi·∫øn B·∫°ch ƒê·∫±ng di·ªÖn ra khi n√†o?')">Tr·∫≠n chi·∫øn B·∫°ch ƒê·∫±ng di·ªÖn ra khi n√†o?</button>
        <button class="quick-q-btn" onclick="prefillAndSend('√ù nghƒ©a c√¢u n√≥i \"B·ªá h·∫° ch√©m ƒë·∫ßu th·∫ßn r·ªìi h√£y h√†ng\"?')">√ù nghƒ©a c√¢u n√≥i n·ªïi ti·∫øng c·ªßa √¥ng?</button>
      </div>

      <div class="chat-window" id="chat-window" style="flex-grow: 1; width: 95%; max-height: 440px; overflow-y: auto; padding: 10px; margin-bottom: 5px; border-radius: 12px; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); text-align: left;">
        <!-- ƒê√£ s·ª≠a: X√≥a k√Ω t·ª± ü§ñ v√† in ƒë·∫≠m kh√¥ng c·∫ßn thi·∫øt -->
        <div class='chat-message ai-msg'>Xin ch√†o! T√¥i ƒëang ·ªü ch·∫ø ƒë·ªô m√¥ ph·ªèng. B·∫°n c√≥ th·ªÉ h·ªèi t√¥i c√°c c√¢u h·ªèi m·∫´u v·ªÅ Tr·∫ßn H∆∞ng ƒê·∫°o ho·∫∑c g√µ c√¢u h·ªèi b·∫•t k·ª≥ ƒë·ªÉ xem ph·∫£n h·ªìi ƒë∆∞·ª£c l·∫≠p tr√¨nh s·∫µn!</div>
      </div>
      
      <div id="loader" style="display:none; margin-top: 10px;"></div>
      <input type="text" id="chat-input" placeholder="H·ªèi t√¥i b·∫•t c·ª© ƒëi·ªÅu g√¨..." onkeydown="if(event.key==='Enter'){sendMessage();}">
      <button id="send-btn" onclick="sendMessage()">G·ª≠i</button>
    </div>

    <!-- QR Tab (Full Features with REAL SCANNING) -->
    <div class="tab-content" id="qr-tab">
      <h3>üì∑ Qu√©t QR Th√¥ng minh</h3>
      <div id="camera-wrapper">
          <!-- Video element to capture camera stream -->
          <video id="camera-preview" autoplay playsinline style="display: none;"></video>
          <!-- Canvas for processing video frame and drawing QR bounds -->
          <canvas id="camera-canvas"></canvas>
          <!-- Scanner Frame -->
          <div id="scanner-line-wrapper" class="hidden" style="position: absolute; width: 100%; height: 100%; top: 0; left: 0;">
             <div class="scanner-frame"></div>
             <div class="scanner-line"></div>
          </div>
          <div id="camera-placeholder" style="width: 100%; height: 100%; background: #2c3e50; border-radius: 12px; display: flex; justify-content: center; align-items: center; color: #fff; font-size: 16px; font-weight: 600;">CH∆ØA KH·ªûI ƒê·ªòNG CAMERA</div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 15px; width: 95%;">
        <button id="scan-button" onclick="startCamera()" style="flex: 1; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">B·∫Øt ƒë·∫ßu qu√©t</button>
        <button id="stop-button" onclick="stopCamera()" style="display: none; flex: 1; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">Ng·ª´ng Camera</button>
      </div>

      <!-- N√∫t m√¥ ph·ªèng nhanh Hi·ªán v·∫≠t Tr·∫ßn H∆∞ng ƒê·∫°o -->
      <button onclick="mockScanArtifact1()" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); width: 95%; margin-top: 10px; padding: 10px 25px; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);">
          ‚ö° Xem Hi·ªán v·∫≠t m·∫´u: T∆∞·ª£ng Tr·∫ßn H∆∞ng ƒê·∫°o
      </button>

      <!-- K·∫øt qu·∫£ Qu√©t -->
      <div id="qr-result" style="display:none; flex-direction:column; margin-top:15px; width:95%; padding:15px; border-radius:12px; text-align: left; background:var(--nav-active-bg); box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
        <h4 id="data-title" style="color:var(--primary-dark); margin-bottom: 10px;">Th√¥ng tin ƒë√£ qu√©t: ...</h4>
        <div id="scanned-details" style="font-size: 14px; margin-bottom: 10px;"></div>
        
        <div id="interaction-buttons" style="display: flex; justify-content: center; width: 100%; margin-top: 5px; gap: 10px;">
          <!-- ƒê√£ ƒë·ªïi id ƒë·ªÉ d·ªÖ d√†ng ph√¢n bi·ªát, gi·ªù l√† youtube-button -->
          <button id="youtube-button" onclick="playVideoPresentation()" style="display: none; flex: 1; padding: 10px 15px; border-radius: 10px; font-size: 14px;">‚ñ∂Ô∏è Xem thuy·∫øt tr√¨nh</button>
          <button id="view360-button" onclick="view360()" style="display: none; flex: 1; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 10px 15px; border-radius: 10px; font-size: 14px;">üåÄ Xem 360¬∞ / AR</button>
        </div>
        
        <!-- VIDEO PLAYER CONTAINER: Lo·∫°i b·ªè video player c≈© -->
        <div id="video-container" style="display:none;">
            <!-- Ph·∫ßn t·ª≠ <video> ƒë√£ b·ªã x√≥a -->
        </div>

        <!-- 3D VIEWER CONTAINER -->
        <div id="artifact-360-display">
            <p style="text-align:center; margin-top: 130px; color: #999;">ƒêang t·∫£i m√¥ h√¨nh...</p>
        </div>
        
        <!-- N√öT B·∫ÆT ƒê·∫¶U QUIZ M·ªöI -->
        <button id="start-quiz-button-qr" onclick="handleStartQuiz()" style="display:none; width: 100%; margin-top: 15px; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
            ‚ùì B·∫Øt ƒë·∫ßu Quiz Hi·ªán v·∫≠t
        </button>
        
      </div>
      
      <!-- NEW: Khu v·ª±c Quiz t·∫°i hi·ªán v·∫≠t (hi·ªán trong QR tab) -->
      <!-- ƒê√É X√ìA SECTION N√ÄY V√Ä CHUY·ªÇN LOGIC SANG M√ÄN H√åNH RI√äNG #quiz-standalone-screen -->
      
    </div>

    <!-- Map Tab (N√¢ng c·∫•p) -->
    <div class="tab-content" id="map-tab">
      <h3>üó∫Ô∏è B·∫£n ƒë·ªì & H∆∞·ªõng d·∫´n</h3>
      <select id="floor-select" onchange="changeFloor()" style="margin-bottom:15px; padding: 10px; border-radius: 10px; width: 95%;">
        <option value="1">T·∫ßng 1 - C·ªï v·∫≠t & Ti·∫øp ƒë√≥n</option>
        <option value="2">T·∫ßng 2 - L·ªãch s·ª≠ & Kh√°ng chi·∫øn</option>
        <option value="3">T·∫ßng 3 - VƒÉn h√≥a & Ph√°t tri·ªÉn</option>
      </select>
      
      <!-- ƒêi·ªÉm ƒë·∫øn Selector -->
      <select id="destination-select" style="margin-bottom:15px; padding: 10px; border-radius: 10px; width: 95%;">
        <option value="" selected>Ch·ªçn ƒëi·ªÉm ƒë·∫øn...</option>
      </select>
      
      <div class="map-filters">
        <div class="filter-item active" id="filter-display" onclick="toggleFilter('display')"><span>üñºÔ∏è</span>Tr∆∞ng b√†y</div>
        <div class="filter-item active" id="filter-toilet" onclick="toggleFilter('toilet')"><span>üöª</span>WC</div>
        <div class="filter-item active" id="filter-info" onclick="toggleFilter('info')"><span>‚ÑπÔ∏è</span>Th√¥ng tin</div>
        <div class="filter-item active" id="filter-current" onclick="toggleFilter('current')"><span>üìç</span>B·∫°n</div>
      </div>
      
      <div id="map-container">
        <div id="path-line"></div>
        <!-- Markers added via JS -->
      </div>
      
      <div style="display: flex; gap: 10px; width: 95%; margin-top: 5px;">
        <button onclick="findPath()" style="flex: 1; background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);">‚û°Ô∏è D·∫´n ƒë∆∞·ªùng</button>
        <button onclick="resetMap()" style="flex: 1; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">üîÑ ƒê·∫∑t l·∫°i</button>
      </div>
      <div id="ai-guide" style="background: linear-gradient(45deg, var(--primary-color), #4d89ff); color: white; padding: 12px; width: 95%; border-radius: 12px; font-size: 14px; margin-top: 15px;">ü§ñ G·ª£i √Ω: T·∫ßng 1 ƒëang ƒë√¥ng kh√°ch.</div>
    </div>

    <!-- Profile Tab (ƒê√£ c·∫≠p nh·∫≠t - Lo·∫°i b·ªè Quiz) -->
    <div class="tab-content" id="profile-tab">
      <h3>üë§ H·ªì s∆° & Th√†nh t√≠ch</h3>
      
      <!-- NEW: Profile Main View -->
      <div id="profile-main-view" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
          
          <!-- TH·∫∫ TH√îNG TIN C√Å NH√ÇN (C√ì TH·ªÇ NH·∫§N V√ÄO ƒë·ªÉ toggle ch·ªânh s·ª≠a) -->
          <div class="profile-info-block" id="profile-info-card" onclick="toggleEditProfile()">
             <div id="profile-view-mode">
                 <div style="font-size: 18px; font-weight: 700; color: var(--primary-dark); margin-bottom: 5px;">
                     M√£ v√©: <span style="color: var(--accent-color);">123456</span>
                 </div>
                 <p style="text-align: center; margin: 2px 0;">H·ªç t√™n: <b id="display-username">Nguy·ªÖn VƒÉn A</b></p>
                 <p style="text-align: center; margin: 2px 0; font-size: 12px; color: #7f8c8d;">Th·ªùi gian: 14:30 15/07/2025</p>
                 <button onclick="event.stopPropagation(); toggleEditProfile();" style="padding: 8px 15px; font-size: 14px; margin-top: 10px; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                     ‚öôÔ∏è S·ª≠a H·ªì s∆°
                 </button>
             </div>
             
             <!-- KH·∫ÆC PH·ª§C L·ªñI: Th√™m onclick="event.stopPropagation()" v√†o ƒë√¢y ƒë·ªÉ ngƒÉn click v√†o input l√†m ·∫©n ch·∫ø ƒë·ªô ch·ªânh s·ª≠a -->
             <div id="profile-edit-mode" style="display:none; text-align: center;" onclick="event.stopPropagation()">
                 <h4 style="margin-top: 0;">Ch·ªânh s·ª≠a H·ªì s∆°</h4>
                 <label for="edit-username" style="font-size: 14px; display: block; margin-bottom: 5px;">H·ªç t√™n:</label>
                 <input type="text" id="edit-username" placeholder="Nh·∫≠p t√™n m·ªõi" style="width: 80%; margin-bottom: 10px; padding: 8px;">
                 <div style="display: flex; justify-content: center; gap: 10px;">
                    <button onclick="event.stopPropagation(); saveProfile();" style="flex: 1; padding: 10px 15px; font-size: 14px;">
                        üíæ L∆∞u
                    </button>
                    <button onclick="event.stopPropagation(); toggleEditProfile();" style="flex: 1; padding: 10px 15px; font-size: 14px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                        ‚ùå H·ªßy
                    </button>
                 </div>
             </div>

          </div>

          <!-- PH·∫¶N TH∆Ø·ªûNG ƒê∆Ø·ª¢C N√ÇNG C·∫§P -->
          <div class="info-card achievement-card" id="reward-card">
            <h4>üèÜ Th√†nh t√≠ch Quiz & Ph·∫ßn th∆∞·ªüng</h4>
            <p>ƒêi·ªÉm Quiz ƒê√∫ng: <b id="quiz-score">0</b>/<span id="quiz-total-score">0</span></p>
            <div id="reward-status-display">
                <!-- N·ªôi dung ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·∫±ng JS -->
                <p id="reward-status">T√≠ch l≈©y ƒëi·ªÉm Quiz ƒë·ªÉ nh·∫≠n ph·∫ßn th∆∞·ªüng h·∫•p d·∫´n!</p>
            </div>
          </div>
          
          <!-- NEW: Button to trigger the History sub-screen -->
          <button onclick="showHistoryQuizView()" style="width: 95%; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
              üîç Xem L·ªãch s·ª≠ Qu√©t
          </button>
      </div>
      
      <!-- NEW: Artifact History Sub-View (Lo·∫°i b·ªè Quiz) -->
      <div id="artifact-history-quiz-view" style="width: 100%; display: none; flex-direction: column; align-items: center;">
          
          <!-- Back button -->
          <button onclick="backToProfileMain()" style="width: 95%; background: linear-gradient(135deg, #c0c0c0 0%, #999999 100%); color: var(--text-dark); margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.15);">
              ‚¨ÖÔ∏è Quay l·∫°i H·ªì s∆°
          </button>
          
          <!-- SUB-NAVIGATION BAR (Ch·ªâ c√≤n L·ªãch s·ª≠) -->
          <div class="sub-nav">
              <div class="sub-nav-item active" onclick="showSubTab('history')">üìç L·ªãch s·ª≠ Q.R</div>
          </div>
          
          <!-- Old Combined Card Content -->
          <div class="info-card" id="history-quiz-combined-area" style="border-left: 5px solid var(--primary-dark); padding: 0; width: 95%;">
            
            <!-- History Section (TAB 1) -->
            <div id="sub-tab-history" class="sub-tab-content active">
                <div style="padding: 15px;">
                    <h4>üìç ƒê·ªãa ƒëi·ªÉm ƒë√£ tham quan (Qu√©t QR)</h4>
                    <ul id="visited-locations" style="list-style-type: disc; margin-left: 15px; margin-bottom: 5px;">
                      <!-- Items added via JS -->
                      <li>(Ch∆∞a c√≥)</li>
                    </ul>
                </div>
            </div>
            
          </div>
          
      </div>

      <button onclick="logout()">ƒêƒÉng xu·∫•t</button>
    </div>

    <!-- Bottom nav -->
    <div class="bottom-nav">
      <div class="nav-item" id="nav-intro" onclick="showTab('intro-tab')"><span>üèõÔ∏è</span>Gi·ªõi thi·ªáu</div>
      <div class="nav-item" id="nav-chat" onclick="showTab('chat-tab')"><span>üí¨</span>Chatbot</div>
      <div class="nav-item" id="nav-qr" onclick="showTab('qr-tab')"><span>üì∑</span>Qu√©t QR</div>
      <div class="nav-item" id="nav-map" onclick="showTab('map-tab')"><span>üó∫Ô∏è</span>B·∫£n ƒë·ªì</div>
      <div class="nav-item" id="nav-profile" onclick="showTab('profile-tab')"><span>üë§</span>H·ªì s∆°</div>
    </div>
  </div>
<!-- ƒê√É LO·∫†I B·ªé KHUNG <div class="phone"> -->

<script>
/* ==========================================================================
   D·ªÆ LI·ªÜU C√Å NH√ÇN (M·ªöI)
   ========================================================================== */
let profileData = {
    ticket: "123456",
    username: "Nguy·ªÖn VƒÉn A",
    time: "14:30 15/07/2025"
};
let isEditingProfile = false;

// H√†m c·∫≠p nh·∫≠t th√¥ng tin hi·ªÉn th·ªã c·ªßa profile
function updateProfileDisplay() {
    document.getElementById('display-username').innerText = profileData.username;
    document.getElementById('edit-username').value = profileData.username;
}

// H√†m chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
function toggleEditProfile() {
    isEditingProfile = !isEditingProfile;
    const viewMode = document.getElementById('profile-view-mode');
    const editMode = document.getElementById('profile-edit-mode');
    
    if (isEditingProfile) {
        viewMode.style.display = 'none';
        editMode.style.display = 'block';
    } else {
        viewMode.style.display = 'block';
        editMode.style.display = 'none';
        // ƒê·∫£m b·∫£o input c√≥ gi√° tr·ªã hi·ªán t·∫°i khi h·ªßy
        document.getElementById('edit-username').value = profileData.username;
    }
}

// H√†m l∆∞u h·ªì s∆°
function saveProfile() {
    const newUsername = document.getElementById('edit-username').value.trim();
    if (newUsername.length > 0) {
        profileData.username = newUsername;
        updateProfileDisplay();
        toggleEditProfile(); // Tho√°t ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
        showAlert("ƒê√£ l∆∞u H·ªì s∆° th√†nh c√¥ng!");
    } else {
        showAlert("T√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!");
    }
}

/* ==========================================================================
   D·ªÆ LI·ªÜU GAMEFICATION 
   ========================================================================== */
let visitedArtifacts = []; // Array of { id: string, name: string }
let quizScore = 0;
let quizTotalQuestions = 0; // T·ªïng s·ªë c√¢u h·ªèi ƒë√£ l√†m (ch·ª© kh√¥ng ph·∫£i t·ªïng s·ªë c√¢u h·ªèi c√≥ s·∫µn)
let artifactQuizStatus = {}; // { artifact_id: boolean (true if done), score: number, selections: {} }

const REWARD_THRESHOLD = 10; // ƒê√£ c·∫≠p nh·∫≠t th√†nh 10 (t·ªïng s·ªë c√¢u h·ªèi)
const REWARD_CODE = "DN-BTM-10FF-2025"; 

// D·ªØ li·ªáu Quiz c·ªë ƒë·ªãnh
// ƒê√É C·∫¨P NH·∫¨T: 10 C√ÇU H·ªéI M·ªöI
const artifactQuizData = [
    {
        question: "1. Tr·∫ßn H∆∞ng ƒê·∫°o c√≥ t√™n th·∫≠t l√† g√¨?",
        options: [
            { text: "Tr·∫ßn Qu·ªëc To·∫£n", isCorrect: false, answer: "Tr·∫ßn Qu·ªëc To·∫£n l√† ch√°u c·ªßa Tr·∫ßn H∆∞ng ƒê·∫°o, n·ªïi ti·∫øng v·ªõi tinh th·∫ßn y√™u n∆∞·ªõc khi c√≤n nh·ªè." },
            { text: "Tr·∫ßn Qu·ªëc Tu·∫•n", isCorrect: true, answer: "Tr·∫ßn Qu·ªëc Tu·∫•n l√† t√™n th·∫≠t v√† ƒë∆∞·ª£c bi·∫øt ƒë·∫øn nhi·ªÅu nh·∫•t c·ªßa Tr·∫ßn H∆∞ng ƒê·∫°o." },
            { text: "Tr·∫ßn Nh·∫≠t Du·∫≠t", isCorrect: false, answer: "Tr·∫ßn Nh·∫≠t Du·∫≠t l√† em trai c√πng cha kh√°c m·∫π v·ªõi Tr·∫ßn H∆∞ng ƒê·∫°o v√† c≈©ng l√† m·ªôt danh t∆∞·ªõng." },
            { text: "Tr·∫ßn Th√°nh T√¥ng", isCorrect: false, answer: "Tr·∫ßn Th√°nh T√¥ng l√† v·ªã Ho√†ng ƒë·∫ø th·ª© hai c·ªßa nh√† Tr·∫ßn, cha c·ªßa Tr·∫ßn Nh√¢n T√¥ng." }
        ]
    },
    {
        question: "2. Tr·∫ßn H∆∞ng ƒê·∫°o gi·ªØ ch·ª©c v·ª• g√¨ n·ªïi b·∫≠t nh·∫•t trong tri·ªÅu Tr·∫ßn?",
        options: [
            { text: "Th√°i s∆∞", isCorrect: false, answer: "Th√°i s∆∞ l√† ch·ª©c t·ªÉ t∆∞·ªõng, th∆∞·ªùng do ng∆∞·ªùi kh√°c n·∫Øm gi·ªØ." },
            { text: "Th∆∞·ª£ng t∆∞·ªõng qu√¢n", isCorrect: false, answer: "ƒê√¢y l√† m·ªôt ch·ª©c v·ª• qu√¢n s·ª± cao c·∫•p, nh∆∞ng kh√¥ng ph·∫£i t∆∞·ªõc hi·ªáu cao nh·∫•t c·ªßa √¥ng." },
            { text: "ƒê·∫°i t∆∞·ªõng qu√¢n ‚Äì Qu·ªëc c√¥ng Ti·∫øt ch·∫ø", isCorrect: true, answer: "Qu·ªëc c√¥ng Ti·∫øt ch·∫ø l√† t∆∞·ªõc v·ªã qu√¢n s·ª± cao nh·∫•t, ƒë∆∞·ª£c giao to√†n quy·ªÅn ch·ªâ huy qu√¢n ƒë·ªôi." },
            { text: "H√†n l√¢m h·ªçc sƒ©", isCorrect: false, answer: "ƒê√¢y l√† ch·ª©c v·ª• vƒÉn h·ªçc, kh√¥ng ph·∫£i chuy√™n m√¥n c·ªßa Tr·∫ßn H∆∞ng ƒê·∫°o." }
        ]
    },
    {
        question: "3. Tr·∫ßn H∆∞ng ƒê·∫°o n·ªïi ti·∫øng v·ªõi chi·∫øn th·∫Øng n√†o tr∆∞·ªõc qu√¢n M√¥ng ‚Äì Nguy√™n?",
        options: [
            { text: "Chi·∫øn th·∫Øng R·∫°ch G·∫ßm ‚Äì Xo√†i M√∫t", isCorrect: false, answer: "Chi·∫øn th·∫Øng n√†y thu·ªôc v·ªÅ Nguy·ªÖn Hu·ªá (qu√¢n T√¢y S∆°n) ch·ªëng qu√¢n Xi√™m." },
            { text: "Chi·∫øn th·∫Øng Chi LƒÉng", isCorrect: false, answer: "Chi·∫øn th·∫Øng n√†y thu·ªôc v·ªÅ L√™ L·ª£i v√† Nguy·ªÖn Tr√£i ch·ªëng qu√¢n Minh (Trung Qu·ªëc)." },
            { text: "Chi·∫øn th·∫Øng B·∫°ch ƒê·∫±ng (1288)", isCorrect: true, answer: "Tr·∫≠n B·∫°ch ƒê·∫±ng nƒÉm 1288 l√† chi·∫øn th·∫Øng quy·∫øt ƒë·ªãnh, k·∫øt th√∫c cu·ªôc kh√°ng chi·∫øn l·∫ßn th·ª© ba." },
            { text: "Chi·∫øn th·∫Øng ƒê·ªëng ƒêa", isCorrect: false, answer: "Chi·∫øn th·∫Øng n√†y thu·ªôc v·ªÅ Nguy·ªÖn Hu·ªá (quang Trung) ch·ªëng qu√¢n Thanh (Trung Qu·ªëc)." }
        ]
    },
    {
        question: "4. T√°c ph·∫©m n·ªïi ti·∫øng ƒë∆∞·ª£c cho l√† do Tr·∫ßn H∆∞ng ƒê·∫°o so·∫°n ƒë·ªÉ kh√≠ch l·ªá qu√¢n sƒ© l√†?",
        options: [
            { text: "H·ªãch t∆∞·ªõng sƒ©", isCorrect: true, answer: "H·ªãch t∆∞·ªõng sƒ© l√† √°ng vƒÉn y√™u n∆∞·ªõc h√πng h·ªìn, c√≥ t√°c d·ª•ng hi·ªáu tri·ªáu v√† kh√≠ch l·ªá tinh th·∫ßn qu√¢n sƒ© nh√† Tr·∫ßn." },
            { text: "Nam qu·ªëc s∆°n h√†", isCorrect: false, answer: "ƒê√¢y l√† √°ng th∆° ƒë∆∞·ª£c cho l√† c·ªßa L√Ω Th∆∞·ªùng Ki·ªát, ra ƒë·ªùi th·ªùi L√Ω." },
            { text: "B√¨nh Ng√¥ ƒë·∫°i c√°o", isCorrect: false, answer: "B√¨nh Ng√¥ ƒë·∫°i c√°o l√† c·ªßa Nguy·ªÖn Tr√£i, ra ƒë·ªùi th·ªùi L√™ S∆°." },
            { text: "Thi√™n ƒë√¥ chi·∫øu", isCorrect: false, answer: "Thi√™n ƒë√¥ chi·∫øu l√† Chi·∫øu d·ªùi ƒë√¥ c·ªßa L√Ω C√¥ng U·∫©n, ra ƒë·ªùi th·ªùi L√Ω." }
        ]
    },
    {
        question: "5. Tr·∫ßn H∆∞ng ƒê·∫°o l√† con c·ªßa ai?",
        options: [
            { text: "Tr·∫ßn Th·ªß ƒê·ªô", isCorrect: false, answer: "Tr·∫ßn Th·ªß ƒê·ªô l√† ng∆∞·ªùi n·∫Øm quy·ªÅn l·ª±c l·ªõn nh·∫•t ƒë·∫ßu tri·ªÅu Tr·∫ßn v√† l√† ch√∫ h·ªç c·ªßa √¥ng." },
            { text: "Tr·∫ßn Li·ªÖu", isCorrect: true, answer: "Tr·∫ßn H∆∞ng ƒê·∫°o l√† con c·ªßa An Sinh V∆∞∆°ng Tr·∫ßn Li·ªÖu, anh ru·ªôt c·ªßa Vua Tr·∫ßn Th√°i T√¥ng." },
            { text: "Tr·∫ßn Quang Kh·∫£i", isCorrect: false, answer: "Tr·∫ßn Quang Kh·∫£i l√† em trai c√πng m·∫π c·ªßa Vua Tr·∫ßn Th√°i T√¥ng, ƒë·ªìng th·ªùi l√† ƒë·ªëi th·ªß v√† sau n√†y l√† ƒë·ªìng ch√≠ c·ªßa √¥ng." },
            { text: "Tr·∫ßn Nh·∫≠t Du·∫≠t", isCorrect: false, answer: "Tr·∫ßn Nh·∫≠t Du·∫≠t l√† em c·ªßa Tr·∫ßn H∆∞ng ƒê·∫°o." }
        ]
    },
    {
        question: "6. D√≤ng s√¥ng n∆°i di·ªÖn ra tr·∫≠n B·∫°ch ƒê·∫±ng (1288) do Tr·∫ßn H∆∞ng ƒê·∫°o ch·ªâ huy n·∫±m ·ªü ƒë√¢u?",
        options: [
            { text: "S√¥ng H·ªìng", isCorrect: false, answer: "S√¥ng H·ªìng l√† con s√¥ng l·ªõn ch·∫£y qua mi·ªÅn B·∫Øc, kh√¥ng ph·∫£i ƒë·ªãa ƒëi·ªÉm ch√≠nh c·ªßa tr·∫≠n th·ªßy chi·∫øn n√†y." },
            { text: "S√¥ng Thu B·ªìn", isCorrect: false, answer: "S√¥ng Thu B·ªìn n·∫±m ·ªü khu v·ª±c Qu·∫£ng Nam, kh√¥ng li√™n quan ƒë·∫øn tr·∫≠n B·∫°ch ƒê·∫±ng." },
            { text: "S√¥ng C·∫£", isCorrect: false, answer: "S√¥ng C·∫£ n·∫±m ·ªü mi·ªÅn Trung (Ngh·ªá An/H√† Tƒ©nh)." },
            { text: "S√¥ng B·∫°ch ƒê·∫±ng", isCorrect: true, answer: "Tr·∫≠n chi·∫øn n√†y di·ªÖn ra t·∫°i c·ª≠a s√¥ng B·∫°ch ƒê·∫±ng, ranh gi·ªõi gi·ªØa H·∫£i Ph√≤ng v√† Qu·∫£ng Ninh ng√†y nay." }
        ]
    },
    {
        question: "7. T√™n khu di t√≠ch th·ªù Tr·∫ßn H∆∞ng ƒê·∫°o n·ªïi ti·∫øng ·ªü Nam ƒê·ªãnh l√† g√¨?",
        options: [
            { text: "ƒê·ªÅn Tr·∫ßn", isCorrect: true, answer: "ƒê·ªÅn Tr·∫ßn (Nam ƒê·ªãnh) l√† n∆°i th·ªù c√°c v·ªã Vua nh√† Tr·∫ßn v√† Tr·∫ßn H∆∞ng ƒê·∫°o, g·∫Øn li·ªÅn v·ªõi h·ªôi Khai ·∫•n." },
            { text: "ƒê·ªÅn H√πng", isCorrect: false, answer: "ƒê·ªÅn H√πng th·ªù c√°c Vua H√πng, t·ªï ti√™n d√¢n t·ªôc Vi·ªát Nam." },
            { text: "ƒê·ªÅn Ki·∫øp B·∫°c", isCorrect: false, answer: "ƒê·ªÅn Ki·∫øp B·∫°c (H·∫£i D∆∞∆°ng) l√† n∆°i th·ªù Tr·∫ßn H∆∞ng ƒê·∫°o, g·∫Øn li·ªÅn v·ªõi ph·ªß ƒë·ªá c·ªßa √¥ng." },
            { text: "ƒê·ªÅn Ng·ªçc S∆°n", isCorrect: false, answer: "ƒê·ªÅn Ng·ªçc S∆°n (H√† N·ªôi) th·ªù Tr·∫ßn H∆∞ng ƒê·∫°o v√† m·ªôt s·ªë v·ªã th·∫ßn kh√°c." }
        ]
    },
    {
        question: "8. Ki·ªát t√°c qu√¢n s·ª± n√†o ƒë∆∞·ª£c Tr·∫ßn H∆∞ng ƒê·∫°o vi·∫øt ƒë·ªÉ truy·ªÅn l·∫°i kinh nghi·ªám ch·ªëng gi·∫∑c?",
        options: [
            { text: "Binh th∆∞ y·∫øu l∆∞·ª£c", isCorrect: true, answer: "Binh th∆∞ y·∫øu l∆∞·ª£c l√† cu·ªën s√°ch t√≥m t·∫Øt c√°c nguy√™n t·∫Øc qu√¢n s·ª±, l√† t√†i li·ªáu qu√Ω gi√° cho c√°c ƒë·ªùi sau." },
            { text: "Qu√¢n trung t·ª´ m·ªánh t·∫≠p", isCorrect: false, answer: "ƒê√¢y l√† t√°c ph·∫©m c·ªßa Nguy·ªÖn Tr√£i, ch·ªß y·∫øu l√† th∆∞ t·ª´ ngo·∫°i giao." },
            { text: "L·ªãch tri·ªÅu hi·∫øn ch∆∞∆°ng lo·∫°i ch√≠", isCorrect: false, answer: "ƒê√¢y l√† b·ªô b√°ch khoa to√†n th∆∞ l·ªãch s·ª≠ do Phan Huy Ch√∫ bi√™n so·∫°n." },
            { text: "ƒê·∫°i Vi·ªát s·ª≠ k√Ω to√†n th∆∞", isCorrect: false, answer: "ƒê√¢y l√† b·ªô qu·ªëc s·ª≠ do Ng√¥ Sƒ© Li√™n bi√™n so·∫°n." }
        ]
    },
    {
        question: "9. Tr·∫ßn H∆∞ng ƒê·∫°o c√≥ c√¥ng l·ªõn trong m·∫•y l·∫ßn kh√°ng chi·∫øn ch·ªëng M√¥ng ‚Äì Nguy√™n?",
        options: [
            { text: "1 l·∫ßn", isCorrect: false, answer: "Qu√¢n d√¢n nh√† Tr·∫ßn ƒë√£ kh√°ng chi·∫øn t·ªïng c·ªông 3 l·∫ßn." },
            { text: "2 l·∫ßn", isCorrect: false, answer: "Tr·∫ßn H∆∞ng ƒê·∫°o tham gia ch·ªâ huy c·∫£ ba l·∫ßn kh√°ng chi·∫øn (1258, 1285, 1288)." },
            { text: "3 l·∫ßn", isCorrect: true, answer: "Tr·∫ßn H∆∞ng ƒê·∫°o tham gia ch·ªâ huy c·∫£ ba l·∫ßn kh√°ng chi·∫øn ch·ªëng qu√¢n Nguy√™n M√¥ng (1258, 1285, 1288)." },
            { text: "4 l·∫ßn", isCorrect: false, answer: "Qu√¢n d√¢n nh√† Tr·∫ßn ch·ªâ tr·∫£i qua 3 l·∫ßn kh√°ng chi·∫øn l·ªõn." }
        ]
    },
    {
        question: "10. C√¢u n√≥i n·ªïi ti·∫øng c·ªßa Tr·∫ßn H∆∞ng ƒê·∫°o th·ªÉ hi·ªán tinh th·∫ßn y√™u n∆∞·ªõc l√† g√¨?",
        options: [
            { text: "‚ÄúS√°t Th√°t!‚Äù", isCorrect: false, answer: "ƒê√¢y l√† kh·∫©u hi·ªáu c·ªßa binh sƒ© nh√† Tr·∫ßn, kh√¥ng ph·∫£i l√† c√¢u n√≥i n·ªïi ti·∫øng ri√™ng c·ªßa √¥ng tr∆∞·ªõc vua." },
            { text: "‚ÄúM·ªôt t·∫•c ƒë·∫•t c·ªßa ti·ªÅn nh√¢n ƒë·ªÉ l·∫°i c≈©ng kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ l·ªçt v√†o tay k·∫ª kh√°c.‚Äù", isCorrect: false, answer: "C√¢u n√†y th·ªÉ hi·ªán ch·ªß quy·ªÅn, nh∆∞ng kh√¥ng ph·∫£i c√¢u n√≥i n·ªïi ti·∫øng c·ªßa √¥ng tr∆∞·ªõc vua." },
            { text: "‚Äúƒê·∫ßu th·∫ßn ch∆∞a r∆°i xu·ªëng ƒë·∫•t, xin b·ªá h·∫° ƒë·ª´ng lo.‚Äù", isCorrect: true, answer: "ƒê√¢y l√† c√¢u tr·∫£ l·ªùi c·ªßa √¥ng v·ªõi vua Tr·∫ßn Nh√¢n T√¥ng, th·ªÉ hi·ªán s·ª± quy·∫øt t√¢m chi·∫øn ƒë·∫•u ƒë·∫øn c√πng, kh√¥ng ƒë·∫ßu h√†ng." },
            { text: "‚ÄúNam qu·ªëc s∆°n h√† Nam ƒë·∫ø c∆∞.‚Äù", isCorrect: false, answer: "ƒê√¢y l√† c√¢u th∆° n·ªïi ti·∫øng ƒë∆∞·ª£c cho l√† c·ªßa L√Ω Th∆∞·ªùng Ki·ªát." }
        ]
    }
];

// H√†m l·∫•y Quiz d·ª±a tr√™n Artifact ID (M√¥ ph·ªèng: ch·ªâ c√≥ quiz cho artifact_123)
function getQuizForArtifact(artifactId) {
    if (artifactId === 'artifact_123') {
        // C·∫ßn sao ch√©p d·ªØ li·ªáu ƒë·ªÉ tr√°nh vi·ªác Quiz b·ªã s·ª≠a ƒë·ªïi global khi l√†m b√†i
        return JSON.parse(JSON.stringify(artifactQuizData));
    }
    return null;
}

// --- PROFILE / QUIZ LOGIC (C·∫¨P NH·∫¨T) ---

// NEW FUNCTION: Manage sub-screens within Profile tab
function showProfileSubScreen(viewId) {
    document.getElementById('profile-main-view').style.display = 'none';
    document.getElementById('artifact-history-quiz-view').style.display = 'none';
    
    // Show the requested view
    const targetView = document.getElementById(viewId);
    if (targetView) {
        targetView.style.display = 'flex';
        // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã tab l·ªãch s·ª≠ khi v√†o m√†n h√¨nh ph·ª•
        if (viewId === 'artifact-history-quiz-view') {
            showSubTab('history');
        }
    }
}

function showHistoryQuizView() {
    showProfileSubScreen('artifact-history-quiz-view');
    renderProfileHistoryQuiz();
}

function backToProfileMain() {
    showProfileSubScreen('profile-main-view');
    // Ensure main view info is up-to-date (esp. score)
    renderProfileMain(); 
}

/**
 * NEW FUNCTION: Qu·∫£n l√Ω vi·ªác chuy·ªÉn ƒë·ªïi gi·ªØa c√°c tab ph·ª• (History, Quiz)
 */
function showSubTab(tabId) {
    // ·∫®n t·∫•t c·∫£ n·ªôi dung tab
    document.querySelectorAll('.sub-tab-content').forEach(el => el.classList.remove('active'));
    // X√≥a active kh·ªèi t·∫•t c·∫£ n√∫t
    document.querySelectorAll('.sub-nav-item').forEach(el => el.classList.remove('active'));

    // Hi·ªÉn th·ªã n·ªôi dung tab ƒë∆∞·ª£c ch·ªçn
    document.getElementById(`sub-tab-${tabId}`).classList.add('active');
    // ƒê√°nh d·∫•u n√∫t ƒëang ho·∫°t ƒë·ªông
    // KH·∫ÆC PH·ª§C L·ªñI: Ch·ªâ c√≥ sub-nav cho history, n√™n ch·ªâ c·∫ßn t√¨m ƒë√∫ng item n√†y
    document.querySelector('.sub-nav-item').classList.add('active');
}

function renderProfileMain() {
    // T√≠nh l·∫°i t·ªïng s·ªë c√¢u h·ªèi v√† ƒëi·ªÉm
    quizTotalQuestions = Object.keys(artifactQuizStatus).length;
    let currentQuizScore = 0;
    Object.values(artifactQuizStatus).forEach(status => {
        if (status.score !== undefined) { // Ch·ªâ t√≠nh ƒëi·ªÉm c·ªßa nh·ªØng quiz ƒë√£ l√†m
            currentQuizScore += status.score;
        }
    });
    quizScore = currentQuizScore;

    const scoreEl = document.getElementById('quiz-score');
    const totalEl = document.getElementById('quiz-total-score');
    scoreEl.innerText = quizScore;
    // C·∫≠p nh·∫≠t t·ªïng s·ªë c√¢u h·ªèi t·ªëi ƒëa c√≥ th·ªÉ tr·∫£ l·ªùi (s·ªë quiz ƒë√£ l√†m * s·ªë c√¢u h·ªèi/quiz)
    totalEl.innerText = Object.values(artifactQuizStatus).filter(s => s.done).length * artifactQuizData.length; 

    checkRewardStatus(); // V·∫´n c·∫ßn g·ªçi ƒë·ªÉ c·∫≠p nh·∫≠t th·∫ª th∆∞·ªüng tr√™n m√†n h√¨nh ch√≠nh
    updateProfileDisplay(); // C·∫≠p nh·∫≠t t√™n ng∆∞·ªùi d√πng
}

function renderProfileHistoryQuiz() {
    const visitedList = document.getElementById('visited-locations');
    
    // 1. C·∫≠p nh·∫≠t danh s√°ch ƒë√£ tham quan
    visitedList.innerHTML = visitedArtifacts.length > 0
        ? visitedArtifacts.map(a => {
            const status = artifactQuizStatus[a.id];
            // L·∫•y t·ªïng s·ªë c√¢u h·ªèi t·ª´ data. N·∫øu kh√¥ng c√≥ data, m·∫∑c ƒë·ªãnh l√† 10 (v√¨ ch·ªâ c√≥ quiz 10 c√¢u)
            const totalQ = status && status.total ? status.total : artifactQuizData.length; 
            let statusText = 'Ch∆∞a Quiz';
            if (status && status.done) {
                statusText = status.score > 0 ? `‚úÖ Quiz: ${status.score}/${totalQ}` : `‚ùå Quiz: ${status.score}/${totalQ}`;
            }
            return `<li>üñºÔ∏è ${a.name} (${a.id}) - ${statusText}</li>`;
        }).join('')
        : '<li>(Ch∆∞a c√≥)</li>';
}

function renderProfile() {
    renderProfileMain();
    renderProfileHistoryQuiz();
    showProfileSubScreen('profile-main-view'); // Ensure main view is visible on tab switch
}

/**
 * NEW FUNCTION: H√†m x·ª≠ l√Ω s·ª± ki·ªán nh·∫•n n√∫t B·∫Øt ƒë·∫ßu Quiz
 */
function handleStartQuiz() {
    if (!currentArtifactData || !getQuizForArtifact(currentArtifactData.id)) {
        showAlert("Kh√¥ng c√≥ Quiz cho hi·ªán v·∫≠t n√†y ho·∫∑c ch∆∞a qu√©t QR.");
        return;
    }
    // CHUY·ªÇN SANG M√ÄN H√åNH QUIZ RI√äNG
    document.getElementById('main-screen').classList.add('hidden');
    document.getElementById('quiz-standalone-screen').classList.remove('hidden');

    // G·ªåI H√ÄM KH·ªûI T·∫†O QUIZ TR√äN M√ÄN H√åNH RI√äNG
    startArtifactQuiz(currentArtifactData, 'standalone');
}

/**
 * NEW FUNCTION: Quay l·∫°i tab QR
 */
function backToQrTab() {
    document.getElementById('quiz-standalone-screen').classList.add('hidden');
    document.getElementById('main-screen').classList.remove('hidden');
    showTab('qr-tab'); // ƒê·∫£m b·∫£o quay v·ªÅ tab Qu√©t QR
}


// H√†m kh·ªüi t·∫°o/hi·ªÉn th·ªã Quiz t·∫°i m√†n h√¨nh Ri√™ng (Standalone)
function startArtifactQuiz(artifactData, mode = 'standalone') {
    // X√°c ƒë·ªãnh ID c·ªßa c√°c th√†nh ph·∫ßn d·ª±a tr√™n mode (standalone/qr)
    const suffix = mode === 'standalone' ? 'standalone' : 'qr';
    const quizSection = document.getElementById(`quiz-section-${suffix}`);
    // const quizTitle = document.getElementById(`quiz-title-${suffix}`); // ƒê√É X√ìA
    const startQuizBtn = document.getElementById('start-quiz-button-qr'); // Ch·ªâ c√≥ tr√™n QR tab

    // L·∫•y Quiz data
    const quizData = getQuizForArtifact(artifactData.id);
    if (!quizData) {
        quizSection.style.display = 'none';
        return;
    }
    
    // N·∫øu ƒëang ·ªü QR tab, n√∫t b·∫Øt ƒë·∫ßu ch√≠nh ph·∫£i ·∫©n khi quiz section hi·ªÉn th·ªã
    if (mode !== 'standalone') {
        startQuizBtn.style.display = 'none'; 
    }
    
    // ƒê·∫∑t bi·∫øn quiz data t·∫°m th·ªùi
    currentArtifactQuizData = quizData; 

    // ƒê√É X√ìA: quizTitle.innerText = `‚ùì Quiz v·ªÅ ${artifactData.name}`;
    
    // Kh√¥i ph·ª•c l·∫°i c·∫•u tr√∫c ban ƒë·∫ßu c·ªßa quiz content
    const quizContent = document.getElementById(`quiz-content-${suffix}`);
    // ƒê·∫£m b·∫£o truy·ªÅn mode v√†o submitArtifactQuiz
    quizContent.innerHTML = `<div id="quiz-question-container-${suffix}"></div><button id="quiz-submit-button-${suffix}" onclick="submitArtifactQuiz('${mode}')" style="display:none; width:100%; margin-top: 15px; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">Ho√†n th√†nh Quiz</button><div id="quiz-feedback-${suffix}" class="quiz-result-message" style="display: none;"></div>`;

    // L·∫•y l·∫°i c√°c tham chi·∫øu DOM sau khi g√°n l·∫°i innerHTML
    const newQuizContainer = document.getElementById(`quiz-question-container-${suffix}`);
    const newQuizSubmitBtn = document.getElementById(`quiz-submit-button-${suffix}`);
    const newQuizFeedback = document.getElementById(`quiz-feedback-${suffix}`);

    const quizStatus = artifactQuizStatus[artifactData.id];
    
    // N·∫øu ƒë√£ l√†m quiz, hi·ªÉn th·ªã k·∫øt qu·∫£ v√† n√∫t l√†m l·∫°i
    if (quizStatus && quizStatus.done) {
        const resultMsg = `B·∫°n ƒë√£ ho√†n th√†nh Quiz n√†y v√† ƒë·∫°t ${quizStatus.score}/${quizData.length} ƒëi·ªÉm ƒë√∫ng!`;
        
        newQuizFeedback.className = quizStatus.score > 0 ? 'quiz-result-message quiz-success' : 'quiz-result-message quiz-fail';
        newQuizFeedback.innerText = resultMsg;
        newQuizFeedback.style.display = 'block';
        newQuizSubmitBtn.style.display = 'none';

        // Hi·ªÉn th·ªã c√¢u h·ªèi ·ªü ch·∫ø ƒë·ªô xem k·∫øt qu·∫£ (non-interactive)
        renderQuizQuestionsQR(quizData, newQuizContainer, false, quizStatus.selections, mode);

        // Th√™m n√∫t l√†m l·∫°i
        let restartBtn = document.getElementById('restart-quiz-btn');
        if(!restartBtn) {
            restartBtn = document.createElement('button');
            restartBtn.id = 'restart-quiz-btn';
            restartBtn.innerText = 'L√†m l·∫°i Quiz';
            restartBtn.style.marginTop = '15px';
            restartBtn.style.background = 'linear-gradient(135deg, #3498db 0%, #2980b9 100%)';
            restartBtn.onclick = () => {
                // X√≥a tr·∫°ng th√°i ƒë√£ l√†m trong b·ªô nh·ªõ t·∫°m (ch·ªâ reset tr·∫°ng th√°i l√†m b√†i)
                artifactQuizStatus[artifactData.id] = { done: false, score: 0, selections: {}, total: artifactQuizData.length };
                // G·ªçi l·∫°i h√†m ƒë·ªÉ t·∫£i Quiz ·ªü ch·∫ø ƒë·ªô l√†m b√†i m·ªõi
                startArtifactQuiz(artifactData, mode); 
            };
            quizContent.appendChild(restartBtn);
        }
        
    } else {
        // Ch·∫ø ƒë·ªô l√†m b√†i m·ªõi 
        newQuizFeedback.style.display = 'none';
        newQuizSubmitBtn.style.display = 'inline-block';
        // ƒê√É S·ª¨A L·ªñI: Ch·ªâ truy·ªÅn mode v√†o h√†m submitArtifactQuiz
        newQuizSubmitBtn.onclick = () => submitArtifactQuiz(mode);
        
        // Render Quiz m·ªõi (interactive)
        // Reset selections cho l·∫ßn l√†m b√†i m·ªõi
        quizData.forEach(q => q.selectedOptionIndex = null);
        renderQuizQuestionsQR(quizData, newQuizContainer, true, {}, mode);
        
        let restartBtn = document.getElementById('restart-quiz-btn');
        if(restartBtn) restartBtn.remove();
    }

    quizSection.style.display = 'flex';
}

// NEW FUNCTION: Render Quiz Questions specifically for Standalone/QR tab
function renderQuizQuestionsQR(quizData, container, interactive, selections = {}, mode = 'standalone') {
    // X√°c ƒë·ªãnh prefix cho query selector
    const prefix = mode === 'standalone' ? 'standalone' : 'qr';

    container.innerHTML = '';
    
    // ** TH√äM TI√äU ƒê·ªÄ TR·ªû L·∫†I V√ÄO PH·∫¶N TR√äN C·ª¶A container **
    /* D√≤ng n√†y ƒë√£ ƒë∆∞·ª£c x√≥a */
    // const quizTitleEl = document.getElementById(`quiz-title-${prefix}`);
    // if (quizTitleEl) {
    //     quizTitleEl.innerText = `‚ùì Quiz v·ªÅ ${currentArtifactData.name}`; 
    // }
    
    quizData.forEach((q, index) => {
        const qEl = document.createElement('div');
        qEl.className = 'quiz-question';
        // Hi·ªÉn th·ªã c√¢u h·ªèi: q.question ƒë√£ ch·ª©a s·ªë th·ª© t·ª±
        // ƒê√£ s·ª≠a: S·ª≠ d·ª•ng th·∫ª h4 ƒë·ªÉ hi·ªÉn th·ªã c√¢u h·ªèi, gi√∫p n√≥ n·ªïi b·∫≠t v√† t√°ch kh·ªèi c√°c l·ª±a ch·ªçn
        qEl.innerHTML = `<h4>${q.question}</h4>`; 
        
        // L·∫•y th√¥ng tin v·ªÅ ƒë√°p √°n ƒë√∫ng cho c√¢u n√†y
        const correctAnswerOption = q.options.findIndex(opt => opt.isCorrect);
        // T√¨m ra rationale cho c√¢u tr·∫£ l·ªùi ƒë√∫ng
        const correctRationale = q.options[correctAnswerOption]?.answer || "Kh√¥ng c√≥ gi·∫£i th√≠ch.";
        let rationaleAppended = false;

        q.options.forEach((opt, optIndex) => {
            const optBtn = document.createElement('button');
            optBtn.className = 'quiz-option';
            optBtn.innerText = opt.text;
            optBtn.setAttribute('data-q-index', index);
            optBtn.setAttribute('data-opt-index', optIndex);
            
            // L·∫•y selection t·ª´ data model t·∫°m th·ªùi
            const currentSelection = interactive ? currentArtifactQuizData[index]?.selectedOptionIndex : selections[index];

            // X·ª≠ l√Ω s·ª± ki·ªán click
            if (interactive) {
                optBtn.onclick = () => selectQuizOptionQR(optBtn, index, optIndex, prefix);
                // Gi·ªØ l·ª±a ch·ªçn
                if (currentSelection === optIndex) {
                    optBtn.classList.add('active-selection');
                    optBtn.style.backgroundColor = '#d1e5d4'; 
                }
            } else {
                // Ch·∫ø ƒë·ªô xem k·∫øt qu·∫£ (non-interactive)
                optBtn.disabled = true; 
                const selectedIndex = currentSelection;

                // 1. Highlight c√¢u tr·∫£ l·ªùi ƒë√∫ng (Lu√¥n l√† m√†u xanh l√°)
                if (opt.isCorrect) {
                    optBtn.classList.add('correct-answer'); 
                } 
                
                // 2. Highlight l·ª±a ch·ªçn c·ªßa ng∆∞·ªùi d√πng (T√¥ ƒë·ªè n·∫øu sai)
                if (selectedIndex === optIndex) {
                    if (selectedIndex !== correctAnswerOption) {
                        // T√¥ ƒë·ªè c√¢u tr·∫£ l·ªùi SAI M√Ä NG∆Ø·ªúI D√ôNG ƒê√É CH·ªåN
                        optBtn.classList.add('incorrect-answer'); 
                    } 
                }
            }
            qEl.appendChild(optBtn);
        });
        
        // 3. Hi·ªÉn th·ªã Rationale (Ch·ªâ hi·ªÉn th·ªã sau khi n·ªôp b√†i)
        if (!interactive) {
            const rationaleEl = document.createElement('p');
            rationaleEl.style.marginTop = '10px';
            rationaleEl.style.padding = '10px';
            rationaleEl.style.borderRadius = '8px';
            rationaleEl.style.backgroundColor = '#f0f0f0';
            rationaleEl.style.color = '#555';
            rationaleEl.style.textAlign = 'left';
            rationaleEl.innerHTML = `<b>Gi·∫£i th√≠ch:</b> ${correctRationale}`;
            qEl.appendChild(rationaleEl);
        }
        
        // Th√™m tr∆∞·ªùng d·ªØ li·ªáu t·∫°m ƒë·ªÉ l∆∞u l·ª±a ch·ªçn (ch·ªâ d√πng khi interactive)
        if (interactive) {
            // C·∫≠p nh·∫≠t selectedOptionIndex trong currentArtifactQuizData cho l·∫ßn l√†m b√†i m·ªõi
            if (currentArtifactQuizData && currentArtifactQuizData[index]) {
                if (currentArtifactQuizData[index].selectedOptionIndex === undefined) {
                    currentArtifactQuizData[index].selectedOptionIndex = currentSelection !== undefined ? currentSelection : null;
                }
            }
        }
        
        container.appendChild(qEl);
    });
}

// NEW FUNCTION: Select option for Quiz
function selectQuizOptionQR(button, qIndex, optIndex, prefix) {
    // ƒê·∫£m b·∫£o currentArtifactQuizData ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o
    if (!currentArtifactQuizData) {
        currentArtifactQuizData = getQuizForArtifact(currentArtifactData.id);
    }

    // X√≥a l·ª±a ch·ªçn c≈©
    document.querySelectorAll(`#quiz-question-container-${prefix} .quiz-option[data-q-index="${qIndex}"]`).forEach(btn => {
        btn.classList.remove('active-selection');
        btn.style.backgroundColor = '#f7f7f7';
    });
    
    // ƒê·∫∑t l·ª±a ch·ªçn m·ªõi
    button.classList.add('active-selection');
    button.style.backgroundColor = '#d1e5d4';

    // L∆∞u l·ª±a ch·ªçn v√†o data model t·∫°m th·ªùi
    currentArtifactQuizData[qIndex].selectedOptionIndex = optIndex;
}


// NEW FUNCTION: Submit Quiz cho Hi·ªán v·∫≠t
function submitArtifactQuiz(mode) {
    const finalQuizData = currentArtifactQuizData;
    
    const suffix = mode === 'standalone' ? 'standalone' : 'qr';
    const artifactData = currentArtifactData;

    if (!finalQuizData || !finalQuizData.every(q => q.selectedOptionIndex !== null && q.selectedOptionIndex !== undefined)) {
         showAlert("Vui l√≤ng tr·∫£ l·ªùi t·∫•t c·∫£ c√°c c√¢u h·ªèi tr∆∞·ªõc khi n·ªôp b√†i!");
         return;
    }

    let correctCount = 0;
    let totalQuestions = finalQuizData.length;
    let selections = {};

    finalQuizData.forEach((q, index) => {
        // C·∫ßn ki·ªÉm tra q.selectedOptionIndex !== undefined v√¨ c√≥ th·ªÉ l√† 0
        selections[index] = q.selectedOptionIndex;
        if (q.selectedOptionIndex !== null && q.selectedOptionIndex !== undefined && q.options[q.selectedOptionIndex]?.isCorrect) {
            correctCount++;
        }
    });

    // C·∫≠p nh·∫≠t tr·∫°ng th√°i Quiz cho hi·ªán v·∫≠t n√†y
    artifactQuizStatus[artifactData.id] = {
        done: true,
        score: correctCount,
        total: totalQuestions,
        selections: selections 
    };
    
    // C·∫≠p nh·∫≠t l·∫°i giao di·ªán
    renderProfileMain(); 
    
    // T·∫£i l·∫°i Quiz ·ªü ch·∫ø ƒë·ªô xem k·∫øt qu·∫£
    startArtifactQuiz(artifactData, mode); 
    
    // Th√¥ng b√°o cho ng∆∞·ªùi d√πng
    const feedbackText = correctCount > 0 
        ? `üéâ Ch√∫c m·ª´ng! B·∫°n tr·∫£ l·ªùi ƒë√∫ng ${correctCount}/${totalQuestions} c√¢u. ƒêi·ªÉm ƒë√£ ƒë∆∞·ª£c t√≠ch l≈©y!`
        : `B·∫°n ƒë√£ tr·∫£ l·ªùi ${correctCount}/${totalQuestions} c√¢u.` + (correctCount < totalQuestions ? ` C·ªë g·∫Øng l√†m l·∫°i ƒë·ªÉ ƒë·∫°t ƒëi·ªÉm cao h∆°n nh√©!` : "");
        
    showAlert(feedbackText);
}

// H√ÄM N√ÇNG C·∫§P PH·∫¶N TH∆Ø·ªûNG (D·ª±a tr√™n quizScore t√≠ch l≈©y)
function checkRewardStatus() {
    const displayEl = document.getElementById('reward-status-display');
    const requiredScore = REWARD_THRESHOLD; 

    if (quizScore >= requiredScore) {
        // HI·ªÇN TH·ªä M√É ƒê·ªîI TH∆Ø·ªûNG
        const code = REWARD_CODE;

        displayEl.innerHTML = `
            <p style="color: var(--primary-dark); font-weight: bold; font-size: 16px; margin-bottom: 8px;">
                üéâ ƒê√£ ƒê·ªß ƒêi·ªÉm!
            </p>
            <p style="color: var(--primary-dark);">B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c Phi·∫øu gi·∫£m gi√° 10%.</p>
            <p style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">M√£ ƒë·ªïi th∆∞·ªüng: <b style="color: #e67e22;">${code}</b>. Xu·∫•t tr√¨nh m√£ n√†y t·∫°i qu·∫ßy.</p>
        `;
        document.getElementById('reward-card').style.borderLeft = '5px solid var(--accent-color)';
    } else {
        // HI·ªÇN TH·ªä TH√îNG B√ÅO THI·∫æU ƒêI·ªÇM
        const missing = requiredScore - quizScore;
        displayEl.innerHTML = `
            <p id="reward-status">T√≠ch l≈©y ${requiredScore} ƒëi·ªÉm ƒë√∫ng ƒë·ªÉ nh·∫≠n qu√†!</p>
            <p style="color: #e67e22; font-weight: 500;">B·∫°n c·∫ßn th√™m ${missing} ƒëi·ªÉm ƒë√∫ng n·ªØa.</p>
        `;
         document.getElementById('reward-card').style.borderLeft = '5px solid var(--primary-dark)';
    }
}


/* ==========================================================================
   PH·∫¶N 1: LOGIC AI MOCKUP (TR·∫¢ L·ªúI C·ªê ƒê·ªäNH)
   ========================================================================== */
let isProcessing = false; // Bi·∫øn c·ªù ƒë·ªÉ ngƒÉn ch·∫∑n g·ª≠i tin nh·∫Øn li√™n t·ª•c

/**
 * C√°c c√¢u tr·∫£ l·ªùi gi·∫£ l·∫≠p cho c√°c c√¢u h·ªèi m·∫´u v·ªÅ Tr·∫ßn H∆∞ng ƒê·∫°o.
 * ƒê√£ x√≥a k√Ω t·ª± ü§ñ
 */
const mockAnswers = {
    'ti·ªÉus·ª≠tr·∫ßnh∆∞ngƒë·∫°o': 'Tr·∫ßn H∆∞ng ƒê·∫°o (Tr·∫ßn Qu·ªëc Tu·∫•n, 1228‚Äì1300) l√† Qu·ªëc c√¥ng Ti·∫øt ch·∫ø tri·ªÅu Tr·∫ßn, ng∆∞·ªùi ch·ªâ huy qu√¢n d√¢n ƒê·∫°i Vi·ªát 3 l·∫ßn ƒë√°nh th·∫Øng qu√¢n Nguy√™n M√¥ng. √îng ƒë∆∞·ª£c xem l√† m·ªôt trong 10 v·ªã t∆∞·ªõng vƒ© ƒë·∫°i nh·∫•t l·ªãch s·ª≠ th·∫ø gi·ªõi.',
    't√°cph·∫©mn·ªïiti·∫øngnh·∫•tc·ªßatr·∫ßnh∆∞ngƒë·∫°o': 'T√°c ph·∫©m n·ªïi ti·∫øng nh·∫•t c·ªßa √¥ng l√† "H·ªãch t∆∞·ªõng sƒ©", m·ªôt √°ng vƒÉn y√™u n∆∞·ªõc h√πng h·ªìn, kh√≠ch l·ªá tinh th·∫ßn chi·∫øn ƒë·∫•u c·ªßa qu√¢n ƒë·ªôi tr∆∞·ªõc h·ªça x√¢m lƒÉng Nguy√™n M√¥ng.',
    'tr·∫≠nchi·∫ønb·∫°chƒë·∫±ngdi·ªÖnrakhin√†o': 'Tr·∫≠n chi·∫øn B·∫°ch ƒê·∫±ng l·ªãch s·ª≠ di·ªÖn ra v√†o nƒÉm 1288, v·ªõi chi·∫øn thu·∫≠t c·∫Øm c·ªçc ng·∫ßm ƒë·ªôc ƒë√°o c·ªßa Tr·∫ßn H∆∞ng ƒê·∫°o, nh·∫•n ch√¨m g·∫ßn h·∫øt ƒëo√†n thuy·ªÅn chi·∫øn c·ªßa qu√¢n Nguy√™n.',
    // S·ª≠a l·ªói: Lo·∫°i b·ªè d·∫•u nh√°y k√©p th·ª´a trong kh√≥a t·ª´ ƒëi·ªÉn
    '√Ωnghƒ©ac√¢un√≥ib·ªáh·∫°ch√©mƒë·∫ßuth·∫ßnr·ªìih√£yh√†ng': 'C√¢u n√≥i th·ªÉ hi·ªán tinh th·∫ßn y√™u n∆∞·ªõc tuy·ªát ƒë·ªëi, quy·∫øt t·ª≠ v√¨ ƒë·∫•t n∆∞·ªõc c·ªßa √¥ng. N√≥ c·ªßng c·ªë ni·ªÅm tin v√† √Ω ch√≠ kh√¥ng khu·∫•t ph·ª•c c·ªßa tri·ªÅu ƒë√¨nh v√† to√†n qu√¢n d√¢n nh√† Tr·∫ßn.',
    'xin ch√†o': 'Ch√†o b·∫°n! T√¥i ƒëang ·ªü ch·∫ø ƒë·ªô m√¥ ph·ªèng. B·∫°n c√≥ th·ªÉ h·ªèi t√¥i c√°c c√¢u h·ªèi m·∫´u v·ªÅ Tr·∫ßn H∆∞ng ƒê·∫°o ho·∫∑c g√µ c√¢u h·ªèi b·∫•t k·ª≥ ƒë·ªÉ xem ph·∫£n h·ªìi ƒë∆∞·ª£c l·∫≠p tr√¨nh s·∫µn!',
    'ch√†o': 'Ch√†o b·∫°n! T√¥i ƒëang ·ªü ch·∫ø ƒë·ªô m√¥ ph·ªèng. B·∫°n c√≥ th·ªÉ h·ªèi t√¥i c√°c c√¢u h·ªèi m·∫´u v·ªÅ Tr·∫ßn H∆∞ng ƒê·∫°o ho·∫∑c g√µ c√¢u h·ªèi b·∫•t k·ª≥ ƒë·ªÉ xem ph·∫£n h·ªìi ƒë∆∞·ª£c l·∫≠p tr√¨nh s·∫µn!',
    'hi': 'Ch√†o b·∫°n! T√¥i ƒëang ·ªü ch·∫ø ƒë·ªô m√¥ ph·ªèng. B·∫°n c√≥ th·ªÉ h·ªèi t√¥i c√°c c√¢u h·ªèi m·∫´u v·ªÅ Tr·∫ßn H∆∞ng ƒê·∫°o ho·∫∑c g√µ c√¢u h·ªèi b·∫•t k·ª≥ ƒë·ªÉ xem ph·∫£n h·ªìi ƒë∆∞·ª£c l·∫≠p tr√¨nh s·∫µn!',
};

/**
 * H√†m chu·∫©n h√≥a c√¢u h·ªèi ƒë·ªÉ so s√°nh v·ªõi keys trong mockAnswers.
 */
function normalizeString(str) {
    // S·ª≠a l·ªói: B·ªï sung lo·∫°i b·ªè d·∫•u nh√°y k√©p " v√† d·∫•u ch·∫•m h·ªèi ?
    return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[?\s"]/g, '');
}

/**
 * H√†m h·ªó tr·ª£ ƒëi·ªÅn c√¢u h·ªèi m·∫´u v√† g·ª≠i
 */
function prefillAndSend(query) {
    document.getElementById('chat-input').value = query;
    sendMessage();
}

/**
 * KH·∫ÆC PH·ª§C L·ªñI QUAN TR·ªåNG: H√†m g·ª≠i tin nh·∫Øn v√† x·ª≠ l√Ω ph·∫£n h·ªìi m√¥ ph·ªèng AI
 */
async function sendMessage() {
    if (isProcessing) return;

    const input = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const loader = document.getElementById('loader');
    const msg = input.value.trim();
    if (!msg) return;

    isProcessing = true;
    input.disabled = true;
    sendBtn.disabled = true;
    loader.style.display = 'block';

    const chatWindow = document.getElementById('chat-window');
    
    // Th√™m tin nh·∫Øn ng∆∞·ªùi d√πng
    const userDiv = document.createElement('div');
    userDiv.className = 'chat-message user-msg';
    userDiv.innerText = msg;
    chatWindow.appendChild(userDiv);
    chatWindow.appendChild(document.createElement('div')).style.clear = 'both'; 
    chatWindow.scrollTop = chatWindow.scrollHeight;

    // T√¨m ki·∫øm c√¢u tr·∫£ l·ªùi m√¥ ph·ªèng
    const normalizedMsg = normalizeString(msg);
    let responseText = mockAnswers[normalizedMsg] || 'T√¥i l√† Chatbot m√¥ ph·ªèng. T√¥i ch·ªâ c√≥ th·ªÉ tr·∫£ l·ªùi c√°c c√¢u h·ªèi m·∫´u v·ªÅ Tr·∫ßn H∆∞ng ƒê·∫°o. Vui l√≤ng th·ª≠ l·∫°i v·ªõi m·ªôt trong c√°c g·ª£i √Ω ·ªü tr√™n!';

    try {
        // M√¥ ph·ªèng ƒë·ªô tr·ªÖ nh·ªè ƒë·ªÉ ph·∫£n h·ªìi tr√¥ng t·ª± nhi√™n h∆°n
        await new Promise(resolve => setTimeout(resolve, 800)); 
        
        // Th√™m tin nh·∫Øn AI
        const aiDiv = document.createElement('div');
        aiDiv.className = 'chat-message ai-msg';
        aiDiv.innerText = responseText; 
        chatWindow.appendChild(aiDiv);
        chatWindow.appendChild(document.createElement('div')).style.clear = 'both'; 

    } catch (e) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'chat-message ai-msg';
        errorDiv.innerText = 'L·ªói: ƒê√£ x·∫£y ra l·ªói trong qu√° tr√¨nh x·ª≠ l√Ω m√¥ ph·ªèng.';
        chatWindow.appendChild(errorDiv);
        chatWindow.appendChild(document.createElement('div')).style.clear = 'both'; 

    } finally {
        isProcessing = false;
        input.disabled = false;
        sendBtn.disabled = false;
        loader.style.display = 'none';
        chatWindow.scrollTop = chatWindow.scrollHeight;
        input.value = '';
    }
}


/* ==========================================================================
   PH·∫¶N 2: C√ÅC T√çNH NƒÇNG C·ªêT L√ïI V√Ä GIAO DI·ªÜN
   ========================================================================== */
let currentStream = null;
let videoInterval = null;
// D·ªØ li·ªáu m·∫´u gi·∫£ ƒë·ªãnh QR qu√©t th√†nh c√¥ng (ƒê√É C·∫¨P NH·∫¨T: Th√™m youtubeUrl)
const mockArtifactData = { id: "artifact_123", type: "artifact", name: "T∆∞·ª£ng Tr·∫ßn H∆∞ng ƒê·∫°o", floor: 1, pos: "C·ªï v·∫≠t", model: "tuong+tran+hung+dao.glb", youtubeUrl: "https://youtu.be/G18c1CZdyFk?si=8mQuffOJWBNzAVC" }; // URL YouTube m·ªõi
const mockArtifactData2 = { id: "artifact_456", type: "artifact", name: "ƒê√†i th·ªù Tr√† Ki·ªáu", floor: 3, pos: "VƒÉn h√≥a", model: "dai+tho+tra+kieu.glb", youtubeUrl: "https://youtu.be/G18c1CZdyFk?si=8mQuffOJWBNzAVC" }; 

let currentArtifactData = null; // Bi·∫øn l∆∞u d·ªØ li·ªáu hi·ªán v·∫≠t ƒëang hi·ªÉn th·ªã
let currentArtifactQuizData = null; // Bi·∫øn t·∫°m l∆∞u quiz data khi ƒëang l√†m b√†i
let selectedDestinationMarkerId = null;

function showAlert(message) { console.log("[Th√¥ng b√°o]: " + message); }

function showTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active-tab'));
  document.getElementById(tabId).classList.add('active-tab');
  
  document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
  const activeNavItem = document.querySelector(`.nav-item[onclick*="${tabId}"]`);
  if (activeNavItem) activeNavItem.classList.add('active');

  if (tabId !== 'qr-tab') stopCamera();
  if (tabId === 'map-tab') changeFloor();
  
  // N√¢ng c·∫•p: Khi m·ªü tab Profile, c·∫≠p nh·∫≠t th√¥ng tin
  if (tabId === 'profile-tab') {
      showProfileSubScreen('profile-main-view'); // Default to main view
      renderProfileMain(); // Render main view content
      renderProfileHistoryQuiz(); // Pre-render/update sub-view data
  }
  
  // ƒê·∫£m b·∫£o Quiz standalone screen lu√¥n b·ªã ·∫©n khi chuy·ªÉn tab
  document.getElementById('quiz-standalone-screen').classList.add('hidden');
}

// ** KH·∫ÆC PH·ª§C L·ªñI:** ƒê·∫£m b·∫£o ·∫©n m√†n h√¨nh c≈© v√† hi·ªán m√†n h√¨nh m·ªõi
function goToLogin() { 
    document.getElementById('wifi-screen').classList.add('hidden'); 
    document.getElementById('login-screen').classList.remove('hidden'); 
    document.getElementById('main-screen').classList.add('hidden'); // ƒê·∫£m b·∫£o m√†n h√¨nh ch√≠nh ·∫©n
    document.getElementById('quiz-standalone-screen').classList.add('hidden'); // ƒê·∫£m b·∫£o quiz ·∫©n
}

function goToMain() { 
    document.getElementById('login-screen').classList.add('hidden'); 
    document.getElementById('main-screen').classList.remove('hidden'); 
    document.getElementById('wifi-screen').classList.add('hidden'); // ƒê·∫£m b·∫£o m√†n h√¨nh wifi ·∫©n
    document.getElementById('quiz-standalone-screen').classList.add('hidden'); // ƒê·∫£m b·∫£o quiz ·∫©n
    showTab('intro-tab'); 
}

function logout() { 
    document.getElementById('main-screen').classList.add('hidden'); 
    document.getElementById('login-screen').classList.remove('hidden'); 
    document.getElementById('wifi-screen').classList.add('hidden'); 
    document.getElementById('quiz-standalone-screen').classList.add('hidden');
}

// --- QR & CAMERA LOGIC (N√ÇNG C·∫§P TH·ª∞C T·∫æ) ---
async function startCamera() {
  stopCamera(); 
  const video = document.getElementById('camera-preview');
  const canvas = document.getElementById('camera-canvas');
  const context = canvas.getContext('2d');
  const placeholder = document.getElementById('camera-placeholder');
  const scanBtn = document.getElementById('scan-button');
  const stopBtn = document.getElementById('stop-button');
  const scannerLine = document.getElementById('scanner-line-wrapper');
  const qrResult = document.getElementById('qr-result');

  // ·∫®n Quiz khi b·∫Øt ƒë·∫ßu qu√©t
  document.getElementById('quiz-standalone-screen').classList.add('hidden');

  qrResult.style.display = 'none';
  placeholder.style.display = 'flex'; placeholder.innerText = 'ƒêang kh·ªüi ƒë·ªông Camera...';
  scanBtn.style.display = 'none';

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    currentStream = stream; video.srcObject = stream; video.style.display = 'block';
    
    // Ch·ªù video ƒë∆∞·ª£c t·∫£i metadata
    await new Promise(resolve => {
        video.onloadedmetadata = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            resolve();
        };
    });

    placeholder.style.display = 'none'; stopBtn.style.display = 'inline-block'; scannerLine.classList.remove('hidden');
    
    // T·ªâ l·ªá cho canvas/video trong UI
    const wrapper = document.getElementById('camera-wrapper');
    video.style.height = `${wrapper.offsetHeight}px`;
    video.style.width = `${wrapper.offsetWidth}px`;

    // B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p qu√©t QR
    videoInterval = setInterval(() => {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            // C·∫ßn resize canvas ƒë·ªÉ kh·ªõp v·ªõi video/wrapper size trong v√≤ng l·∫∑p
            const rect = wrapper.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            video.style.width = `${rect.width}px`;
            video.style.height = `${rect.height}px`;

            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });

            if (code) {
                clearInterval(videoInterval); // D·ª´ng qu√©t
                stopCamera();
                handleScanSuccess(code.data);
                scanBtn.style.display = 'inline-block'; scanBtn.innerText = 'Qu√©t l·∫°i';
            }
        }
    }, 100);

    showAlert("Camera ƒë√£ s·∫µn s√†ng. ƒêang qu√©t...");
  } catch (err) {
    console.error("L·ªói Camera:", err);
    placeholder.innerText = 'L·ªói Camera: Kh√¥ng th·ªÉ truy c·∫≠p.'; 
    scanBtn.style.display = 'inline-block'; stopBtn.style.display = 'none';
  }
}

function stopCamera() {
  if (videoInterval) clearInterval(videoInterval);
  videoInterval = null;
  if (currentStream) currentStream.getTracks().forEach(track => track.stop());
  currentStream = null;
  const video = document.getElementById('camera-preview');
  video.style.display = 'none'; video.srcObject = null;
  document.getElementById('camera-placeholder').style.display = 'flex';
  document.getElementById('scan-button').style.display = 'inline-block';
  document.getElementById('stop-button').style.display = 'none';
  document.getElementById('scanner-line-wrapper').classList.add('hidden');
}

// --- NEW FUNCTION: M√¥ ph·ªèng ch·ªâ cho hi·ªán v·∫≠t Tr·∫ßn H∆∞ng ƒê·∫°o (artifact_123) ---
function mockScanArtifact1() {
    stopCamera();
    const scanData = mockArtifactData; // L·∫•y d·ªØ li·ªáu Tr·∫ßn H∆∞ng ƒê·∫°o
    
    const existing = visitedArtifacts.find(a => a.id === scanData.id);
    if (!existing) {
        visitedArtifacts.push({ id: scanData.id, name: scanData.name });
        // Kh·ªüi t·∫°o tr·∫°ng th√°i Quiz n·∫øu ch∆∞a c√≥
        if (!artifactQuizStatus[scanData.id]) {
            artifactQuizStatus[scanData.id] = { 
                done: false, 
                score: 0, 
                selections: {}, 
                total: artifactQuizData.length 
            };
        }
        showAlert(`M√¥ ph·ªèng: Qu√©t th√†nh c√¥ng hi·ªán v·∫≠t: ${scanData.name}. ƒê√£ th√™m v√†o H·ªì s∆°.`);
    } else {
        showAlert(`M√¥ ph·ªèng: Qu√©t l·∫°i hi·ªán v·∫≠t: ${scanData.name}. (ƒê√£ c√≥ trong H·ªì s∆°).`);
    }

    // G√°n d·ªØ li·ªáu hi·ªán v·∫≠t ƒëang hi·ªÉn th·ªã v√† c·∫≠p nh·∫≠t UI
    currentArtifactData = scanData; 
    handleScanSuccess(JSON.stringify(scanData)); 
    
    // ƒê·∫£m b·∫£o n√∫t ƒëi·ªÅu khi·ªÉn camera ƒë∆∞·ª£c reset (ch·ªâ hi·ªán n√∫t qu√©t l·∫°i/m√¥ ph·ªèng)
    document.getElementById('scan-button').innerText = 'Qu√©t l·∫°i';
    document.getElementById('scan-button').style.display = 'inline-block';
}


function handleScanSuccess(json) {
  try {
      const data = JSON.parse(json);
      currentArtifactData = data; // L∆∞u d·ªØ li·ªáu qu√©t v√†o bi·∫øn to√†n c·ª•c
      currentArtifactQuizData = null; // Reset quiz data t·∫°m th·ªùi
      
      const titleEl = document.getElementById('data-title');
      const detailsEl = document.getElementById('scanned-details');
      const youtubeBtn = document.getElementById('youtube-button');
      const view360Btn = document.getElementById('view360-button');
      const startQuizBtn = document.getElementById('start-quiz-button-qr');
      
      // Reset interaction buttons & viewers
      youtubeBtn.style.display = 'none'; view360Btn.style.display = 'none';
      document.getElementById('artifact-360-display').style.display = 'none';
      document.getElementById('video-container').style.display = 'none'; 
      
      // ·∫®n Quiz Standalone Screen
      document.getElementById('quiz-standalone-screen').classList.add('hidden');
      
      if (data.type === 'artifact' && data.name) {
        // ƒê√¢y l√† hi·ªán v·∫≠t -> HI·ªÇN TH·ªä TH√îNG TIN
        titleEl.innerText = `Th√¥ng tin hi·ªán v·∫≠t: ${data.name}`;
        detailsEl.innerHTML = `<p><b>ID:</b> ${data.id}</p><p><b>V·ªã tr√≠:</b> T·∫ßng ${data.floor} - Khu ${data.pos}</p>`;
        
        // Hi·ªán n√∫t YouTube n·∫øu c√≥ URL
        if (data.youtubeUrl) {
            youtubeBtn.style.display = 'inline-block';
        }

        // Hi·ªán n√∫t 360/AR n·∫øu c√≥ model (M√¥ ph·ªèng: artifact_123 v√† artifact_456 ƒë·ªÅu c√≥)
        if (data.id === 'artifact_123' || data.id === 'artifact_456') {
            view360Btn.style.display = 'inline-block';
        }
        
        // Hi·ªán n√∫t Quiz n·∫øu c√≥ Quiz cho hi·ªán v·∫≠t n√†y
        if (getQuizForArtifact(data.id)) {
            startQuizBtn.style.display = 'inline-block';
        } else {
            startQuizBtn.style.display = 'none';
        }
        
        showAlert(`Qu√©t th√†nh c√¥ng: ${data.name}`);
        
      } else {
        // KH√îNG PH·∫¢I HI·ªÜN V·∫¨T -> HI·ªÇN TH·ªä TH√îNG B√ÅO L·ªñI/CHUNG
        titleEl.innerText = "K·∫øt qu·∫£ qu√©t";
        detailsEl.innerText = "D·ªØ li·ªáu kh√¥ng ph·∫£i l√† hi·ªán v·∫≠t (V√≠ d·ª•: M√£ v√© ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω l√∫c ƒêƒÉng nh·∫≠p).";
        startQuizBtn.style.display = 'none';
      }
      document.getElementById('qr-result').style.display = 'flex';
      
      // C·∫ßn c·∫≠p nh·∫≠t profile n·∫øu ƒëang ·ªü tab profile
      if (document.getElementById('profile-tab').classList.contains('active-tab')) {
          renderProfileMain(); // Update main view score/reward status
          renderProfileHistoryQuiz(); // Update history/quiz view
      }
      
  } catch(e) {
      console.error("L·ªói ph√¢n t√≠ch QR Data:", e);
      document.getElementById('data-title').innerText = "L·ªói d·ªØ li·ªáu QR";
      document.getElementById('scanned-details').innerText = "D·ªØ li·ªáu QR kh√¥ng h·ª£p l·ªá.";
      document.getElementById('qr-result').style.display = 'flex';
  }
}

// --- NEW VIDEO FEATURE (ƒê√É C·∫¨P NH·∫¨T ƒë·ªÉ m·ªü YouTube link) ---
function playVideoPresentation() {
    if (currentArtifactData && currentArtifactData.youtubeUrl) {
        // T·∫Øt 3D viewer n·∫øu ƒëang m·ªü
        document.getElementById('artifact-360-display').style.display = 'none';

        // M·ªü URL YouTube trong tab m·ªõi
        window.open(currentArtifactData.youtubeUrl, '_blank');
        showAlert(`ƒêang m·ªü video thuy·∫øt minh tr√™n YouTube: ${currentArtifactData.youtubeUrl}`);
        
        // LOGIC K√çCH HO·∫†T QUIZ B·ªä X√ìA (gi·ªù l√† n√∫t B·∫Øt ƒë·∫ßu)
        
    } else {
        showAlert("L·ªói: Kh√¥ng t√¨m th·∫•y li√™n k·∫øt YouTube.");
    }
}

// --- 3D VIEWER FEATURE (UPDATED) ---
function view360() { 
    const d = document.getElementById('artifact-360-display');
    
    // T·∫ÆT VIDEO CONTAINER ƒê·ªÇ ƒê·∫¢M B·∫¢O CH·ªà 1 VIEW M·ªû M·ªñI L·∫¶N
    document.getElementById('video-container').style.display = 'none';

    d.style.display = 'block';
    
    // ƒê√£ thay ƒë·ªïi t·ª´ Horse.glb sang Astronaut.glb ƒë·ªÉ m√¥ ph·ªèng h√¨nh ng∆∞·ªùi
    const modelSrc = 'https://modelviewer.dev/shared-assets/models/Astronaut.glb'; 
    // D·ªØ li·ªáu mock: T√™n hi·ªán v·∫≠t hi·ªán t·∫°i
    const artifactName = currentArtifactData ? currentArtifactData.name : 'Hi·ªán v·∫≠t L·ªãch s·ª≠';
    
    d.innerHTML = `
      <model-viewer 
        src="${modelSrc}" 
        ios-src="tuong+tran+hung+dao.usdz"
        poster="https://placehold.co/400x300/eafaea/000000?text=Mo+Hinh+3D+${artifactName.toUpperCase()}" 
        alt="M√¥ h√¨nh 3D ${artifactName}"
        shadow-intensity="1"
        camera-controls
        auto-rotate
        ar
        style="width: 100%; height: 100%;"
      >
        <button slot="ar-button" style="background-color: var(--accent-color); color: var(--text-dark); border-radius: 4px; border: none; position: absolute; top: 16px; right: 16px; height: 30px; font-weight: 600; padding: 0 10px;">
            üëã K√≠ch ho·∫°t AR
        </button>
      </model-viewer>
    `;
    
    showAlert(`ƒê√£ t·∫£i khung nh√¨n 3D/AR ${artifactName}.`);
    
    // LOGIC K√çCH HO·∫†T QUIZ B·ªä X√ìA (gi·ªù l√† n√∫t B·∫Øt ƒë·∫ßu)
}

/* ==========================================================================
   PH·∫¶N 3: MAP & PATHFINDING LOGIC (GI·ªÆ NGUY√äN)
   ========================================================================== */
const floorData = {
    1: {
        bg: "https://placehold.co/400x300/a2d9ce/000000?text=SO+DO+TANG+1",
        markers: [
            { id: 'pos-current', type: 'current', top: '70%', left: '50%', title: 'V·ªã tr√≠ hi·ªán t·∫°i' },
            { id: 'wc-1', type: 'toilet', top: '60%', left: '20%', title: 'Nh√† v·ªá sinh (T1)' },
            { id: 'disp-1-1', type: 'display', top: '50%', left: '70%', title: 'Tr∆∞ng b√†y C·ªï v·∫≠t ChƒÉm' },
            { id: 'info-1-1', type: 'info', top: '25%', left: '80%', title: 'Qu·∫ßy Th√¥ng tin' },
            { id: 'disp-1-2', type: 'display', top: '75%', left: '30%', title: 'Tr∆∞ng b√†y L·ªãch s·ª≠ T·ª± nhi√™n' } 
        ]
    },
    2: {
        bg: "https://placehold.co/400x300/f9e79f/000000?text=SO+DO+TANG+2",
        markers: [
            { id: 'pos-current', type: 'current', top: '55%', left: '45%', title: 'V·ªã tr√≠ hi·ªán t·∫°i' },
            { id: 'disp-2-1', type: 'display', top: '40%', left: '30%', title: 'Tr∆∞ng b√†y Kh√°ng chi·∫øn' },
            { id: 'disp-2-2', type: 'display', top: '80%', left: '60%', title: 'Tr∆∞ng b√†y L·ªãch s·ª≠ ƒê√¥ th·ªã' }
        ]
    },
    3: {
        bg: "https://placehold.co/400x300/d7bde2/000000?text=SO+DO+TANG+3",
        markers: [
            { id: 'pos-current', type: 'current', top: '30%', left: '50%', title: 'V·ªã tr√≠ hi·ªán t·∫°i' },
            { id: 'disp-3-1', type: 'display', top: '35%', left: '20%', title: 'Tr∆∞ng b√†y VƒÉn h√≥a ChƒÉm' }
        ]
    }
};
let activeFilters = { display:true, toilet:true, info:true, current:true };

function toggleFilter(type) {
    activeFilters[type] = !activeFilters[type];
    const filterEl = document.getElementById(`filter-${type}`);
    if(filterEl) {
        filterEl.classList.toggle('active', activeFilters[type]);
    }
    
    // ·∫®n/hi·ªán c√°c marker t∆∞∆°ng ·ª©ng
    document.querySelectorAll(`.marker-${type}`).forEach(el => {
        el.style.display = activeFilters[type] ? 'block' : 'none';
    });
}

function updateDestinationOptions(floor) {
    const destSelect = document.getElementById('destination-select');
    destSelect.innerHTML = '<option value="" selected>Ch·ªçn ƒëi·ªÉm ƒë·∫øn...</option>';

    if (floorData[floor]) {
        floorData[floor].markers.forEach(m => {
            if (m.type === 'display' || m.type === 'info' || m.type === 'toilet') {
                const option = document.createElement('option');
                option.value = m.id;
                option.innerText = m.title;
                destSelect.appendChild(option);
            }
        });
    }
}

function selectDestination(markerId) {
    selectedDestinationMarkerId = markerId;
    const destSelect = document.getElementById('destination-select');

    // KH·∫ÆC PH·ª§C L·ªñI: ƒê·∫£m b·∫£o markerId t·ªìn t·∫°i trong danh s√°ch options c·ªßa select
    const optionExists = Array.from(destSelect.options).some(opt => opt.value === markerId);
    if (optionExists) {
        destSelect.value = markerId;
    } else {
        // N·∫øu markerId kh√¥ng thu·ªôc t·∫ßng hi·ªán t·∫°i, ch·ªâ highlight v√† kh√¥ng set select
        // Ho·∫∑c c√≥ th·ªÉ kh√¥ng l√†m g√¨ c·∫£ n·∫øu marker kh√¥ng thu·ªôc t·∫ßng hi·ªán t·∫°i.
        // ƒê·ªÉ ƒë∆°n gi·∫£n, ch·ªâ x·ª≠ l√Ω highlight n·∫øu marker ƒë√≥ ƒëang hi·ªÉn th·ªã
    }

    // Highlight marker
    document.querySelectorAll('.map-marker').forEach(el => el.classList.remove('marker-selected'));
    const selectedMarker = document.getElementById(markerId);
    if (selectedMarker) {
        selectedMarker.classList.add('marker-selected');
        showAlert(`ƒê√£ ch·ªçn: ${selectedMarker.title} l√†m ƒëi·ªÉm ƒë·∫øn.`);
        
        // T·ª∞ ƒê·ªòNG G·ªåI findPath() sau khi ch·ªçn ƒëi·ªÉm ƒë·∫øn
        findPath();
    }
}

function changeFloor() {
  const f = document.getElementById('floor-select').value;
  const d = floorData[f];
  const mc = document.getElementById('map-container');
  mc.style.backgroundImage = `url(${d.bg})`;
  mc.querySelectorAll('.map-marker').forEach(e => e.remove());
  
  updateDestinationOptions(f);
  selectedDestinationMarkerId = null; // Reset selection on floor change
  
  d.markers.forEach(m => {
      const el = document.createElement('div'); el.id = m.id; el.className = `map-marker marker-${m.type}`;
      el.style.top = m.top; el.style.left = m.left; el.title = m.title;
      el.innerText = m.type === 'current' ? 'üìç' : (m.type === 'toilet' ? 'üöª' : (m.type === 'display' ? 'üñºÔ∏è' : '‚ÑπÔ∏è'));
      el.setAttribute('data-type', m.type);
      
      // Th√™m s·ª± ki·ªán click ƒë·ªÉ ch·ªçn ƒëi·ªÉm ƒë·∫øn
      if (m.type !== 'current') {
          // ƒê√£ s·ª≠a: H√†m selectDestination s·∫Ω t·ª± ƒë·ªông g·ªçi findPath()
          el.onclick = () => selectDestination(m.id);
      }

      if(!activeFilters[m.type]) el.style.display='none';
      mc.appendChild(el);
  });
  
  const line = document.getElementById('path-line');
  line.style.display='none'; line.classList.remove('path-active');
  showAlert(`ƒê√£ chuy·ªÉn sang T·∫ßng ${f}`);
}

function findPath() {
    const destinationId = document.getElementById('destination-select').value;
    const currentFloor = document.getElementById('floor-select').value;
    const startMarker = document.getElementById('pos-current');
    const endMarker = document.getElementById(destinationId);

    if (!destinationId || !endMarker) {
        showAlert("Vui l√≤ng ch·ªçn m·ªôt ƒëi·ªÉm ƒë·∫øn tr∆∞·ªõc.");
        return;
    }

    const endFloor = endMarker.id.split('-')[1];

    if (currentFloor !== endFloor) {
        showAlert(`ƒêang chuy·ªÉn v·ªÅ T·∫ßng ${endFloor} ƒë·ªÉ t√¨m ƒë∆∞·ªùng...`);
        document.getElementById('floor-select').value = endFloor;
        // B·∫Øt s·ª± ki·ªán onchange ƒë·ªÉ g·ªçi changeFloor()
        document.getElementById('floor-select').dispatchEvent(new Event('change'));
        
        // C·∫ßn ch·ªù DOM c·∫≠p nh·∫≠t sau khi g·ªçi changeFloor (d√π ƒë√£ g·ªçi changeFloor() qua event, v·∫´n c·∫ßn ƒë·ªô tr·ªÖ)
        setTimeout(() => {
             const newStart = document.getElementById('pos-current');
             const newEnd = document.getElementById(destinationId);
             if(newStart && newEnd) _drawPath(newStart, newEnd);
        }, 300); 
    } else { 
        if (startMarker && endMarker) {
             _drawPath(startMarker, endMarker);
        } else {
             showAlert("Kh√¥ng t√¨m th·∫•y ƒëi·ªÉm b·∫Øt ƒë·∫ßu ho·∫∑c ƒëi·ªÉm k·∫øt th√∫c.");
        }
    }
}

function _drawPath(startEl, endEl) {
    const pathLine = document.getElementById('path-line');
    pathLine.style.display = 'none'; pathLine.classList.remove('path-active');

    const startX = startEl.offsetLeft + (startEl.offsetWidth / 2);
    const startY = startEl.offsetTop + (startEl.offsetHeight / 2);
    const endX = endEl.offsetLeft + (endEl.offsetWidth / 2);
    const endY = endEl.offsetTop + (endEl.offsetHeight / 2);

    const dx = endX - startX;
    const dy = endY - startY;
    const dist = Math.sqrt(dx * dx + dy * dy);
    
    // Math.atan2(dx, dy) t√≠nh g√≥c xoay theo chi·ªÅu kim ƒë·ªìng h·ªì so v·ªõi tr·ª•c Y d∆∞∆°ng (h∆∞·ªõng xu·ªëng).
    const angleRad = Math.atan2(dx, dy); 
    const angle = angleRad * 180 / Math.PI; // Chuy·ªÉn sang ƒë·ªô

    pathLine.style.transformOrigin = `top center`;
    // ƒê·∫∑t transform ƒë·ªÉ xoay theo g√≥c m·ªõi
    pathLine.style.transform = `rotate(${angle}deg)`;
    
    // ƒê·∫∑t v·ªã tr√≠ b·∫Øt ƒë·∫ßu l√† t√¢m c·ªßa marker b·∫Øt ƒë·∫ßu
    pathLine.style.top = `${startY}px`; 
    pathLine.style.left = `${startX - 2.5}px`; // Tr·ª´ 2.5 ƒë·ªÉ cƒÉn gi·ªØa (v√¨ width l√† 5px)
    
    pathLine.style.height = '0px'; 
    pathLine.style.transition = 'none'; pathLine.style.display = 'block';

    setTimeout(() => {
        pathLine.style.transition = 'height 1.5s ease-in-out';
        pathLine.style.height = `${dist}px`;
        pathLine.classList.add('path-active');
        showAlert("ƒê√£ t√¨m th·∫•y ƒë∆∞·ªùng! ƒêi theo v·∫°ch k·∫ª.");
    }, 50);
}

function resetMap() {
    document.getElementById('path-line').style.display='none';
    document.getElementById('destination-select').value = '';
    selectedDestinationMarkerId = null;
    document.querySelectorAll('.map-marker').forEach(el => el.classList.remove('marker-selected'));

    ['display','toilet','info','current'].forEach(t => { 
        activeFilters[t]=true; 
        const filterEl = document.getElementById(`filter-${t}`);
        if(filterEl) filterEl.classList.add('active'); 
    });
    // G·ªçi changeFloor ƒë·ªÉ t·∫£i l·∫°i b·∫£n ƒë·ªì v·ªõi filter reset
    changeFloor();
}

// Init
document.addEventListener('DOMContentLoaded', () => {
    // Kh√¥ng c·∫ßn loadKnowledgeBase n·ªØa
    // Kh·ªüi t·∫°o changeFloor sau m·ªôt ch√∫t ƒë·ªô tr·ªÖ ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ s·∫µn s√†ng
    setTimeout(changeFloor, 100); 
    renderProfile(); // Kh·ªüi t·∫°o l·∫ßn ƒë·∫ßu
    updateProfileDisplay(); // ƒê·∫£m b·∫£o profile hi·ªÉn th·ªã ƒë√∫ng
});

// Lang
function selectLang(l) { document.getElementById('lang-display').innerText = l==='vi'?'üåê VI':'üåê EN'; document.getElementById('lang-options').style.display='none'; }
function toggleLangOptions() { const o=document.getElementById('lang-options'); o.style.display=o.style.display==='flex'?'none':'flex'; }
</script>
</body>
</html>
