<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>B·∫£o t√†ng ƒê√† N·∫µng ‚Äì ·ª®ng d·ª•ng Th√¥ng minh</title>
<!-- ƒê√£ ƒë·ªïi sang Noto Sans cho ch·ªØ ƒë·∫πp v√† h·ªó tr·ª£ ti·∫øng Vi·ªát t·ªët h∆°n -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<!-- Th√™m th∆∞ vi·ªán Model Viewer ƒë·ªÉ xem 3D -->
<script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
<!-- Th√™m th∆∞ vi·ªán jsQR ƒë·ªÉ qu√©t m√£ QR -->
<script src="https://cdn.jsdelivr.net/npm/jsQR@1.1.0/dist/jsQR.min.js"></script>
<style>
/* --- 1. BI·∫æN V√Ä THI·∫æT L·∫¨P CHUNG --- */
:root {
  --primary-color: #2ecc71; /* Fresh Green */
  --primary-dark: #27ae60; /* Darker Green */
  --accent-color: #f39c12; /* Sun Yellow/Orange */
  --bg-light: #f5fcf5; /* Very light green background */
  --bg-card: #ffffff;
  --text-dark: #2c3e50; 
  --nav-active-bg: #eafaea; /* Lightest green for active nav */
}

body {
  background: var(--bg-light);
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  margin: 0;
  /* ƒê√£ c·∫≠p nh·∫≠t Font ch√≠nh */
  font-family: 'Noto Sans', sans-serif; 
}

.phone {
  position: relative;
  width: 390px;
  height: 780px;
  border: 8px solid var(--text-dark);
  border-radius: 48px;
  background: #000;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.screen {
  background: var(--bg-light);
  width: 100%;
  height: 100%;
  border-radius: 40px; 
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  padding: 10px;
  box-sizing: border-box;
  color: var(--text-dark);
  transition: all 0.4s ease-in-out;
  overflow: hidden;
  position: relative;
}

.login-screen { justify-content: center; }
.hidden { display: none; }

h2 { font-size: 24px; font-weight: 700; margin-bottom: 12px; color: var(--primary-dark); }
h3 { 
  font-size: 20px; 
  font-weight: 600; 
  margin: 15px 0 10px; 
  color: var(--primary-dark); 
  border-bottom: 3px solid var(--accent-color); 
  padding-bottom: 8px;
  width: 95%;
  text-align: center;
}
h4 { font-size: 16px; font-weight: 600; margin-bottom: 8px; color: var(--primary-dark); }
p { font-size: 14px; color: #555; margin-bottom: 5px; text-align: justify; line-height: 1.5; }
ul { padding-left: 20px; text-align: left; }

/* --- 2. N√öT V√Ä INPUT --- */
button {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
  color: white;
  border: none;
  border-radius: 14px;
  padding: 14px 25px;
  margin: 8px 0;
  font-size: 16px;
  cursor: pointer;
  transition: 0.3s ease;
  font-weight: 600;
  box-shadow: 0 6px 20px rgba(46, 204, 113, 0.3); 
}
button:hover { transform: translateY(-2px) scale(1.01); box-shadow: 0 8px 25px rgba(46, 204, 113, 0.4); }
button:active { transform: translateY(0); box-shadow: 0 4px 15px rgba(46, 204, 113, 0.2); }

input[type="text"], select {
  padding: 12px;
  border-radius: 12px;
  border: 1px solid #ccc;
  width: 95%;
  margin-bottom: 15px; 
  font-size: 15px;
  outline: none;
  transition: all 0.3s;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
}
input[type="text"]:focus, select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.2); }

/* --- 3. THANH ƒêI·ªÄU H∆Ø·ªöNG --- */
.bottom-nav {
  display: flex;
  justify-content: space-around;
  align-items: center;
  background: var(--bg-card);
  padding: 10px 0;
  border-radius: 0 0 40px 40px; 
  width: 100%;
  box-shadow: 0 -5px 20px rgba(0,0,0,0.1); 
  border-top: 1px solid #eee;
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 11px;
  font-weight: 500;
  color: #7f8c8d;
  transition: all 0.3s;
  padding: 8px 10px;
  border-radius: 100px;
  min-width: 60px;
}
.nav-item span { font-size: 28px; margin-bottom: 2px; }
.nav-item.active { 
  color: var(--primary-dark);
  font-weight: 600;
  background-color: var(--nav-active-bg);
  box-shadow: 0 2px 10px rgba(46, 204, 113, 0.2);
  transform: translateY(-2px);
}
.nav-item.active span { color: var(--primary-dark); transform: scale(1.05); }

/* --- 4. N·ªòI DUNG CH√çNH --- */
.tab-content {
  flex: 1;
  width: 100%;
  overflow-y: auto;
  display: none;
  flex-direction: column;
  align-items: center;
  padding: 5px;
  box-sizing: border-box;
}
.active-tab { display: flex; animation: fadeInUp 0.5s ease-out; }

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.info-card { 
  background: var(--bg-card);
  border-radius: 16px;
  padding: 15px;
  width: 95%;
  margin-bottom: 15px;
  text-align: left;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  border-left: 5px solid var(--accent-color);
  transition: transform 0.3s;
}
.achievement-card {
    background: #eafaea; 
    border-left: 5px solid var(--primary-dark);
    text-align: center;
    padding: 15px;
}
.achievement-card h4 {
    margin-top: 0;
    color: var(--primary-dark);
}
.achievement-card p {
    text-align: center;
    color: var(--text-dark);
}
.quiz-question {
    background: var(--bg-card);
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.quiz-option {
    display: block;
    width: 100%;
    text-align: left;
    background: #f7f7f7;
    color: var(--text-dark);
    border: 1px solid #ddd;
    padding: 10px;
    margin: 5px 0;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
    font-size: 14px;
}
.quiz-option:hover { background: #eee; }
.correct-answer { background: #c8e6c9 !important; border-color: #388e3c !important; color: #1b5e20 !important; font-weight: 600; }
.incorrect-answer { background: #ffcdd2 !important; border-color: #d32f2f !important; color: #b71c1c !important; font-weight: 600; } 

.quiz-result-message {
    padding: 10px;
    border-radius: 8px;
    margin-top: 10px;
    font-weight: 600;
    text-align: center;
}
.quiz-success {
    background-color: #d1e5d4;
    color: #1b5e20;
}
.quiz-fail {
    background-color: #ffcdd2;
    color: #b71c1c;
}


.login-card {
  background: var(--bg-card);
  border-radius: 25px;
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15); 
  padding: 30px 25px;
  width: 85%;
  max-width: 350px;
  text-align: center;
}

/* --- 5. CHATBOT --- */
.chat-window {
  background: var(--bg-light); 
  border: 1px solid #eee;
}
.chat-message { 
  font-size: 14px; 
  margin-bottom: 10px; 
  padding: 10px 14px; 
  border-radius: 18px; 
  display: inline-block; 
  max-width: 85%;
  transition: all 0.3s;
}
.user-msg { 
    background: var(--primary-color); 
    color: #fff; 
    float: right; 
    border-radius: 18px 18px 0 18px; 
    box-shadow: 0 2px 8px rgba(46, 204, 113, 0.3);
}
.ai-msg { 
    background: #e3f2fd; 
    color: var(--text-dark); 
    float: left; 
    border-radius: 18px 18px 18px 0; 
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}
.chat-window::after { content: ""; display: table; clear: both; }

#loader {
    display: none; 
    border: 4px solid #f3f3f3; 
    border-top: 4px solid var(--primary-color); 
    border-radius: 50%;
    width: 20px; height: 20px;
    animation: spin 1s linear infinite;
    margin: 5px;
    float: left;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* --- Quick Question Buttons --- */
#quick-questions {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
    width: 95%;
    margin-bottom: 10px;
}
.quick-q-btn {
    background: #ffffff;
    color: var(--primary-dark);
    border: 1px solid var(--primary-color);
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 12px;
    cursor: pointer;
    transition: 0.3s;
    flex-grow: 1;
    min-width: 100px;
    max-width: 48%;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.quick-q-btn:hover {
    background: var(--primary-color);
    color: white;
    box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);
}

/* --- 6. QR SCANNER & VIDEO PLAYER & 3D --- */
#camera-preview, #login-camera-preview {
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
    border-radius: 12px;
}
#camera-wrapper, #login-camera-wrapper {
    width: 90%; 
    height: 240px; 
    margin-top: 15px; 
    position: relative;
    margin-left: auto;
    margin-right: auto;
}
#camera-canvas, #login-camera-canvas {
    position: absolute; top: 0; left: 0; z-index: 5;
    display: none; 
}

.scanner-frame {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 70%; height: 70%; border: 3px solid var(--accent-color);
    box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.6); pointer-events: none; z-index: 10;
}
.scanner-line {
    position: absolute; left: 0; width: 100%; height: 4px;
    background: #ff4081; box-shadow: 0 0 15px #ff4081;
    animation: scan 2s infinite linear;
}
@keyframes scan { 0% { top: 0%; } 50% { top: 100%; } 100% { top: 0%; } }

#qr-result { border-left: 5px solid var(--primary-color); background: var(--nav-active-bg); }

#video-container {
    width: 100%;
    margin-top: 10px;
    display: none; 
    background: black;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

#artifact-360-display {
    width: 100%; 
    height: 480px; 
    background: #f0f0f0; 
    margin-top: 10px; 
    display: none; 
    border-radius: 12px; 
    position: relative;
    overflow: hidden;
    border: 1px solid #ccc;
    animation: fadeInUp 0.4s ease-out;
}

/* --- 7. MAP UI --- */
#map-container { 
    position: relative; width: 95%; height: 350px; border-radius: 12px; overflow: hidden; margin-bottom: 15px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.15); background-color: #ecf0f1; background-size: cover; background-position: center; border: 1px solid #ddd;
}
.map-marker { 
    position: absolute; font-size: 24px; cursor: pointer;
    transition: transform 0.3s, opacity 0.3s; filter: drop-shadow(1px 1px 3px rgba(0,0,0,0.4));
}
.map-marker:hover { transform: scale(1.2); z-index: 20; }
.marker-current { color: #3498db; animation: pulse-dot 1.5s infinite ease-out; font-size: 30px; }
@keyframes pulse-dot { 0% { transform: scale(0.8); opacity: 0.9; } 50% { transform: scale(1.1); opacity: 0.6; } 100% { transform: scale(0.8); opacity: 0.9; } }
.marker-toilet { color: #e74c3c; } 
.marker-display { color: var(--accent-color); } 
.marker-info { color: var(--primary-dark); } 

.marker-selected {
    box-shadow: 0 0 0 5px rgba(243, 156, 18, 0.5); 
    border-radius: 50%;
}

#path-line {
    position: absolute; width: 5px; background: linear-gradient(to bottom, var(--primary-dark), #3498db);
    box-shadow: 0 0 15px rgba(46, 204, 113, 0.7); border-radius: 3px; z-index: 10; pointer-events: none; display: none;
}
.path-active { animation: path-glow 0.8s infinite alternate; }
@keyframes path-glow { from { opacity: 0.8; } to { opacity: 1; } }

.map-filters {
    display: flex;
    justify-content: space-around;
    align-items: center;
    width: 95%;
    background: var(--bg-card);
    padding: 10px 0;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    margin-bottom: 15px;
    border: 1px solid #eee;
}
.filter-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    opacity: 0.6;
    font-size: 12px;
}
.filter-item.active {
    opacity: 1;
    font-weight: 600;
    transform: scale(1.05);
}
.filter-item span { font-size: 20px; }

#lang-icon { position: absolute; top: 35px; right: 35px; z-index: 100; cursor: pointer; background: white; padding: 6px 12px; border-radius: 20px; box-shadow: 0 3px 10px rgba(0,0,0,0.15); font-weight: 600; display: flex; align-items: center; }
#lang-options { position: absolute; top: 70px; right: 35px; display: none; flex-direction: column; z-index: 101; background: white; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.3); padding: 5px; min-width: 150px; }
#lang-options button { margin: 0; padding: 8px 10px; width: 100%; text-align: left; background: none; color: #333; font-size: 14px; box-shadow: none; border-radius: 8px; }
#lang-options button:hover { background: var(--nav-active-bg); color: var(--primary-dark); }

.sub-nav {
    display: flex;
    justify-content: space-around;
    width: 95%;
    margin-bottom: 15px;
    background: var(--bg-card);
    border-radius: 12px;
    padding: 5px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}
.sub-nav-item {
    flex: 1;
    text-align: center;
    padding: 10px 5px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    color: #7f8c8d;
    transition: all 0.2s;
}
.sub-nav-item.active {
    background: var(--primary-color);
    color: white;
    box-shadow: 0 2px 10px rgba(46, 204, 113, 0.4);
    font-weight: 600;
}

.sub-tab-content {
    display: none;
    width: 95%;
    text-align: left;
    animation: fadeIn 0.3s ease-out;
}
.sub-tab-content.active {
    display: block;
}
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.profile-info-block {
    background: var(--bg-card);
    border-radius: 16px;
    padding: 15px;
    width: 95%;
    margin-bottom: 15px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    border: 1px solid #ddd;
    cursor: pointer; 
    transition: background-color 0.2s;
}
.profile-info-block:hover {
    background-color: #f0f0f0;
}

.quiz-standalone-content {
    width: 95%;
    max-height: 90%; 
    overflow-y: auto;
    padding: 15px; 
    background: var(--bg-card);
    border-radius: 16px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.1);
    margin-top: 10px;
    box-sizing: border-box; 
}

.quiz-standalone-content .quiz-question h4 {
    text-align: left;
    border-bottom: none;
    padding-bottom: 0;
    margin-bottom: 8px;
    width: 100%;
    color: var(--primary-dark); 
    font-size: 18px; 
}
</style>
</head>
<body>
<div class="phone">

  <!-- Language control -->
  <div id="lang-icon" onclick="toggleLangOptions()">
      <span id="lang-display">üåê VI</span>
  </div>
  <div id="lang-options">
    <button onclick="selectLang('vi')">Ti·∫øng Vi·ªát (VI)</button>
    <button onclick="selectLang('en')">English (EN)</button>
  </div>

  <!-- WIFI Screen -->
  <div class="screen login-screen" id="wifi-screen">
    <div class="login-card">
      <h2>üì∂ K·∫øt n·ªëi Wi-Fi</h2>
      <p>Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi ·ª©ng d·ª•ng tham quan th√¥ng minh!</p>
      <button onclick="goToLogin()">K·∫øt n·ªëi Wi-Fi</button>
    </div>
  </div>

  <!-- LOGIN Screen -->
  <div class="screen hidden login-screen" id="login-screen">
    <!-- Manual Ticket Input Card -->
    <div class="login-card" id="login-form-card">
      <h2>üéüÔ∏è ƒêƒÉng nh·∫≠p</h2>
      <p>Nh·∫≠p m√£ v√© c·ªßa Nh√≥m 7 ƒë·ªÉ v√†o ·ª©ng d·ª•ng.</p>
      <input type="text" id="ticket-input" placeholder="Nh·∫≠p m√£ v√©...">
      <div id="login-error-msg" style="color: #e74c3c; font-size: 12px; margin-bottom: 10px; display: none;">M√£ v√© kh√¥ng ch√≠nh x√°c!</div>
      <button onclick="goToMain()">ƒêƒÉng nh·∫≠p</button>
      <button onclick="toggleLoginScanner(true)" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); box-shadow: 0 6px 20px rgba(243, 156, 18, 0.3);">üì∑ Qu√©t m√£ QR</button>
    </div>

    <!-- QR Login Scanner Card -->
    <div class="login-card hidden" id="login-scanner-card">
        <h2>üì∑ Qu√©t m√£ v√©</h2>
        <p>Vui l√≤ng ƒë∆∞a m√£ QR v√© v√†o khung h√¨nh ƒë·ªÉ ƒëƒÉng nh·∫≠p.</p>
        <div id="login-camera-wrapper">
            <video id="login-camera-preview" autoplay playsinline></video>
            <canvas id="login-camera-canvas"></canvas>
            <div class="scanner-frame" style="width: 80%; height: 80%;"></div>
            <div class="scanner-line"></div>
        </div>
        <button onclick="toggleLoginScanner(false)" style="background: #95a5a6; width: 100%; margin-top: 15px;">‚¨ÖÔ∏è Quay l·∫°i ƒëƒÉng nh·∫≠p v√©</button>
    </div>
  </div>

  <!-- QUIZ STANDALONE SCREEN -->
  <div class="screen hidden" id="quiz-standalone-screen" style="justify-content: flex-start; padding-top: 20px;">
    <button onclick="backToQrTab()" style="width: 95%; margin-bottom: 15px; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 10px 25px;">
        ‚¨ÖÔ∏è Quay l·∫°i Hi·ªán v·∫≠t
    </button>
    
    <div class="quiz-standalone-content" id="quiz-section-standalone">
        <div id="quiz-content-standalone">
            <p id="quiz-initial-message-standalone" style="text-align: center; color: #7f8c8d;">ƒêang t·∫£i Quiz...</p>
            <div id="quiz-question-container-standalone"></div>
            <button id="quiz-submit-button-standalone" onclick="submitArtifactQuiz('standalone')" style="display:none; width:100%; margin-top: 15px; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">Ho√†n th√†nh Quiz</button>
            <div id="quiz-feedback-standalone" class="quiz-result-message" style="display: none;"></div>
        </div>
    </div>
  </div>

  <!-- MAIN SCREEN -->
  <div class="screen hidden" id="main-screen">
    <input type="text" id="search-input" placeholder="üîç T√¨m khu tr∆∞ng b√†y, hi·ªán v·∫≠t..." style="width:95%; margin:5px 0 10px; padding:10px; border-radius:12px; border:1px solid #ccc;">

    <!-- Intro Tab -->
    <div class="tab-content active-tab" id="intro-tab">
      <h3>üèõÔ∏è Th√¥ng tin Chung</h3>
      <div class="info-card">
        <h4>1. Gi·ªù m·ªü c·ª≠a & Gi√° v√©</h4>
        <p>M·ªü c·ª≠a: 7:30 - 17:00 h√†ng ng√†y.</p>
        <p>Gi√° v√©: 40.000ƒë (Ng∆∞·ªùi l·ªõn), 20.000ƒë (Sinh vi√™n).</p>
      </div>
      <div class="info-card">
        <h4>2. S∆° ƒë·ªì tham quan</h4>
        <p>T·∫ßng 1: Ti·ªÅn s·ª≠ & C·ªï v·∫≠t.</p>
        <p>T·∫ßng 2: L·ªãch s·ª≠ chi·∫øn tranh.</p>
        <p>T·∫ßng 3: VƒÉn h√≥a & D√¢n t·ªôc h·ªçc.</p>
      </div>
    </div>

    <!-- Chatbot Tab (Content kept for structure, but redirect handled by nav) -->
    <div class="tab-content" id="chat-tab">
      <h3>üí¨ Chatbot AI (Gemini)</h3>
      <div id="kb-status" style="font-size: 11px; color: var(--primary-dark); margin-bottom: 5px;">‚úÖ ƒê√£ k·∫øt n·ªëi tr√≠ tu·ªá nh√¢n t·∫°o th·ªùi gian th·ª±c.</div>
      
      <div id="quick-questions">
        <button class="quick-q-btn" onclick="prefillAndSend('Gi√° v√© v√† gi·ªù m·ªü c·ª≠a b·∫£o t√†ng?')">Gi√° v√© & Gi·ªù m·ªü c·ª≠a?</button>
        <button class="quick-q-btn" onclick="prefillAndSend('B·∫£o t√†ng c√≥ m·∫•y t·∫ßng v√† tr∆∞ng b√†y g√¨?')">S∆° ƒë·ªì tr∆∞ng b√†y?</button>
        <button class="quick-q-btn" onclick="prefillAndSend('ƒê·ªãa ch·ªâ b·∫£o t√†ng ·ªü ƒë√¢u?')">ƒê·ªãa ch·ªâ b·∫£o t√†ng?</button>
        <button class="quick-q-btn" onclick="prefillAndSend('K·ªÉ t√™n m·ªôt s·ªë hi·ªán v·∫≠t ti√™u bi·ªÉu?')">Hi·ªán v·∫≠t ti√™u bi·ªÉu?</button>
      </div>

      <div class="chat-window" id="chat-window" style="flex-grow: 1; width: 95%; max-height: 440px; overflow-y: auto; padding: 10px; margin-bottom: 5px; border-radius: 12px; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); text-align: left;">
        <div class='chat-message ai-msg'>Xin ch√†o! T√¥i l√† tr·ª£ l√Ω AI c·ªßa B·∫£o t√†ng ƒê√† N·∫µng. B·∫°n c√≥ th·ªÉ h·ªèi t√¥i v·ªÅ gi√° v√©, gi·ªù m·ªü c·ª≠a, hi·ªán v·∫≠t ho·∫∑c b·∫•t c·ª© ƒëi·ªÅu g√¨ v·ªÅ l·ªãch s·ª≠ t·∫°i ƒë√¢y!</div>
      </div>
      
      <div id="loader" style="display:none; margin-top: 10px;"></div>
      <input type="text" id="chat-input" placeholder="H·ªèi t√¥i b·∫•t c·ª© ƒëi·ªÅu g√¨..." onkeydown="if(event.key==='Enter'){sendMessage();}">
      <button id="send-btn" onclick="sendMessage()">G·ª≠i</button>
    </div>

    <!-- QR Tab -->
    <div class="tab-content" id="qr-tab">
      <h3>üì∑ Qu√©t QR Th√¥ng minh</h3>
      <div id="camera-wrapper">
          <video id="camera-preview" autoplay playsinline style="display: none;"></video>
          <canvas id="camera-canvas"></canvas>
          <div id="scanner-line-wrapper" class="hidden" style="position: absolute; width: 100%; height: 100%; top: 0; left: 0;">
             <div class="scanner-frame"></div>
             <div class="scanner-line"></div>
          </div>
          <div id="camera-placeholder" style="width: 100%; height: 100%; background: #2c3e50; border-radius: 12px; display: flex; justify-content: center; align-items: center; color: #fff; font-size: 16px; font-weight: 600;">CH∆ØA KH·ªûI ƒê·ªòNG CAMERA</div>
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 5px; margin-top: 15px; width: 95%;">
        <div style="display: flex; gap: 10px; width: 100%;">
          <button id="scan-button" onclick="startCamera()" style="flex: 1; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">B·∫Øt ƒë·∫ßu qu√©t</button>
          <button id="stop-button" onclick="stopCamera()" style="display: none; flex: 1; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">Ng·ª´ng Camera</button>
        </div>
        <button id="initial-mock-gate" onclick="mockScanArtifact1()" style="background: #95a5a6; padding: 10px; font-size: 13px; display: none;">‚ö° M√¥ ph·ªèng ph√°t hi·ªán QR (Demo)</button>
      </div>

      <div id="mock-artifact-buttons" style="width: 95%; margin-top: 10px; display: none;">
          <h4 style="font-size: 14px; margin-bottom: 10px; color: var(--primary-dark);">Kh√°m ph√° hi·ªán v·∫≠t kh√°c:</h4>
          <button id="mock-scan-1" onclick="mockScanArtifact1()" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); width: 100%; padding: 10px 25px; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);">
              ‚ö° Xem Hi·ªán v·∫≠t: T∆∞·ª£ng Tr·∫ßn H∆∞ng ƒê·∫°o
          </button>
          <button id="mock-scan-2" onclick="mockScanArtifact2()" style="display:none; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); width: 100%; margin-top: 10px; padding: 10px 25px; box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);">
              ‚ö° Xem Hi·ªán v·∫≠t: M√¥ h√¨nh Tr√°i ƒê·∫•t
          </button>
      </div>

      <div id="qr-result" style="display:none; flex-direction:column; margin-top:15px; width:95%; padding:15px; border-radius:12px; text-align: left; background:var(--nav-active-bg); box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
        <h4 id="data-title" style="color:var(--primary-dark); margin-bottom: 10px;">Th√¥ng tin ƒë√£ qu√©t: ...</h4>
        <div id="scanned-details" style="font-size: 14px; margin-bottom: 10px;"></div>
        
        <div id="interaction-buttons" style="display: flex; justify-content: center; width: 100%; margin-top: 5px; gap: 10px;">
          <button id="youtube-button" onclick="playVideoPresentation()" style="display: none; flex: 1; padding: 10px 15px; border-radius: 10px; font-size: 14px;">‚ñ∂Ô∏è Xem thuy·∫øt tr√¨nh</button>
          <button id="view360-button" onclick="view360()" style="display: none; flex: 1; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 10px 15px; border-radius: 10px; font-size: 14px;">üåÄ Xem 360¬∞ / AR</button>
        </div>
        
        <div id="artifact-360-display"></div>
        
        <button id="start-quiz-button-qr" onclick="handleStartQuiz()" style="display:none; width: 100%; margin-top: 15px; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
            ‚ùì B·∫Øt ƒë·∫ßu Quiz Hi·ªán v·∫≠t
        </button>
      </div>
    </div>

    <!-- Map Tab -->
    <div class="tab-content" id="map-tab">
      <h3>üó∫Ô∏è B·∫£n ƒë·ªì & H∆∞·ªõng d·∫´n</h3>
      <select id="floor-select" onchange="changeFloor()" style="margin-bottom:15px; padding: 10px; border-radius: 10px; width: 95%;">
        <option value="1">T·∫ßng 1 - C·ªï v·∫≠t & Ti·∫øp ƒë√≥n</option>
        <option value="2">T·∫ßng 2 - L·ªãch s·ª≠ & Kh√°ng chi·∫øn</option>
        <option value="3">T·∫ßng 3 - VƒÉn h√≥a & Ph√°t tri·ªÉn</option>
      </select>
      
      <select id="destination-select" style="margin-bottom:15px; padding: 10px; border-radius: 10px; width: 95%;">
        <option value="" selected>Ch·ªçn ƒëi·ªÉm ƒë·∫øn...</option>
      </select>
      
      <div class="map-filters">
        <div class="filter-item active" id="filter-display" onclick="toggleFilter('display')"><span>üñºÔ∏è</span>Tr∆∞ng b√†y</div>
        <div class="filter-item active" id="filter-toilet" onclick="toggleFilter('toilet')"><span>üöª</span>WC</div>
        <div class="filter-item active" id="filter-info" onclick="toggleFilter('info')"><span>‚ÑπÔ∏è</span>Th√¥ng tin</div>
        <div class="filter-item active" id="filter-current" onclick="toggleFilter('current')"><span>üìç</span>B·∫°n</div>
      </div>
      
      <div id="map-container">
        <div id="path-line"></div>
      </div>
      
      <div style="display: flex; gap: 10px; width: 95%; margin-top: 5px;">
        <button onclick="findPath()" style="flex: 1; background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);">‚û°Ô∏è D·∫´n ƒë∆∞·ªùng</button>
        <button onclick="resetMap()" style="flex: 1; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">üîÑ ƒê·∫∑t l·∫°i</button>
      </div>
      <div id="ai-guide" style="background: linear-gradient(45deg, var(--primary-color), #4d89ff); color: white; padding: 12px; width: 95%; border-radius: 12px; font-size: 14px; margin-top: 15px;">ü§ñ G·ª£i √Ω: T·∫ßng 1 ƒëang ƒë√¥ng kh√°ch.</div>
    </div>

    <!-- Profile Tab -->
    <div class="tab-content" id="profile-tab">
      <h3>üë§ H·ªì s∆° & Th√†nh t√≠ch</h3>
      
      <div id="profile-main-view" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
          <div class="profile-info-block" id="profile-info-card" onclick="toggleEditProfile()">
             <div id="profile-view-mode">
                 <div style="font-size: 18px; font-weight: 700; color: var(--primary-dark); margin-bottom: 5px;">
                     M√£ v√©: <span style="color: var(--accent-color);">DNMnhom7</span>
                 </div>
                 <p style="text-align: center; margin: 2px 0;">H·ªç t√™n: <b id="display-username">Nguy·ªÖn VƒÉn A</b></p>
                 <p style="text-align: center; margin: 2px 0; font-size: 12px; color: #7f8c8d;">Th·ªùi gian: 14:30 15/07/2025</p>
                 <button onclick="event.stopPropagation(); toggleEditProfile();" style="padding: 8px 15px; font-size: 14px; margin-top: 10px; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                     ‚öôÔ∏è S·ª≠a H·ªì s∆°
                 </button>
             </div>
             
             <div id="profile-edit-mode" style="display:none; text-align: center;" onclick="event.stopPropagation()">
                 <h4 style="margin-top: 0;">Ch·ªânh s·ª≠a H·ªì s∆°</h4>
                 <label for="edit-username" style="font-size: 14px; display: block; margin-bottom: 5px;">H·ªç t√™n:</label>
                 <input type="text" id="edit-username" placeholder="Nh·∫≠p t√™n m·ªõi" style="width: 80%; margin-bottom: 10px; padding: 8px;">
                 <div style="display: flex; justify-content: center; gap: 10px;">
                    <button onclick="event.stopPropagation(); saveProfile();" style="flex: 1; padding: 10px 15px; font-size: 14px;">
                        üíæ L∆∞u
                    </button>
                    <button onclick="event.stopPropagation(); toggleEditProfile();" style="flex: 1; padding: 10px 15px; font-size: 14px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                        ‚ùå H·ªßy
                    </button>
                 </div>
             </div>
          </div>

          <div class="info-card achievement-card" id="reward-card">
            <h4>üèÜ Th√†nh t√≠ch Quiz & Ph·∫ßn th∆∞·ªüng</h4>
            <p>ƒêi·ªÉm Quiz ƒê√∫ng: <b id="quiz-score">0</b>/<span id="quiz-total-score">0</span></p>
            <div id="reward-status-display">
                <p id="reward-status">T√≠ch l≈©y ƒëi·ªÉm Quiz ƒë·ªÉ nh·∫≠n ph·∫ßn th∆∞·ªüng h·∫•p d·∫´n!</p>
            </div>
          </div>
          
          <button onclick="showHistoryQuizView()" style="width: 95%; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
              üîç Xem L·ªãch s·ª≠ Q.R & Quiz
          </button>
      </div>
      
      <div id="artifact-history-quiz-view" style="width: 100%; display: none; flex-direction: column; align-items: center;">
          <button onclick="backToProfileMain()" style="width: 95%; background: linear-gradient(135deg, #c0c0c0 0%, #999999 100%); color: var(--text-dark); margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.15);">
              ‚¨ÖÔ∏è Quay l·∫°i H·ªì s∆°
          </button>
          
          <div class="sub-nav">
              <div class="sub-nav-item active" onclick="showSubTab('history')">üìç L·ªãch s·ª≠ Q.R</div>
          </div>
          
          <div class="info-card" id="history-quiz-combined-area" style="border-left: 5px solid var(--primary-dark); padding: 0; width: 95%;">
            <div id="sub-tab-history" class="sub-tab-content active">
                <div style="padding: 15px;">
                    <h4>üìç ƒê·ªãa ƒëi·ªÉm ƒë√£ tham quan (Qu√©t QR)</h4>
                    <ul id="visited-locations" style="list-style-type: disc; margin-left: 15px; margin-bottom: 5px;">
                      <li>(Ch∆∞a c√≥)</li>
                    </ul>
                </div>
            </div>
          </div>
      </div>

      <button onclick="logout()">ƒêƒÉng xu·∫•t</button>
    </div>

    <div class="bottom-nav">
      <div class="nav-item" id="nav-intro" onclick="showTab('intro-tab')"><span>üèõÔ∏è</span>Gi·ªõi thi·ªáu</div>
      <!-- N√ÇNG C·∫§P: Nh·∫•n v√†o Chatbot s·∫Ω m·ªü link Gemini b√™n ngo√†i -->
      <div class="nav-item" id="nav-chat" onclick="openGemini()"><span>üí¨</span>Chatbot</div>
      <div class="nav-item" id="nav-qr" onclick="showTab('qr-tab')"><span>üì∑</span>Qu√©t QR</div>
      <div class="nav-item" id="nav-map" onclick="showTab('map-tab')"><span>üó∫Ô∏è</span>B·∫£n ƒë·ªì</div>
      <div class="nav-item" id="nav-profile" onclick="showTab('profile-tab')"><span>üë§</span>H·ªì s∆°</div>
    </div>
  </div>
</div>

<script>
/* ==========================================================================
   CONFIG & API
   ========================================================================== */
const apiKey = ""; // ƒê∆∞·ª£c cung c·∫•p b·ªüi m√¥i tr∆∞·ªùng runtime

/* ==========================================================================
   D·ªÆ LI·ªÜU C√Å NH√ÇN
   ========================================================================== */
let profileData = {
    ticket: "DNMnhom7",
    username: "Nguy·ªÖn VƒÉn A",
    time: "14:30 15/07/2025"
};
let isEditingProfile = false;

function updateProfileDisplay() {
    document.getElementById('display-username').innerText = profileData.username;
    document.getElementById('edit-username').value = profileData.username;
}

function toggleEditProfile() {
    isEditingProfile = !isEditingProfile;
    const viewMode = document.getElementById('profile-view-mode');
    const editMode = document.getElementById('profile-edit-mode');
    if (isEditingProfile) {
        viewMode.style.display = 'none';
        editMode.style.display = 'block';
    } else {
        viewMode.style.display = 'block';
        editMode.style.display = 'none';
        document.getElementById('edit-username').value = profileData.username;
    }
}

function saveProfile() {
    const newUsername = document.getElementById('edit-username').value.trim();
    if (newUsername.length > 0) {
        profileData.username = newUsername;
        updateProfileDisplay();
        toggleEditProfile(); 
        console.log("ƒê√£ l∆∞u H·ªì s∆° th√†nh c√¥ng!");
    } else {
        console.log("T√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!");
    }
}

/* ==========================================================================
   D·ªÆ LI·ªÜU GAMEFICATION & QUIZ
   ========================================================================== */
let visitedArtifacts = []; 
let quizScore = 0;
let quizTotalQuestions = 0; 
let artifactQuizStatus = {}; 

const REWARD_TIERS = [
    { threshold: 5, label: "ƒê·ªìng", reward: "Phi·∫øu gi·∫£m gi√° 10%", code: "DN-BTM-BRONZE-2025" },
    { threshold: 10, label: "V√†ng", reward: "Qu√† l∆∞u ni·ªám & Mi·ªÖn ph√≠ v√© l·∫ßn sau", code: "DN-BTM-GOLD-PREMIUM" }
];

// --- D·ªÆ LI·ªÜU QUIZ TR·∫¶N H∆ØNG ƒê·∫†O ---
const tranHungDaoQuizData = [
    {
        question: "1. Tr·∫ßn H∆∞ng ƒê·∫°o c√≥ t√™n th·∫≠t l√† g√¨?",
        options: [
            { text: "Tr·∫ßn Qu·ªëc To·∫£n", isCorrect: false, answer: "Tr·∫ßn Qu·ªëc To·∫£n l√† ch√°u c·ªßa Tr·∫ßn H∆∞ng ƒê·∫°o." },
            { text: "Tr·∫ßn Qu·ªëc Tu·∫•n", isCorrect: true, answer: "Tr·∫ßn Qu·ªëc Tu·∫•n l√† t√™n th·∫≠t c·ªßa Tr·∫ßn H∆∞ng ƒê·∫°o." },
            { text: "Tr·∫ßn Nh·∫≠t Du·∫≠t", isCorrect: false, answer: "Tr·∫ßn Nh·∫≠t Du·∫≠t l√† em trai c√πng cha kh√°c m·∫π v·ªõi √¥ng." },
            { text: "Tr·∫ßn Th√°nh T√¥ng", isCorrect: false, answer: "Tr·∫ßn Th√°nh T√¥ng l√† v·ªã Ho√†ng ƒë·∫ø th·ª© hai c·ªßa nh√† Tr·∫ßn." }
        ]
    },
    {
        question: "2. Tr·∫ßn H∆∞ng ƒê·∫°o gi·ªØ ch·ª©c v·ª• g√¨ n·ªïi b·∫≠t nh·∫•t?",
        options: [
            { text: "Th√°i s∆∞", isCorrect: false, answer: "Th√°i s∆∞ l√† ch·ª©c t·ªÉ t∆∞·ªõng." },
            { text: "Th∆∞·ª£ng t∆∞·ªõng qu√¢n", isCorrect: false, answer: "M·ªôt ch·ª©c v·ª• qu√¢n s·ª± cao c·∫•p." },
            { text: "ƒê·∫°i t∆∞·ªõng qu√¢n ‚Äì Qu·ªëc c√¥ng Ti·∫øt ch·∫ø", isCorrect: true, answer: "Qu·ªëc c√¥ng Ti·∫øt ch·∫ø l√† t∆∞·ªõc v·ªã qu√¢n s·ª± cao nh·∫•t." },
            { text: "H√†n l√¢m h·ªçc sƒ©", isCorrect: false, answer: "ƒê√¢y l√† ch·ª©c v·ª• vƒÉn h·ªçc." }
        ]
    },
    {
        question: "3. √îng n·ªïi ti·∫øng with chi·∫øn th·∫Øng n√†o tr∆∞·ªõc qu√¢n Nguy√™n?",
        options: [
            { text: "Chi·∫øn th·∫Øng R·∫°ch G·∫ßm ‚Äì Xo√†i M√∫t", isCorrect: false, answer: "ƒê√¢y l√† c·ªßa Nguy·ªÖn Hu·ªá." },
            { text: "Chi·∫øn th·∫Øng Chi LƒÉng", isCorrect: false, answer: "ƒê√¢y l√† c·ªßa L√™ L·ª£i." },
            { text: "Chi·∫øn th·∫Øng B·∫°ch ƒê·∫±ng (1288)", isCorrect: true, answer: "ƒê√¢y l√† chi·∫øn th·∫Øng quy·∫øt ƒë·ªãnh k·∫øt th√∫c cu·ªôc kh√°ng chi·∫øn l·∫ßn 3." },
            { text: "Chi·∫øn th·∫Øng ƒê·ªëng ƒêa", isCorrect: false, answer: "ƒê√¢y l√† c·ªßa Quang Trung." }
        ]
    },
    {
        question: "4. T√°c ph·∫©m so·∫°n ƒë·ªÉ kh√≠ch l·ªá qu√¢n sƒ© l√†?",
        options: [
            { text: "H·ªãch t∆∞·ªõng sƒ©", isCorrect: true, answer: "H·ªãch t∆∞·ªõng sƒ© l√† √°ng vƒÉn y√™u n∆∞·ªõc h√πng h·ªìn." },
            { text: "Nam qu·ªëc s∆°n h√†", isCorrect: false, answer: "C·ªßa L√Ω Th∆∞·ªùng Ki·ªát." },
            { text: "B√¨nh Ng√¥ ƒë·∫°i c√°o", isCorrect: false, answer: "C·ªßa Nguy·ªÖn Tr√£i." },
            { text: "Thi√™n ƒë√¥ chi·∫øu", isCorrect: false, answer: "Chi·∫øu d·ªùi ƒë√¥ c·ªßa L√Ω C√¥ng U·∫©n." }
        ]
    },
    {
        question: "5. C√¢u n√≥i n·ªïi ti·∫øng c·ªßa √¥ng tr∆∞·ªõc vua l√† g√¨?",
        options: [
            { text: "‚ÄúS√°t Th√°t!‚Äù", isCorrect: false, answer: "Kh·∫©u hi·ªáu c·ªßa binh sƒ©." },
            { text: "‚ÄúM·ªôt t·∫•c ƒë·∫•t c≈©ng kh√¥ng ƒë·ªÉ l·ªçt tay k·∫ª kh√°c.‚Äù", isCorrect: false, answer: "Th·ªÉ hi·ªán ch·ªß quy·ªÅn." },
            { text: "‚Äúƒê·∫ßu th·∫ßn ch∆∞a r∆°i xu·ªëng ƒë·∫•t, xin b·ªá h·∫° ƒë·ª´ng lo.‚Äù", isCorrect: true, answer: "Th·ªÉ hi·ªán s·ª± quy·∫øt t√¢m chi·∫øn ƒë·∫•u ƒë·∫øn c√πng." },
            { text: "‚ÄúNam qu·ªëc s∆°n h√† Nam ƒë·∫ø c∆∞.‚Äù", isCorrect: false, answer: "Th∆° L√Ω Th∆∞·ªùng Ki·ªát." }
        ]
    }
];

// --- D·ªÆ LI·ªÜU QUIZ M√î H√åNH TR√ÅI ƒê·∫§T ---
const earthQuizData = [
    {
        question: "1. Tr√°i ƒê·∫•t l√† h√†nh tinh th·ª© m·∫•y t√≠nh t·ª´ M·∫∑t Tr·ªùi?",
        options: [
            { text: "H√†nh tinh th·ª© 2", isCorrect: false, answer: "H√†nh tinh th·ª© 2 l√† Sao Kim (Venus)." },
            { text: "H√†nh tinh th·ª© 3", isCorrect: true, answer: "Tr√°i ƒê·∫•t n·∫±m ·ªü v·ªã tr√≠ th·ª© 3, kho·∫£ng c√°ch l√Ω t∆∞·ªüng ƒë·ªÉ duy tr√¨ s·ª± s·ªëng." },
            { text: "H√†nh tinh th·ª© 4", isCorrect: false, answer: "H√†nh tinh th·ª© 4 l√† Sao H·ªèa (Mars)." },
            { text: "H√†nh tinh th·ª© 5", isCorrect: false, answer: "H√†nh tinh th·ª© 5 l√† Sao M·ªôc (Jupiter)." }
        ]
    },
    {
        question: "2. Kho·∫£ng bao nhi√™u % b·ªÅ m·∫∑t Tr√°i ƒê·∫•t ƒë∆∞·ª£c bao ph·ªß b·ªüi n∆∞·ªõc?",
        options: [
            { text: "50%", isCorrect: false, answer: "M·ª©c n√†y qu√° th·∫•p so v·ªõi th·ª±c t·∫ø." },
            { text: "61%", isCorrect: false, answer: "T·ª∑ l·ªá n√†y ch∆∞a ch√≠nh x√°c." },
            { text: "71%", isCorrect: true, answer: "Kho·∫£ng 71% b·ªÅ m·∫∑t Tr√°i ƒê·∫•t l√† ƒë·∫°i ƒë∆∞∆°ng, do ƒë√≥ n√≥ ƒë∆∞·ª£c g·ªçi l√† H√†nh tinh Xanh." },
            { text: "85%", isCorrect: false, answer: "ƒê·∫•t li·ªÅn chi·∫øm kho·∫£ng 29%, kh√¥ng th·ªÉ l√† 85% n∆∞·ªõc." }
        ]
    },
    {
        question: "3. L·ªõp n√†o m·ªèng nh·∫•t trong c·∫•u tr√∫c c·ªßa Tr√°i ƒê·∫•t?",
        options: [
            { text: "L√µi trong", isCorrect: false, answer: "L√µi trong l√† m·ªôt kh·ªëi kim lo·∫°i r·∫Øn kh·ªïng l·ªì." },
            { text: "L·ªõp Mantle", isCorrect: false, answer: "L·ªõp Mantle chi·∫øm ph·∫ßn l·ªõn th·ªÉ t√≠ch Tr√°i ƒê·∫•t." },
            { text: "L√µi ngo√†i", isCorrect: false, answer: "L√µi ngo√†i l√† kim lo·∫°i l·ªèng." },
            { text: "V·ªè Tr√°i ƒê·∫•t", isCorrect: true, answer: "V·ªè Tr√°i ƒê·∫•t ch·ªâ d√†y t·ª´ 5km (d∆∞·ªõi ƒë·∫°i d∆∞∆°ng) ƒë·∫øn kho·∫£ng 70km (tr√™n l·ª•c ƒë·ªãa)." }
        ]
    },
    {
        question: "4. Kh√≠ quy·ªÉn Tr√°i ƒê·∫•t bao g·ªìm ch·ªß y·∫øu l√† kh√≠ n√†o?",
        options: [
            { text: "Oxy (21%)", isCorrect: false, answer: "Oxy quan tr·ªçng nh∆∞ng kh√¥ng ph·∫£i chi·∫øm t·ª∑ l·ªá cao nh·∫•t." },
            { text: "Nit∆° (78%)", isCorrect: true, answer: "Kh√≠ Nit∆° chi·∫øm kho·∫£ng 78% th√†nh ph·∫ßn kh√¥ng kh√≠ kh√¥." },
            { text: "Cacbonic (0.04%)", isCorrect: false, answer: "Kh√≠ n√†y chi·∫øm t·ª∑ l·ªá r·∫•t nh·ªè." },
            { text: "Argon (0.9%)", isCorrect: false, answer: "Argon l√† kh√≠ hi·∫øm chi·∫øm t·ª∑ l·ªá th·∫•p." }
        ]
    },
    {
        question: "5. Tr√°i ƒê·∫•t m·∫•t bao l√¢u ƒë·ªÉ t·ª± quay quanh tr·ª•c m·ªôt v√≤ng?",
        options: [
            { text: "12 gi·ªù", isCorrect: false, answer: "ƒê√¢y ch·ªâ l√† m·ªôt n·ª≠a chu k·ª≥." },
            { text: "23 gi·ªù 56 ph√∫t", isCorrect: true, answer: "ƒê√¢y l√† m·ªôt ng√†y thi√™n vƒÉn th·ª±c t·∫ø m√† Tr√°i ƒê·∫•t c·∫ßn ƒë·ªÉ t·ª± quay quanh tr·ª•c." },
            { text: "24 gi·ªù 30 ph√∫t", isCorrect: false, answer: "Th·ªùi gian n√†y d√†i h∆°n th·ª±c t·∫ø." },
            { text: "365 ng√†y", isCorrect: false, answer: "ƒê√¢y l√† th·ªùi gian Tr√°i ƒê·∫•t quay quanh M·∫∑t Tr·ªùi m·ªôt v√≤ng." }
        ]
    }
];

function getQuizForArtifact(artifactId) {
    if (artifactId === 'artifact_123') return JSON.parse(JSON.stringify(tranHungDaoQuizData));
    if (artifactId === 'artifact_456') return JSON.parse(JSON.stringify(earthQuizData));
    return null;
}

// --- PROFILE / QUIZ LOGIC ---

function showProfileSubScreen(viewId) {
    document.getElementById('profile-main-view').style.display = 'none';
    document.getElementById('artifact-history-quiz-view').style.display = 'none';
    const targetView = document.getElementById(viewId);
    if (targetView) {
        targetView.style.display = 'flex';
        if (viewId === 'artifact-history-quiz-view') showSubTab('history');
    }
}

function showHistoryQuizView() {
    showProfileSubScreen('artifact-history-quiz-view');
    renderProfileHistoryQuiz();
}

function backToProfileMain() {
    showProfileSubScreen('profile-main-view');
    renderProfileMain(); 
}

function showSubTab(tabId) {
    document.querySelectorAll('.sub-tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.sub-nav-item').forEach(el => el.classList.remove('active'));
    document.getElementById(`sub-tab-${tabId}`).classList.add('active');
    document.querySelector('.sub-nav-item').classList.add('active');
}

function renderProfileMain() {
    let currentQuizScore = 0;
    let maxQuizQuestions = 0; 

    Object.keys(artifactQuizStatus).forEach(artifactId => {
        const status = artifactQuizStatus[artifactId];
        if (status.done) { 
            currentQuizScore += status.score;
            maxQuizQuestions += status.total; 
        }
    });

    quizScore = currentQuizScore;
    quizTotalQuestions = maxQuizQuestions; 

    document.getElementById('quiz-score').innerText = quizScore;
    document.getElementById('quiz-total-score').innerText = quizTotalQuestions; 
    checkRewardStatus(); 
    updateProfileDisplay();
}

function renderProfileHistoryQuiz() {
    const visitedList = document.getElementById('visited-locations');
    visitedList.innerHTML = visitedArtifacts.length > 0
        ? visitedArtifacts.map(a => {
            const status = artifactQuizStatus[a.id];
            const totalQ = status && status.total ? status.total : 5; 
            let statusText = 'Ch∆∞a Quiz';
            if (status && status.done) {
                statusText = status.score === totalQ ? `‚úÖ Ho√†n h·∫£o: ${status.score}/${totalQ}` : `‚ö†Ô∏è ƒê√£ l√†m: ${status.score}/${totalQ}`;
            }
            return `<li>üñºÔ∏è ${a.name} (${a.id}) - ${statusText}</li>`;
        }).join('')
        : '<li>(Ch∆∞a c√≥)</li>';
}

function renderProfile() {
    renderProfileMain();
    renderProfileHistoryQuiz();
    showProfileSubScreen('profile-main-view');
}

function handleStartQuiz() {
    if (!currentArtifactData || !getQuizForArtifact(currentArtifactData.id)) {
        console.log("Kh√¥ng c√≥ Quiz cho hi·ªán v·∫≠t n√†y.");
        return;
    }
    const status = artifactQuizStatus[currentArtifactData.id];
    if (status && status.done) {
        console.log("üìù B·∫°n ƒë√£ ho√†n th√†nh b√†i thi n√†y.");
    }
    document.getElementById('main-screen').classList.add('hidden');
    document.getElementById('quiz-standalone-screen').classList.remove('hidden');
    startArtifactQuiz(currentArtifactData, 'standalone');
}

function backToQrTab() {
    document.getElementById('quiz-standalone-screen').classList.add('hidden');
    document.getElementById('main-screen').classList.remove('hidden');
    showTab('qr-tab');
}

function startArtifactQuiz(artifactData, mode = 'standalone') {
    const suffix = mode === 'standalone' ? 'standalone' : 'qr';
    const quizSection = document.getElementById(`quiz-section-${suffix}`);
    const quizData = getQuizForArtifact(artifactData.id);
    if (!quizData) return;
    
    currentArtifactQuizData = quizData; 
    const quizContent = document.getElementById(`quiz-content-${suffix}`);
    quizContent.innerHTML = `<div id="quiz-question-container-${suffix}"></div><button id="quiz-submit-button-${suffix}" onclick="submitArtifactQuiz('${mode}')" style="display:none; width:100%; margin-top: 15px; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">Ho√†n th√†nh Quiz</button><div id="quiz-feedback-${suffix}" class="quiz-result-message" style="display: none;"></div>`;

    const newQuizContainer = document.getElementById(`quiz-question-container-${suffix}`);
    const newQuizSubmitBtn = document.getElementById(`quiz-submit-button-${suffix}`);
    const newQuizFeedback = document.getElementById(`quiz-feedback-${suffix}`);
    const quizStatus = artifactQuizStatus[artifactData.id];
    
    if (quizStatus && quizStatus.done) {
        newQuizFeedback.className = quizStatus.score === quizData.length ? 'quiz-result-message quiz-success' : 'quiz-result-message quiz-fail';
        newQuizFeedback.innerText = `K·∫øt qu·∫£: ${quizStatus.score}/${quizData.length} ƒëi·ªÉm ƒë√∫ng!`;
        newQuizFeedback.style.display = 'block';
        renderQuizQuestionsQR(quizData, newQuizContainer, false, quizStatus.selections, mode);
        
        const lockMsg = document.createElement('p');
        lockMsg.style.textAlign = 'center'; lockMsg.style.marginTop = '15px'; lockMsg.style.color = '#7f8c8d'; lockMsg.style.fontSize = '12px';
        lockMsg.innerText = 'üîí B√†i thi ƒë√£ ho√†n th√†nh v√† xem l·ªùi gi·∫£i. Kh√¥ng th·ªÉ th·ª±c hi·ªán l·∫°i.';
        quizContent.appendChild(lockMsg);
    } else {
        newQuizSubmitBtn.style.display = 'inline-block';
        renderQuizQuestionsQR(quizData, newQuizContainer, true, {}, mode);
    }
    quizSection.style.display = 'flex';
}

function renderQuizQuestionsQR(quizData, container, interactive, selections = {}, mode = 'standalone') {
    const prefix = mode === 'standalone' ? 'standalone' : 'qr';
    container.innerHTML = '';
    quizData.forEach((q, index) => {
        const qEl = document.createElement('div');
        qEl.className = 'quiz-question';
        qEl.innerHTML = `<h4>${q.question}</h4>`; 
        const correctAnswer = q.options.findIndex(opt => opt.isCorrect);
        const currentSelection = interactive ? (currentArtifactQuizData[index]?.selectedOptionIndex ?? null) : selections[index];

        q.options.forEach((opt, optIndex) => {
            const optBtn = document.createElement('button');
            optBtn.className = 'quiz-option';
            optBtn.innerText = opt.text;
            if (interactive) {
                optBtn.onclick = () => selectQuizOptionQR(optBtn, index, optIndex, prefix);
                if (currentSelection === optIndex) optBtn.style.backgroundColor = '#d1e5d4';
            } else {
                optBtn.disabled = true; 
                if (opt.isCorrect) optBtn.classList.add('correct-answer'); 
                if (currentSelection === optIndex && !opt.isCorrect) optBtn.classList.add('incorrect-answer');
            }
            qEl.appendChild(optBtn);
        });
        
        if (!interactive) {
            const rationale = document.createElement('p');
            rationale.style.marginTop = '10px'; rationale.style.padding = '10px'; rationale.style.backgroundColor = '#f0f0f0';
            rationale.innerHTML = `<b>Gi·∫£i th√≠ch:</b> ${q.options[correctAnswer].answer}`;
            qEl.appendChild(rationale);
        }
        container.appendChild(qEl);
    });
}

function selectQuizOptionQR(button, qIndex, optIndex, prefix) {
    document.querySelectorAll(`#quiz-question-container-${prefix} .quiz-option[data-q-index="${qIndex}"]`).forEach(btn => btn.style.backgroundColor = '#f7f7f7');
    button.style.backgroundColor = '#d1e5d4';
    button.setAttribute('data-q-index', qIndex); 
    currentArtifactQuizData[qIndex].selectedOptionIndex = optIndex;
}

function submitArtifactQuiz(mode) {
    const finalData = currentArtifactQuizData;
    if (!finalData || !finalData.every(q => q.selectedOptionIndex !== null && q.selectedOptionIndex !== undefined)) {
         console.log("Vui l√≤ng tr·∫£ l·ªùi h·∫øt c√°c c√¢u h·ªèi!");
         return;
    }
    let correctCount = 0;
    let selections = {};
    finalData.forEach((q, index) => {
        selections[index] = q.selectedOptionIndex;
        if (q.options[q.selectedOptionIndex].isCorrect) correctCount++;
    });
    artifactQuizStatus[currentArtifactData.id] = { done: true, score: correctCount, total: finalData.length, selections: selections };
    renderProfileMain(); 
    startArtifactQuiz(currentArtifactData, mode); 
    console.log(correctCount === finalData.length ? "üéâ Tuy·ªát v·ªùi! B·∫°n ƒë√£ ƒë·∫°t ƒëi·ªÉm t·ªëi ƒëa." : `B·∫°n ƒë√∫ng ${correctCount}/${finalData.length} c√¢u.`);
}

function checkRewardStatus() {
    const displayEl = document.getElementById('reward-status-display');
    let highestTierAchieved = null;
    let nextTier = null;

    for (let tier of REWARD_TIERS) {
        if (quizScore >= tier.threshold) {
            highestTierAchieved = tier;
        } else {
            nextTier = tier;
            break; 
        }
    }

    if (highestTierAchieved) {
        let nextMsg = "";
        if (nextTier) {
            nextMsg = `<p style="font-size: 13px; color: #2ecc71; margin-top: 10px; font-weight: 600;">üöÄ Ti·∫øp t·ª•c n√†o! C·∫ßn <b>${nextTier.threshold - quizScore}</b> c√¢u ƒë√∫ng n·ªØa ƒë·ªÉ nh·∫≠n qu√† <b>H·∫°ng ${nextTier.label}</b>!</p>`;
        } else {
            nextMsg = `<p style="font-size: 13px; color: #f39c12; margin-top: 10px; font-weight: bold;">üåü V√¥ ƒë·ªãch! B·∫°n ƒë√£ ƒë·∫°t m·ªëc ph·∫ßn th∆∞·ªüng cao nh·∫•t.</p>`;
        }

        displayEl.innerHTML = `
            <div style="padding: 12px; border: 2px dashed var(--accent-color); border-radius: 12px; background: #fffdf0; text-align: left;">
                <p style="color: var(--primary-dark); font-weight: bold; font-size: 16px; margin-bottom: 5px;">
                    üèÜ ƒê√£ ƒë·∫°t H·∫°ng ${highestTierAchieved.label}!
                </p>
                <p style="color: #2c3e50; font-size: 14px; margin-bottom: 3px;">Ph·∫ßn qu√†: <b>${highestTierAchieved.reward}</b></p>
                <p style="font-size: 13px; color: #7f8c8d;">M√£ nh·∫≠n qu√†: <b style="color: #e67e22; letter-spacing: 1px;">${highestTierAchieved.code}</b></p>
                ${nextMsg}
            </div>
        `;
    } else {
        const firstTier = REWARD_TIERS[0];
        displayEl.innerHTML = `
            <p id="reward-status" style="margin-bottom: 8px;">B·∫°n ch∆∞a ƒë·∫°t m·ªëc ph·∫ßn th∆∞·ªüng.</p>
            <p style="color: #e67e22; font-weight: 600; font-size: 14px;">
                C·∫ßn th√™m <b>${firstTier.threshold - quizScore}</b> c√¢u ƒë√∫ng ƒë·ªÉ nh·∫≠n qu√† <b>H·∫°ng ${firstTier.label}</b>!
            </p>
        `;
    }
}

/* ==========================================================================
   AI CHATBOT (GEMINI UPGRADED WITH STABILITY)
   ========================================================================== */
let isProcessing = false; 

function prefillAndSend(query) { 
    document.getElementById('chat-input').value = query; 
    sendMessage(); 
}

async function sendMessage() {
    if (isProcessing) return;
    const input = document.getElementById('chat-input');
    const msg = input.value.trim();
    if (!msg) return;
    
    isProcessing = true; 
    input.disabled = true;
    const chatWindow = document.getElementById('chat-window');
    const loader = document.getElementById('loader');
    loader.style.display = 'block';

    // Th√™m tin nh·∫Øn c·ªßa ng∆∞·ªùi d√πng v√†o giao di·ªán
    const userDiv = document.createElement('div');
    userDiv.className = 'chat-message user-msg'; 
    userDiv.innerText = msg;
    chatWindow.appendChild(userDiv);
    chatWindow.appendChild(document.createElement('div')).style.clear = 'both'; 
    chatWindow.scrollTop = chatWindow.scrollHeight;
    input.value = '';

    try {
        const systemPrompt = `B·∫°n l√† tr·ª£ l√Ω AI th√¥ng minh t·∫°i B·∫£o t√†ng ƒê√† N·∫µng. H√£y tr·∫£ l·ªùi th√¢n thi·ªán, l·ªãch s·ª± v√† s√∫c t√≠ch.
Th√¥ng tin quan tr·ªçng v·ªÅ b·∫£o t√†ng:
- ƒê·ªãa ch·ªâ: 24 Tr·∫ßn Ph√∫, Th·∫°ch Thang, H·∫£i Ch√¢u, ƒê√† N·∫µng.
- Gi·ªù m·ªü c·ª≠a: 07:30 ‚Äì 17:00 h√†ng ng√†y.
- Gi√° v√©: 40.000ƒë cho ng∆∞·ªùi l·ªõn, 20.000ƒë cho h·ªçc sinh/sinh vi√™n. Tr·∫ª em d∆∞·ªõi 6 tu·ªïi mi·ªÖn ph√≠.
- S∆° ƒë·ªì tr∆∞ng b√†y:
  + T·∫ßng 1: ƒê√† N·∫µng t·ª´ th·ªùi ti·ªÅn s·ª≠ ƒë·∫øn nay, g·ªëm s·ª© c·ªï, kh√¥ng gian vƒÉn h√≥a kh·∫£o c·ªï.
  + T·∫ßng 2: ƒê√† N·∫µng trong hai cu·ªôc kh√°ng chi·∫øn ch·ªëng Ph√°p v√† ch·ªëng M·ªπ.
  + T·∫ßng 3: VƒÉn h√≥a c√°c d√¢n t·ªôc ·ªü ƒê√† N·∫µng v√† Qu·∫£ng Nam (ƒë·∫∑c bi·ªát l√† d√¢n t·ªôc C∆° Tu), vƒÉn h√≥a bi·ªÉn ƒë·∫£o.
- Hi·ªán v·∫≠t ti√™u bi·ªÉu: T∆∞·ª£ng Tr·∫ßn H∆∞ng ƒê·∫°o, G·ªëm c·ªï, c√°c k·ª∑ v·∫≠t kh√°ng chi·∫øn.
N·∫øu kh√°ch h·ªèi ngo√†i ph·∫°m vi B·∫£o t√†ng ƒê√† N·∫µng, h√£y tr·∫£ l·ªùi kh√©o l√©o v√† h∆∞·ªõng h·ªç v·ªÅ th√¥ng tin b·∫£o t√†ng.`;

        // N√ÇNG C·∫§P: C∆° ch·∫ø Retry v·ªõi Exponential Backoff ƒë·ªÉ tƒÉng ƒë·ªô ·ªïn ƒë·ªãnh
        let responseData;
        let delay = 1000;
        for (let i = 0; i < 5; i++) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: msg }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });
                if (response.ok) {
                    responseData = await response.json();
                    break;
                }
            } catch (e) {}
            if (i < 4) await new Promise(r => setTimeout(r, delay));
            delay *= 2;
        }

        const aiResponse = responseData?.candidates?.[0]?.content?.parts?.[0]?.text || "Xin l·ªói, t√¥i ƒëang g·∫∑p ch√∫t s·ª± c·ªë k·∫øt n·ªëi AI. B·∫°n h√£y th·ª≠ nh·∫Øn l·∫°i m·ªôt l·∫ßn n·ªØa nh√©!";

        // Th√™m tin nh·∫Øn c·ªßa AI v√†o giao di·ªán
        const aiDiv = document.createElement('div');
        aiDiv.className = 'chat-message ai-msg'; 
        aiDiv.innerText = aiResponse; 
        chatWindow.appendChild(aiDiv);
        chatWindow.appendChild(document.createElement('div')).style.clear = 'both'; 
    } catch (error) {
        const errDiv = document.createElement('div');
        errDiv.className = 'chat-message ai-msg'; 
        errDiv.innerText = "Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi m√°y ch·ªß AI. Vui l√≤ng ki·ªÉm tra l·∫°i m·∫°ng."; 
        chatWindow.appendChild(errDiv);
        chatWindow.appendChild(document.createElement('div')).style.clear = 'both'; 
    } finally {
        isProcessing = false; 
        input.disabled = false;
        loader.style.display = 'none';
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
}

/* ==========================================================================
   CORE INTERFACE LOGIC
   ========================================================================== */
let currentStream = null;
let videoInterval = null;
let loginStream = null;
let loginInterval = null;

const mockArtifactData = { id: "artifact_123", type: "artifact", name: "T∆∞·ª£ng Tr·∫ßn H∆∞ng ƒê·∫°o", floor: 1, pos: "C·ªï v·∫≠t", youtubeUrl: "https://youtu.be/G18c1CZdyFk" }; 
const mockArtifactData2 = { id: "artifact_456", type: "artifact", name: "M√¥ h√¨nh Tr√°i ƒê·∫•t", floor: 3, pos: "Kh√¥ng gian", youtubeUrl: "https://youtu.be/zmpeBnnIThw" }; 

let currentArtifactData = null; 
let currentArtifactQuizData = null; 

function showTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active-tab'));
  document.getElementById(tabId).classList.add('active-tab');
  document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
  const navItem = document.querySelector(`.nav-item[onclick*="${tabId}"]`);
  if (navItem) navItem.classList.add('active');
  
  if (tabId !== 'qr-tab') stopCamera();
  if (tabId === 'profile-tab') renderProfile();
  document.getElementById('quiz-standalone-screen').classList.add('hidden');
  
  if (tabId === 'qr-tab') {
      updateMockButtons(currentArtifactData?.id);
      exitSubView(); 
      if (!currentArtifactData) {
          document.getElementById('mock-artifact-buttons').style.display = 'none';
      }
      startCamera();
  }
}

/**
 * N√¢ng c·∫•p t√≠nh nƒÉng Chatbot: M·ªü li√™n k·∫øt Gemini ngo√†i
 */
function openGemini() {
    stopCamera();
    window.open('https://gemini.google.com/app?hl=vi', '_blank');
}

function toggleLoginScanner(show) {
    const formCard = document.getElementById('login-form-card');
    const scannerCard = document.getElementById('login-scanner-card');
    const errorMsg = document.getElementById('login-error-msg');
    
    if (show) {
        formCard.classList.add('hidden');
        scannerCard.classList.remove('hidden');
        errorMsg.style.display = 'none';
        startLoginCamera();
    } else {
        stopLoginCamera();
        scannerCard.classList.add('hidden');
        formCard.classList.remove('hidden');
    }
}

async function startLoginCamera() {
    stopLoginCamera();
    const video = document.getElementById('login-camera-preview');
    const canvas = document.getElementById('login-camera-canvas');
    const context = canvas.getContext('2d');
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        loginStream = stream;
        video.srcObject = stream;
        
        loginInterval = setInterval(() => {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const code = jsQR(context.getImageData(0, 0, canvas.width, canvas.height).data, canvas.width, canvas.height);
                if (code) {
                    if (code.data.trim() === 'DNMnhom7') {
                        stopLoginCamera();
                        document.getElementById('ticket-input').value = 'DNMnhom7';
                        goToMain();
                    } else {
                        console.log("M√£ QR kh√¥ng h·ª£p l·ªá cho ƒëƒÉng nh·∫≠p.");
                    }
                }
            }
        }, 150);
    } catch (err) {
        console.error("Kh√¥ng th·ªÉ m·ªü camera ƒëƒÉng nh·∫≠p:", err);
        toggleLoginScanner(false);
    }
}

function stopLoginCamera() {
    if (loginInterval) clearInterval(loginInterval);
    if (loginStream) loginStream.getTracks().forEach(t => t.stop());
    loginStream = null;
}

function quickScan() {
    toggleLoginScanner(true);
}

function goToLogin() { document.getElementById('wifi-screen').classList.add('hidden'); document.getElementById('login-screen').classList.remove('hidden'); }

function goToMain() { 
    const input = document.getElementById('ticket-input').value.trim();
    if (input === 'DNMnhom7') {
        document.getElementById('login-screen').classList.add('hidden'); 
        document.getElementById('main-screen').classList.remove('hidden'); 
        showTab('intro-tab'); 
    } else {
        document.getElementById('login-error-msg').style.display = 'block';
    }
}

function logout() { location.reload(); }

async function startCamera() {
  stopCamera(); 
  const video = document.getElementById('camera-preview');
  const canvas = document.getElementById('camera-canvas');
  const context = canvas.getContext('2d');
  const placeholder = document.getElementById('camera-placeholder');
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    currentStream = stream; video.srcObject = stream; video.style.display = 'block';
    placeholder.style.display = 'none';
    document.getElementById('stop-button').style.display = 'inline-block';
    document.getElementById('initial-mock-gate').style.display = 'inline-block'; 
    document.getElementById('scanner-line-wrapper').classList.remove('hidden');
    videoInterval = setInterval(() => {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const code = jsQR(context.getImageData(0, 0, canvas.width, canvas.height).data, canvas.width, canvas.height);
            if (code) { stopCamera(); handleScanSuccess(code.data); }
        }
    }, 100);
  } catch (err) { placeholder.innerText = 'L·ªói truy c·∫≠p camera.'; }
}

function stopCamera() {
  if (videoInterval) clearInterval(videoInterval);
  if (currentStream) currentStream.getTracks().forEach(t => t.stop());
  currentStream = null;
  document.getElementById('camera-preview').style.display = 'none';
  document.getElementById('stop-button').style.display = 'none';
  document.getElementById('initial-mock-gate').style.display = 'none';
  document.getElementById('scanner-line-wrapper').classList.add('hidden');
  document.getElementById('camera-placeholder').style.display = 'flex';
}

function updateMockButtons(id) {
    document.getElementById('mock-scan-1').style.display = id === 'artifact_123' ? 'none' : 'block';
    document.getElementById('mock-scan-2').style.display = id === 'artifact_456' ? 'none' : 'block';
}

function mockScanArtifact1() { processMockScan(mockArtifactData); }
function mockScanArtifact2() { processMockScan(mockArtifactData2); }

function processMockScan(data) {
    if (!visitedArtifacts.find(a => a.id === data.id)) visitedArtifacts.push({ id: data.id, name: data.name });
    currentArtifactData = data;
    handleScanSuccess(JSON.stringify(data));
}

function handleScanSuccess(json) {
  try {
      const data = JSON.parse(json);
      currentArtifactData = data;
      
      exitSubView();
      stopCamera(); 
      
      document.getElementById('data-title').innerText = `Hi·ªán v·∫≠t: ${data.name}`;
      document.getElementById('scanned-details').innerHTML = `<p>V·ªã tr√≠: T·∫ßng ${data.floor} - ${data.pos}</p>`;
      document.getElementById('youtube-button').style.display = data.youtubeUrl ? 'inline-block' : 'none';
      document.getElementById('view360-button').style.display = 'inline-block';
      document.getElementById('start-quiz-button-qr').style.display = getQuizForArtifact(data.id) ? 'inline-block' : 'none';
      document.getElementById('qr-result').style.display = 'flex';
      
      document.getElementById('mock-artifact-buttons').style.display = 'block';
      updateMockButtons(data.id);
  } catch(e) { console.log("QR kh√¥ng h·ª£p l·ªá"); }
}

function playVideoPresentation() { 
    if(currentArtifactData?.youtubeUrl) {
        window.open(currentArtifactData.youtubeUrl, '_blank');
    }
}

function view360() { 
    document.getElementById('data-title').style.display = 'none';
    document.getElementById('scanned-details').style.display = 'none';
    document.getElementById('interaction-buttons').style.display = 'none';
    document.getElementById('start-quiz-button-qr').style.display = 'none';
    document.getElementById('mock-artifact-buttons').style.display = 'none'; 

    const d = document.getElementById('artifact-360-display');
    d.style.display = 'block';
    
    const model = currentArtifactData?.id === 'artifact_456' ? 'Earth.glb' : 'Astronaut.glb';
    
    d.innerHTML = `
        <div style="position: absolute; top: 15px; left: 15px; z-index: 50;">
            <button onclick="exitSubView()" style="background: rgba(0,0,0,0.6); color: white; padding: 10px 20px; border-radius: 10px; font-size: 14px; box-shadow: none;">‚¨ÖÔ∏è Quay l·∫°i th√¥ng tin</button>
        </div>
        <model-viewer src="https://modelviewer.dev/shared-assets/models/${model}" auto-rotate camera-controls style="width: 100%; height: 100%;" ar></model-viewer>
    `;
}

function exitSubView() {
    document.getElementById('data-title').style.display = 'block';
    document.getElementById('scanned-details').style.display = 'block';
    document.getElementById('interaction-buttons').style.display = 'flex';
    document.getElementById('artifact-360-display').style.display = 'none';
    
    if (currentArtifactData) {
        document.getElementById('start-quiz-button-qr').style.display = getQuizForArtifact(currentArtifactData.id) ? 'inline-block' : 'none';
        document.getElementById('mock-artifact-buttons').style.display = 'block'; 
    }
}

/* ==========================================================================
   MAP LOGIC
   ========================================================================== */
const floorData = {
    1: { bg: "https://placehold.co/400x300/a2d9ce/000000?text=TANG+1", markers: [{id:'p1', type:'current', top:'70%', left:'50%', title:'B·∫°n'}] },
    2: { bg: "https://placehold.co/400x300/f9e79f/000000?text=TANG+2", markers: [{id:'p2', type:'display', top:'40%', left:'30%', title:'Tr∆∞ng b√†y'}] },
    3: { bg: "https://placehold.co/400x300/d7bde2/000000?text=TANG+3", markers: [{id:'p3', type:'display', top:'30%', left:'50%', title:'Kh√¥ng gian'}] }
};
let activeFilters = { display:true, toilet:true, info:true, current:true };

function toggleFilter(t) { activeFilters[t] = !activeFilters[t]; document.getElementById(`filter-${t}`).classList.toggle('active'); changeFloor(); }

function changeFloor() {
  const f = document.getElementById('floor-select').value;
  const mc = document.getElementById('map-container');
  if(!floorData[f]) return;
  mc.style.backgroundImage = `url(${floorData[f].bg})`;
  mc.querySelectorAll('.map-marker').forEach(e => e.remove());
  floorData[f].markers.forEach(m => {
      if(!activeFilters[m.type]) return;
      const el = document.createElement('div'); el.className = `map-marker marker-${m.type}`;
      el.style.top = m.top; el.style.left = m.left; el.innerText = 'üìç';
      mc.appendChild(el);
  });
}

function findPath() { console.log("ƒêang ch·ªâ ƒë∆∞·ªùng..."); }
function resetMap() { changeFloor(); }

document.addEventListener('DOMContentLoaded', () => { 
    setTimeout(changeFloor, 100); 
    renderProfile(); 
    updateProfileDisplay(); 
});
function selectLang(l) { document.getElementById('lang-display').innerText = l==='vi'?'üåê VI':'üåê EN'; document.getElementById('lang-options').style.display='none'; }
function toggleLangOptions() { const o=document.getElementById('lang-options'); o.style.display=o.style.display==='flex'?'none':'flex'; }
</script>
</body>
</html>
